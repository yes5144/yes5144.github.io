<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>运维工程师进阶之路</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/bookDog.png">
    <meta name="description" content="SRE">
    <link rel="preload" href="/assets/css/0.styles.4391c3e0.css" as="style"><link rel="preload" href="/assets/js/app.44e953ca.js" as="script"><link rel="preload" href="/assets/js/2.ca34a8c3.js" as="script"><link rel="preload" href="/assets/js/73.970101e7.js" as="script"><link rel="prefetch" href="/assets/js/10.26ab6c8b.js"><link rel="prefetch" href="/assets/js/11.66cf7fbe.js"><link rel="prefetch" href="/assets/js/12.053ab66a.js"><link rel="prefetch" href="/assets/js/13.7b69c762.js"><link rel="prefetch" href="/assets/js/14.b7d3725e.js"><link rel="prefetch" href="/assets/js/15.94dc50f9.js"><link rel="prefetch" href="/assets/js/16.7d068506.js"><link rel="prefetch" href="/assets/js/17.72fba0c1.js"><link rel="prefetch" href="/assets/js/18.0b63671e.js"><link rel="prefetch" href="/assets/js/19.fc87afd7.js"><link rel="prefetch" href="/assets/js/20.5e8598a5.js"><link rel="prefetch" href="/assets/js/21.29611eb5.js"><link rel="prefetch" href="/assets/js/22.c4fb6228.js"><link rel="prefetch" href="/assets/js/23.7815e38d.js"><link rel="prefetch" href="/assets/js/24.48bc7051.js"><link rel="prefetch" href="/assets/js/25.ca28f6c6.js"><link rel="prefetch" href="/assets/js/26.98c9036d.js"><link rel="prefetch" href="/assets/js/27.f7966843.js"><link rel="prefetch" href="/assets/js/28.4d1d3d14.js"><link rel="prefetch" href="/assets/js/29.bddf0f39.js"><link rel="prefetch" href="/assets/js/3.85186c36.js"><link rel="prefetch" href="/assets/js/30.f4d58864.js"><link rel="prefetch" href="/assets/js/31.4927c5cc.js"><link rel="prefetch" href="/assets/js/32.c4d98288.js"><link rel="prefetch" href="/assets/js/33.b7cd4cd5.js"><link rel="prefetch" href="/assets/js/34.e6f4b03f.js"><link rel="prefetch" href="/assets/js/35.c018a354.js"><link rel="prefetch" href="/assets/js/36.5b95d2bf.js"><link rel="prefetch" href="/assets/js/37.7bfe07d4.js"><link rel="prefetch" href="/assets/js/38.08c93d93.js"><link rel="prefetch" href="/assets/js/39.4114fd8e.js"><link rel="prefetch" href="/assets/js/4.2222cb25.js"><link rel="prefetch" href="/assets/js/40.880abd0a.js"><link rel="prefetch" href="/assets/js/41.7a84d064.js"><link rel="prefetch" href="/assets/js/42.c3ca3a2a.js"><link rel="prefetch" href="/assets/js/43.b79bec7b.js"><link rel="prefetch" href="/assets/js/44.9f528f2e.js"><link rel="prefetch" href="/assets/js/45.0f9b892c.js"><link rel="prefetch" href="/assets/js/46.007d8c15.js"><link rel="prefetch" href="/assets/js/47.b9d5f5bc.js"><link rel="prefetch" href="/assets/js/48.be1f0cf4.js"><link rel="prefetch" href="/assets/js/49.9284be50.js"><link rel="prefetch" href="/assets/js/5.64c7e03a.js"><link rel="prefetch" href="/assets/js/50.599d0e37.js"><link rel="prefetch" href="/assets/js/51.aa9fd431.js"><link rel="prefetch" href="/assets/js/52.2f9bc07d.js"><link rel="prefetch" href="/assets/js/53.0c9ef961.js"><link rel="prefetch" href="/assets/js/54.97aac4ec.js"><link rel="prefetch" href="/assets/js/55.76f07301.js"><link rel="prefetch" href="/assets/js/56.4d2c0998.js"><link rel="prefetch" href="/assets/js/57.b470773a.js"><link rel="prefetch" href="/assets/js/58.aaf739b3.js"><link rel="prefetch" href="/assets/js/59.69e3d1c3.js"><link rel="prefetch" href="/assets/js/6.9b93828e.js"><link rel="prefetch" href="/assets/js/60.7573cff3.js"><link rel="prefetch" href="/assets/js/61.42a80774.js"><link rel="prefetch" href="/assets/js/62.6808be18.js"><link rel="prefetch" href="/assets/js/63.90f6608a.js"><link rel="prefetch" href="/assets/js/64.e5344119.js"><link rel="prefetch" href="/assets/js/65.b5634369.js"><link rel="prefetch" href="/assets/js/66.21a43d2e.js"><link rel="prefetch" href="/assets/js/67.b72d9aa6.js"><link rel="prefetch" href="/assets/js/68.af2ab069.js"><link rel="prefetch" href="/assets/js/69.4adc43e6.js"><link rel="prefetch" href="/assets/js/7.6de19e8e.js"><link rel="prefetch" href="/assets/js/70.7b35fee5.js"><link rel="prefetch" href="/assets/js/71.532a8351.js"><link rel="prefetch" href="/assets/js/72.46ca51b8.js"><link rel="prefetch" href="/assets/js/74.1c4ec244.js"><link rel="prefetch" href="/assets/js/75.9a27bec1.js"><link rel="prefetch" href="/assets/js/76.d0fa2941.js"><link rel="prefetch" href="/assets/js/77.3fce2b20.js"><link rel="prefetch" href="/assets/js/78.c098f054.js"><link rel="prefetch" href="/assets/js/79.1841299d.js"><link rel="prefetch" href="/assets/js/8.682fa49e.js"><link rel="prefetch" href="/assets/js/80.55af12a4.js"><link rel="prefetch" href="/assets/js/81.901ddf76.js"><link rel="prefetch" href="/assets/js/82.8b9d069b.js"><link rel="prefetch" href="/assets/js/83.9bac6c98.js"><link rel="prefetch" href="/assets/js/84.f50a45a7.js"><link rel="prefetch" href="/assets/js/9.0d17f277.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4391c3e0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/bookDog.png" alt="运维工程师进阶之路" class="logo"> <span class="site-name can-hide">运维工程师进阶之路</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sre/linux/cli.html" class="nav-link">
  功能演示
</a></div><div class="nav-item"><a href="https://github.com/yes5144" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sre/linux/cli.html" class="nav-link">
  功能演示
</a></div><div class="nav-item"><a href="https://github.com/yes5144" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Linux开源基石</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/sre/linux/base_cli.html" class="sidebar-link">基础命令</a></li><li><a href="/sre/linux/system_security.html" class="sidebar-link">系统安全</a></li><li><a href="/sre/linux/iptables.html" class="sidebar-link">iptables防火墙</a></li><li><a href="/sre/linux/regex.html" class="sidebar-link">正则表达式</a></li><li><a href="/sre/linux/tcpdump.html" class="sidebar-link">tcpdump抓包</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx高性能web服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL最好用的关系型数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>gitlab企业代码仓库管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Jenkins持续集成部署</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis多功能nosql数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Saltstack批量管理工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zabbix开源监控系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Prometheus下一代监控系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ELK日志分析平台</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python优雅的编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker轻量虚拟化技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>k8s容器编排利器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>高可用性（避免单点故障）
负载均衡（充分利用服务器性能）
弹性伸缩（易于扩容和缩容）</p></blockquote> <blockquote><p>确立自己原则的“五步原则”</p> <p>1、目标：我要什么？
2、计划：我该怎么做？
3、行动：我碰到了什么问题？
4、反思：什么原因？
5、改进：形成原则</p></blockquote> <h1 id="一、linux"><a href="#一、linux" class="header-anchor">#</a> 一、Linux</h1> <h2 id="_1-1-hello-world"><a href="#_1-1-hello-world" class="header-anchor">#</a> 1.1 Hello World</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token string">'hello world'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'hello shell'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_1-2-常用命令组合"><a href="#_1-2-常用命令组合" class="header-anchor">#</a> 1.2 常用命令组合</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">find</span> <span class="token builtin class-name">.</span> -name <span class="token string">'*.log'</span> -mtime +7 -type f 

<span class="token function">find</span> <span class="token builtin class-name">.</span> -maxdepth <span class="token number">1</span> -name <span class="token string">'*.old'</span> -type d 
<span class="token function">find</span> <span class="token builtin class-name">.</span> -maxdepth <span class="token number">3</span> -name <span class="token string">'*.old'</span> -type d <span class="token operator">|</span><span class="token function">xargs</span> <span class="token builtin class-name">echo</span>

<span class="token assign-left variable">Now_Time</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>date +%Y%m%d%H%M%S<span class="token punctuation">)</span><span class="token variable">`</span></span>
<span class="token assign-left variable">NowStamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>date +%s<span class="token punctuation">)</span><span class="token variable">`</span></span>

<span class="token function">sed</span>  -i.bak  <span class="token string">'/swap/s/^\(.*\)$/#<span class="token entity" title="\1">\1</span>/g'</span> /etc/fstab
<span class="token comment">## (1.0.21.62.)(20200916114736) 分组替换</span>
<span class="token function">sed</span> -i <span class="token string">&quot;s/\(\([0-9]\{1,\}\.\)\{3,\}\)\([0-9]\{1,\}\)/<span class="token entity" title="\1">\1</span><span class="token variable">${Now_Time}</span>/g&quot;</span> /opt/www/index*.html
<span class="token function">sed</span> <span class="token string">':a;N;<span class="token variable">$!</span>ba;s/nz_shouq_accountdb/nz_shouq_main/2'</span>  <span class="token comment">## 末尾2表示只替换第二个</span>
<span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> redis<span class="token operator">|</span><span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span><span class="token function">awk</span> -F: <span class="token string">'{print <span class="token variable">$NF</span>}'</span>


<span class="token comment">## 打印第10列等于403的行</span>
<span class="token function">awk</span> <span class="token string">'<span class="token variable">$10</span>==403 {print <span class="token variable">$0</span>}'</span>   /opt/log/nginx/www.xxx.com.log
<span class="token function">awk</span> <span class="token string">'{a[<span class="token variable">$1</span>]++}END{for(v in a)print v,a[v]}'</span> access.log
<span class="token comment"># https://www.cnblogs.com/linuxprobe/p/11387906.html</span>


<span class="token comment">## grep -r 递归； -I 排除二进制文件； -n 行号； -H 文件名； --exclude 排除匹配文件； --exclude-dir 排除匹配目录</span>
<span class="token function">grep</span> -rInH --exclude<span class="token operator">=</span>*.log --exclude-dir<span class="token operator">=</span>py3*  <span class="token string">'\/opt\/'</span> *
<span class="token function">grep</span> <span class="token string">'skill  Id : 999'</span> error.log* -C10 <span class="token operator">|</span> <span class="token function">more</span>


tcpdump -i eth0 -s <span class="token number">0</span> -l -w - -w aa.pcap


<span class="token function">netstat</span> -n <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/^tcp/ {++S[<span class="token variable">$NF</span>]} END {for(a in S) print a, S[a]}'</span>
<span class="token function">netstat</span> -anpo<span class="token operator">|</span><span class="token function">more</span>
<span class="token function">netstat</span> -anpo<span class="token operator">|</span><span class="token function">grep</span> ESTABLISHED<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{<span class="token variable">$3</span>!=0}{print <span class="token variable">$0</span>}'</span>
<span class="token function">netstat</span> -anpo<span class="token operator">|</span><span class="token function">grep</span> ESTABLISHED<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'<span class="token variable">$3</span>!=0{print <span class="token variable">$0</span>}'</span>

<span class="token function">cat</span> /proc/<span class="token variable"><span class="token variable">`</span>pidof mysqld<span class="token variable">`</span></span>/limits

<span class="token function">sudo</span> <span class="token function">du</span> -s * <span class="token operator">|</span> <span class="token function">sort</span> -nr <span class="token operator">|</span> <span class="token function">head</span>      <span class="token comment"># 显示前10个占用空间最大的文件或目录</span>
<span class="token function">sudo</span> <span class="token function">du</span> --max-depth<span class="token operator">=</span><span class="token number">1</span>               <span class="token comment"># linux查找占空间最大的文件与目录  </span>
<span class="token function">sudo</span> <span class="token function">find</span> ./ -size -2048c -type f   <span class="token comment"># 查找小于2K的文件，- 表示小于</span>

<span class="token comment">## </span>

pidstat -u -p  pidnum <span class="token number">3</span>  <span class="token comment">## 某pid 3秒内CPU使用情况</span>

-u -r 内存  -d 磁盘

iostat  -d  <span class="token number">2</span> <span class="token number">3</span>

<span class="token comment">## ip 按照数字排序</span>
<span class="token function">sort</span> -t<span class="token string">'.'</span> -k1,1n  -k2,2n  -k3,3n  -k4,4n  ip.txt
<span class="token function">sort</span> -t<span class="token string">'.'</span> -k1,1rn -k2,2rn -k3,3rn -k4,4rn ip.txt


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h2 id="_1-3-系统安全和优化"><a href="#_1-3-系统安全和优化" class="header-anchor">#</a> 1.3 系统安全和优化</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment">## 1 close selinux</span>
setenforce <span class="token number">0</span>
<span class="token function">sed</span> -i /SELINUX/s/enforcing/disabled/g /etc/selinux/config

<span class="token comment">## 2 close iptables firewalld</span>
systemctl stop iptables.service  <span class="token operator">&amp;&amp;</span> systemctl disable  iptables.service
systemctl stop firewalld.service <span class="token operator">&amp;&amp;</span> systemctl disable firewalld.service

<span class="token comment">## 3 中文支持</span>
<span class="token function">cat</span>  /etc/sysconfig/i18n
<span class="token builtin class-name">echo</span>  <span class="token string">'LANG=&quot;zh_CN.UTF-8&quot;'</span>   <span class="token operator">&gt;</span> /etc/sysconfig/i18n
<span class="token builtin class-name">echo</span>  <span class="token string">'LC_ALL=&quot;zh_CN.UTF-8&quot;'</span> <span class="token operator">&gt;&gt;</span> /etc/sysconfig/i18n
<span class="token builtin class-name">source</span>  /etc/sysconfig/i18n

 <span class="token comment">#######</span>
<span class="token function">cat</span>   /etc/locale.conf
<span class="token builtin class-name">echo</span>  <span class="token string">'LANG=&quot;zh_CN.UTF-8&quot;'</span> <span class="token operator">&gt;</span> /etc/locale.conf
<span class="token builtin class-name">source</span> /etc/locale.conf

 <span class="token comment">#### 设置timezone的时区</span>
 <span class="token comment">##sudo timedatectl set-timezone 'Asia/Shanghai'</span>
 <span class="token comment">## 或者</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Asia/Shanghai&quot;</span> <span class="token operator">&gt;</span> /etc/timezone

<span class="token comment">## 4 设置时间</span>
<span class="token function">rm</span> -rf /etc/localtime
<span class="token function">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

<span class="token comment">## 5 sync time</span>
ntpdate times.aliyun.com
<span class="token builtin class-name">echo</span> <span class="token string">'# time sync to aliyun 2017-08-21'</span> <span class="token operator">&gt;&gt;</span> /var/spool/cron/root
<span class="token builtin class-name">echo</span> <span class="token string">'*/5 * * * * /usr/sbin/ntpdate times.aliyun.com &gt;/dev/null 2&gt;&amp;1'</span> <span class="token operator">&gt;&gt;</span>/var/spool/cron/root

<span class="token comment">## 6 base.repo epel.repo docker.repo</span>
yum <span class="token function">install</span> -y sysstat tree net-tools <span class="token function">wget</span> <span class="token function">curl</span> <span class="token function">vim</span> lrzsz <span class="token function">zip</span> <span class="token function">unzip</span> python-pip python-devel python36 python36-devel python36-pip bash-completion

<span class="token function">mkdir</span>  /etc/yum.repos.d/default
<span class="token function">mv</span> /etc/yum.repos.d/*.repo /etc/yum.repos.d/default/

<span class="token function">curl</span> -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
<span class="token function">wget</span> -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="token comment">## 7 添加 www mysql (no home)</span>
<span class="token function">useradd</span> myadmin <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">'yourpasswd123#@!'</span> <span class="token operator">|</span><span class="token function">passwd</span> myadmin --stdin
<span class="token function">useradd</span> www -M -s /sbin/nologin 
<span class="token function">useradd</span> mysql -M -s /sbin/nologin

<span class="token comment">## 8 sshd 配置优化</span>
<span class="token punctuation">\</span>cp /etc/ssh/sshd_config<span class="token punctuation">{</span>,.bak<span class="token punctuation">}</span>
<span class="token function">sed</span> -i <span class="token string">'s@#UseDNS yes@UseDNS no@g;s@^GSSAPIAuthentication yes@GSSAPIAuthentication no@g'</span> /etc/ssh/sshd_config
<span class="token comment">### 禁用root远程，添加myadmin sudoers</span>
<span class="token comment">#sed -i 's@#PermitRootLogin yes@PermitRootLogin no@g' /etc/ssh/sshd_config</span>
<span class="token comment">#sed -i 's@#Port 22@Port 52222@g' /etc/ssh/sshd_config</span>
/etc/init.d/sshd reload

<span class="token comment">## 9 系统参数优化</span>
　　<span class="token comment">#1. 计算 fdmax = 物理内存大小(m为单位) / 4 * 256  假设内存为8G,fdmax=524288</span>
　　<span class="token comment">#2. 执行命令: echo fs.file-max=524288 &gt;&gt; /etc/sysctl.conf</span>
　　<span class="token comment">#3. 执行命令: sysctl -p </span>
　　<span class="token comment">#4. 执行命令: echo  * soft nofile  524286 &gt;&gt; /etc/security/limits.conf</span>
　　<span class="token comment">#5. 执行命令: echo  * hard nofile 524287 &gt;&gt; /etc/security/limits.conf</span>
<span class="token builtin class-name">echo</span> fs.file-max<span class="token operator">=</span><span class="token number">524288</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
sysctl -p 

<span class="token builtin class-name">echo</span>  <span class="token string">'* soft nofile  524286'</span> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf
<span class="token builtin class-name">echo</span>  <span class="token string">'* hard nofile  524287'</span> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf

<span class="token comment"># /etc/supervisord.conf</span>
<span class="token comment"># minfds=1048576</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
# https://www.cnblogs.com/kgdxpr/p/3342102.html

# source configuration
# /sbin/sysctl -p
#######禁用ipv6#######
# 禁用整个系统所有接口的IPv6
net.ipv6.conf.all.disable_ipv6 = 1
# 禁用某一个指定接口的IPv6(例如：eth0, lo)
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv6.conf.eth0.disable_ipv6 = 1

#######################
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.ip_local_port_range = 1024 65000
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_max_syn_backlog = 65536
net.core.netdev_max_backlog =  32768
net.core.somaxconn = 32768
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_mem = 94500000 915000000 927000000
net.ipv4.tcp_max_orphans = 3276800

kernel.sysrq = 0
kernel.core_uses_pid = 1
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
vm.swappiness=10
EOF</span>

sysctl -p 

<span class="token comment">## 10 安全问题  把暴力登录的ip 追加到/etc/hosts.deny</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span>/bin/ssh_scan.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#! /bin/bash
cat /var/log/secure|awk '/Failed/{print <span class="token variable"><span class="token variable">$(</span>NF-3<span class="token variable">)</span></span>}'|sort|uniq -c|awk '{print <span class="token variable">$2</span>&quot;=&quot;<span class="token variable">$1</span>;}' &gt; /tmp/black.txt
DEFINE=&quot;10&quot;
for i in <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span>  /tmp/black.txt<span class="token variable">`</span></span>
do
    IP=<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $i <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token operator">=</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span><span class="token variable">`</span></span>
    NUM=<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $i<span class="token operator">|</span><span class="token function">awk</span> -F<span class="token operator">=</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span><span class="token variable">`</span></span>
    if [ <span class="token variable">$NUM</span> -gt <span class="token variable">$DEFINE</span> ];then
         grep <span class="token variable">$IP</span> /etc/hosts.deny &gt; /dev/null
         if [ <span class="token variable">$?</span> -gt 0 ];then
            echo &quot;sshd:<span class="token variable">$IP</span>&quot; &gt;&gt; /etc/hosts.deny
         fi
    fi
done
EOF</span>
<span class="token comment">## 加入定时任务</span>
<span class="token builtin class-name">echo</span> <span class="token string">'####SSH_Failed_Access_Scan####'</span> <span class="token operator">&gt;&gt;</span>/etc/crontab
<span class="token builtin class-name">echo</span> <span class="token string">'*/1 * * * * root sh /bin/ssh_scan.sh'</span> <span class="token operator">&gt;&gt;</span> /etc/crontab

<span class="token comment">## 11 重要文件加锁，禁止修改如 /etc/passwd /etc/shadow /etc/sudoers /root/.ssh/authorized_keys</span>
chattr +i  /etc/passwd /etc/group /etc/shadow /etc/sudoers /root/.ssh/authorized_keys
<span class="token comment"># lsattr </span>
<span class="token comment"># chattr -i file</span>
<span class="token comment"># chattr -R +i dir</span>

<span class="token comment">## 12 预留端口需要吗？</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;39003-39004&quot;</span>  <span class="token operator">&gt;</span> /proc/sys/net/ipv4/ip_local_reserved_ports
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br></div></div><h3 id="_1-3-1-防火墙iptables"><a href="#_1-3-1-防火墙iptables" class="header-anchor">#</a> 1.3.1 防火墙iptables</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">cat</span> <span class="token operator">&gt;</span>/bin/iptables.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/bin/bash
iptables -F
iptables -t nat -F

#### Below are the basal iptables config, normally need not be modified #######
iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT -p udp --source-port 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 62222 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

##### Below are the Appalication related iptables config #######
iptables -A INPUT -s 10.0.5.0/24 -j ACCEPT

iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

iptables -A INPUT -j DROP
iptables -A FORWARD -j DROP
EOF</span>

systemctl <span class="token builtin class-name">enable</span> iptables.service
systemctl restart iptables.service
<span class="token function">sh</span>  /bin/iptables.sh

<span class="token builtin class-name">echo</span> <span class="token string">'sh /bin/iptables.sh'</span> <span class="token operator">&gt;&gt;</span> /etc/rc.local


<span class="token comment">####</span>
<span class="token comment">## iptables防火墙</span>

iptables最常用的规则示例
https://www.cnblogs.com/EasonJim/p/8339162.html

<span class="token comment">### 1、删除已有规则</span>
iptables -F
iptables –flush

<span class="token comment">### 2、设置链的默认策略</span>
iptables -P INPUT DROP
iptables -P FORWARD DROP
<span class="token comment">##### iptables -P OUTPUT DROP ## 一般不对出站的数据包做限制</span>


<span class="token comment">### 3、丢弃来自IP地址x.x.x.x的包</span>
iptables -A INPUT -s x.x.x.x -j DROP

<span class="token comment">#### 3.1、阻止来自IP地址x.x.x.x eth0 tcp的包</span>
iptables -A INPUT -i eth0 -s x.x.x.x -j DROP
iptables -A INPUT -i eth0 -p tcp -s x.x.x.x -j DROP

<span class="token comment">### 4、允许所有来自外部的SSH连接请求，即只允许进入eth0接口，并且目标端口为22的数据包</span>
iptables -A INPUT -i eth0 -p tcp --dport <span class="token number">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">22</span> -m state --state ESTABLISHED -j ACCEPT

<span class="token comment">### 5、仅允许来自于192.168.100.0/24域的用户的ssh连接请求</span>
iptables -A INPUT -i eth0 -p tcp -s <span class="token number">192.168</span>.100.0/24 --dport <span class="token number">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">22</span> -m state --state ESTABLISHED -j ACCEPT

<span class="token comment">### 6、允许所有来自web - http的连接请求</span>
iptables -A INPUT -i eth0 -p tcp --dport <span class="token number">80</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">80</span> -m state --state ESTABLISHED -j ACCEPT

iptables -A INPUT -i eth0 -p tcp --dport <span class="token number">443</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">443</span> -m state --state ESTABLISHED -j ACCEPT

<span class="token comment">### 7、使用multiport 将多个规则结合在一起（允许所有ssh,http,https的流量访问）</span>
iptables -A INPUT -i eth0 -p tcp -m multiport --dports <span class="token number">22,80</span>,443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp -m multiport --sports <span class="token number">22,80</span>,443 -m state --state ESTABLISHED -j ACCEPT

<span class="token comment">### 8、负载平衡传入的网络流量</span>
iptables -A PREROUTING -i eth0 -p tcp --dport <span class="token number">443</span> -m state --state NEW -m nth --counter <span class="token number">0</span> --every <span class="token number">3</span> --packet <span class="token number">0</span> -j DNAT --to-destination <span class="token number">192.168</span>.1.101:443
iptables -A PREROUTING -i eth0 -p tcp --dport <span class="token number">443</span> -m state --state NEW -m nth --counter <span class="token number">0</span> --every <span class="token number">3</span> --packet <span class="token number">1</span> -j DNAT --to-destination <span class="token number">192.168</span>.1.102:443
iptables -A PREROUTING -i eth0 -p tcp --dport <span class="token number">443</span> -m state --state NEW -m nth --counter <span class="token number">0</span> --every <span class="token number">3</span> --packet <span class="token number">2</span> -j DNAT --to-destination <span class="token number">192.168</span>.1.103:443


<span class="token comment">### 9、允许外部主机ping内部主机</span>
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT

<span class="token comment">### 10、允许来自网络192.168.101.0/24的rsync连接请求</span>
iptables -A INPUT -i eth0 -p tcp -s <span class="token number">192.168</span>.101.0/24 --dport <span class="token number">873</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">873</span> -m state --state ESTABLISHED -j ACCEPT

<span class="token comment">### 11、MySQL数据库与web服务跑在同一台服务器上。有时候我们仅希望DBA和开发人员从内部网络（192.168.100.0/24）直接登录数据库，可尝试以下命令：</span>
iptables -A INPUT -i eth0 -p tcp -s <span class="token number">192.168</span>.100.0/24 --dport <span class="token number">3306</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">3306</span> -m state --state ESTABLISHED -j ACCEPT

<span class="token comment">### 12、将来自422端口的流量全部转到22端口。  这意味着我们既能通过422端口又能通过22端口进行ssh连接。启用DNAT转发。</span>

<span class="token comment">##### 系统开启转发功能</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -p tcp -d <span class="token number">192.168</span>.102.37 --dport <span class="token number">422</span> -j DNAT --to <span class="token number">192.168</span>.102.37:22

<span class="token comment">#####除此之外，还需要允许连接到422端口的请求 </span>
iptables -A INPUT -i eth0 -p tcp --dport <span class="token number">422</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport <span class="token number">422</span> -m state --state ESTABLISHED -j ACCEPT



iptables 四表五链
https://www.cnblogs.com/zhujingzhi/p/9706664.html

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><h3 id="_1-3-2-防火墙firewired"><a href="#_1-3-2-防火墙firewired" class="header-anchor">#</a> 1.3.2 防火墙firewired</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>firewall-cmd --list-all
firewall-cmd --add-ports<span class="token operator">=</span><span class="token number">9000</span>/tcp --permernent
firewall-cmd --reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_1-3-3-cc-和ddos"><a href="#_1-3-3-cc-和ddos" class="header-anchor">#</a> 1.3.3 cc 和ddos</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment"># date: 2018-04-12</span>
<span class="token comment"># author: channel</span>
<span class="token comment">#</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">$1</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
	<span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token number">50</span>
<span class="token keyword">else</span>
	<span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token keyword">fi</span>

<span class="token comment"># cd where is the shell</span>
<span class="token builtin class-name">cd</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token punctuation">$(</span>dirname <span class="token environment constant">$BASH_SOURCE</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>

<span class="token keyword">function</span> <span class="token function-name function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token assign-left variable">iplist</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> -an <span class="token operator">|</span><span class="token function">grep</span> ^tcp.*.80<span class="token operator">|</span><span class="token function">egrep</span> -v <span class="token string">'LISTEN|127.0.0.1'</span><span class="token operator">|</span><span class="token function">awk</span> -F <span class="token string">&quot;[ ]+|[:]&quot;</span> <span class="token string">'{print <span class="token variable">$4</span>}'</span><span class="token variable">`</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> -z <span class="token variable">$iplist</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">then</span>
		<span class="token operator">&gt;</span> ./iplist/black_ip.txt
		<span class="token keyword">for</span> <span class="token for-or-select variable">black_ip</span> <span class="token keyword">in</span> <span class="token variable">$iplist</span>
		<span class="token keyword">do</span>
			<span class="token comment"># exclude_ip=`echo $black_ip |awk -F &quot;.&quot; '{print &quot;$1&quot;.&quot;$2&quot;.&quot;$3&quot;}'`</span>
			<span class="token comment"># grep -q $excude_ip ./white_ip.txt</span>
			<span class="token function">grep</span> -q <span class="token variable">$black_ip</span> ./white_ip.txt
			<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
				<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$black_ip</span> (white_ip)&quot;</span> <span class="token operator">&gt;&gt;</span>./black_ip.txt
			<span class="token keyword">else</span>
				<span class="token builtin class-name">echo</span> <span class="token variable">$black_ip</span> <span class="token operator">&gt;&gt;</span> ./black_ip.txt
				iptables -nL <span class="token operator">|</span><span class="token function">grep</span> <span class="token variable">$black_ip</span> <span class="token operator">||</span> <span class="token punctuation">(</span>iptables -I INPUT -s £<span class="token variable">$black_ip</span> -j DROP <span class="token operator">&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$black_ip</span> exist&quot;</span> <span class="token punctuation">)</span>
			<span class="token keyword">fi</span>
		<span class="token keyword">done</span>
		<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> ./sendmail<span class="token variable">`</span></span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> sendmsg<span class="token punctuation">;</span><span class="token keyword">fi</span>
	<span class="token keyword">fi</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-name function">sendmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token function">netstat</span> -nutlp <span class="token operator">|</span><span class="token function">grep</span> <span class="token string">&quot;sendmail&quot;</span> <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> /etc/init.d/sendmail start <span class="token operator">&gt;</span>/dev/null <span class="token punctuation">;</span>
	<span class="token builtin class-name">echo</span> -e <span class="token string">&quot;From: 1006793841@qq.com<span class="token entity" title="\n">\n</span>To:22222222222@qq.com<span class="token entity" title="\n">\n</span>Subject:Someone Attacking you system&quot;</span>
	<span class="token function">cat</span> ./black_ip.txt <span class="token operator">&gt;&gt;</span>./message
	/usr/sbin/sendmail -f sendaddr@qq.com -t recieve_add@qq.com -i <span class="token operator">&lt;</span>./message
	<span class="token operator">&gt;</span>./sendmail

<span class="token punctuation">}</span>


<span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token keyword">do</span>
	check
	<span class="token function">sleep</span> <span class="token number">10</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment"># date: 2018-4-11</span>
<span class="token comment"># author: channel</span>
<span class="token comment">#</span>
<span class="token assign-left variable">FilePath</span><span class="token operator">=</span><span class="token string">&quot;access.log&quot;</span>
<span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span> <span class="token variable">$FilePath</span> <span class="token operator">|</span><span class="token function">sort</span> -rn <span class="token operator">|</span><span class="token function">uniq</span> -c <span class="token operator">&gt;</span>ip_count.log
<span class="token function">cat</span> ip_count.log <span class="token operator">|</span><span class="token keyword">while</span> <span class="token builtin class-name">read</span> text
<span class="token keyword">do</span>
	<span class="token builtin class-name">echo</span> <span class="token variable">$text</span>
	<span class="token assign-left variable">count</span><span class="token operator">=</span> <span class="token builtin class-name">echo</span> <span class="token variable">$text</span> <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span>
	<span class="token assign-left variable">ip</span><span class="token operator">=</span> <span class="token builtin class-name">echo</span> <span class="token variable">$test</span> <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$count</span> -gt <span class="token number">20</span> <span class="token punctuation">]</span>
	<span class="token keyword">then</span>
		<span class="token keyword">if</span> iptables -L <span class="token operator">|</span><span class="token function">grep</span> <span class="token variable">$ip</span>
		<span class="token keyword">then</span>
			<span class="token builtin class-name">echo</span> <span class="token string">&quot;ip address exists iptables, no add again&quot;</span>
		<span class="token keyword">else</span>
			<span class="token builtin class-name">echo</span> <span class="token string">&quot;add <span class="token variable">$ip</span> address in iptables&quot;</span>
			iptables -A INPUT -s <span class="token variable">$ip</span> -j DROP <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$ip</span> <span class="token operator">&gt;&gt;</span> ip_drop.log
			/etc/init.d/iptables save <span class="token operator">&amp;&gt;</span> /dev/null
			/etc/init.d/iptables restart <span class="token operator">&amp;&gt;</span>/dev/null
		<span class="token keyword">fi</span>
	<span class="token keyword">else</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;no ip will be add iptables&quot;</span>
	<span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token comment"># remember to create a crontab task for this shell</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h1 id="二、nginx"><a href="#二、nginx" class="header-anchor">#</a> 二、Nginx</h1> <h2 id="_2-22-配置"><a href="#_2-22-配置" class="header-anchor">#</a> 2.22 配置</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
<span class="token comment">####### 负载均衡配置：</span>
upstream myapp {
    server 192.168.0.111:8080; # 应用服务器1
    server 192.168.0.112:8080; # 应用服务器2
}
server {
    listen 80;
    location / {
        proxy_pass http://myweb;
    }
}

<span class="token comment">###### 反向代理</span>
server {
    listen 80;
    location / {
        proxy_pass http://192.168.0.112:8080; # 应用服务器HTTP地址
    }
}

<span class="token comment">###### 虚拟主机</span>
server {
    listen 80 default_server;
    server_name _;
    return 444; # 过滤其他域名的请求，返回444状态码
}
server {
    listen 80;
    server_name www.aaa.com; # www.aaa.com域名
    location / {
        proxy_pass http://localhost:8080; # 对应端口号8080
    }
}
server {
    listen 80;
    server_name www.bbb.com; # www.bbb.com域名
    location / {
        proxy_pass http://localhost:8081; # 对应端口号8081
    }
}

<span class="token comment">##### 另外，server_name配置还可以过滤有人恶意将某些域名指向你的主机服务器。</span>

<span class="token comment">#### FastCGI</span>
<span class="token comment">#### Nginx本身不支持PHP等语言，但是它可以通过FastCGI来将请求扔给某些语言或框架处理（例如PHP、Python、Perl）。</span>
server {
    listen 80;
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /PHP文件路径$fastcgi_script_name; # PHP文件路径
        fastcgi_pass 127.0.0.1:9000; # PHP-FPM地址和端口号
<span class="token comment">        # 另一种方式：fastcgi_pass unix:/var/run/php5-fpm.sock;</span>
    }
}

<span class="token comment">## rewirte</span>
server {
        listen 80;
        server_name monitor.xxxx.com;
        rewrite ^(.*)$ https://${server_name}$1 permanent;
}

server {
        server_name monitor.xxxx.com ;
        listen 443 ssl;
        ssl_certificate  /usr/local/nginx/conf/888__xxxx.com.pem;
        ssl_certificate_key  /usr/local/nginx/conf/888__xxxx.com.key;
        index  index.html index.htm;
        root  /opt/www/xxxx_web/dist;

        location ~ .*\.(jpg|png|jpeg)$ {
            expires      30d;
        }

        location / {
            try_files $uri $uri/ /index.html;
            expires      7d;
        }

        access_log  /opt/log/nginx/monitor.xxxx.com.log;
}

<span class="token comment">## 防盗链 在nginx的conf中配置</span>
location ~.*\.(gif|jpg|png|flv|swf|rar|zip)$
{
    valid_referers none blocked zi.com *.zi.com;
    if($invalid_referer)
    {
<span class="token comment">        #return 403;</span>
        rewrite ^/ http://www.zi.com/403.jpg;
    }    
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><h2 id="_2-3-vhost"><a href="#_2-3-vhost" class="header-anchor">#</a> 2.3 vhost</h2> <h2 id="_2-4-动态负载均衡"><a href="#_2-4-动态负载均衡" class="header-anchor">#</a> 2.4 动态负载均衡</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_2-5-http-登录验证"><a href="#_2-5-http-登录验证" class="header-anchor">#</a> 2.5 http 登录验证</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment"># https://www.cnblogs.com/clsn/p/9950892.html</span>
<span class="token selector">[root@clsn nginx]</span># yum install httpd-tools -y
<span class="token selector">[root@clsn nginx]</span># htpasswd  -c /usr/local/awstats/wwwroot/nmtui.passwd nmtui
New password:
Re-type new password:
Adding password for user nmtui
<span class="token selector">[root@clsn nginx]</span># chown www.www  /usr/local/awstats/wwwroot/nmtui.passwd
<span class="token selector">[root@clsn nginx]</span># chmod 600  /usr/local/awstats/wwwroot/nmtui.passwd

<span class="token selector">[root@clsn nginx]</span># vim  awstats.nmtui.com.conf
server
{
    listen 80;
    server_name awstats.nmtui.com;
    index awstats.nmtui.com.html;
    root /www/wwwroot/awstats/;
    auth_basic &quot;clsn training&quot;;
    auth_basic_user_file /usr/local/awstats/wwwroot/nmtui.passwd;
    access_log  /www/wwwlogs/301-clsn.io.log;
    error_log  /www/wwwlogs/301-clsn.io-error.log;
}
<span class="token selector">[root@clsn nginx]</span># /etc/init.d/nginx  reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="_2-9-nginx-调优"><a href="#_2-9-nginx-调优" class="header-anchor">#</a> 2.9 nginx 调优</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>Nginx调优
https://www.cnblogs.com/zhichaoma/p/7989655.html
    1.隐藏 Nginx 版本号
    2.隐藏 Nginx 版本号和软件名
    3.更改 Nginx 服务的默认用户
    4.优化 Nginx worker 进程数
    5.绑定 Nginx 进程到不同的 CPU 上
    6.优化 Nginx 处理事件模型
    7.优化 Nginx 单个进程允许的最大连接数
    8.优化 Nginx worker 进程最大打开文件数
    9.优化服务器域名的散列表大小
    10.开启高效文件传输模式
    11.优化 Nginx 连接超时时间
    12.限制上传文件的大小
    13.FastCGI 相关参数调优
    14.配置 Nginx gzip 压缩
    15.配置 Nginx expires 缓存
    16.优化 Nginx日志(日志切割)
    17.优化 Nginx 站点目录
    18.配置 Nginx 防盗链
    19.配置 Nginx 错误页面优雅显示
    20.优化 Nginx 文件权限
    21.Nginx 防爬虫优化
    22.控制 Nginx 并发连接数
    23.集群代理优化

Nginx 性能调优
https://www.jianshu.com/p/024b33d1a1a1

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h1 id="三、mysql"><a href="#三、mysql" class="header-anchor">#</a> 三、MySQL</h1> <h2 id="_3-1-基础操作命令"><a href="#_3-1-基础操作命令" class="header-anchor">#</a> 3.1 基础操作命令</h2> <h3 id="_3-1-1-添加索引"><a href="#_3-1-1-添加索引" class="header-anchor">#</a> 3.1.1 添加索引</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">## 1.添加PRIMARY KEY（主键索引） </span>
mysql<span class="token operator">&gt;</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>table_name<span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span><span class="token keyword">column</span><span class="token punctuation">`</span> <span class="token punctuation">)</span> 
<span class="token comment">## 2.添加UNIQUE(唯一索引) </span>
mysql<span class="token operator">&gt;</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>table_name<span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span><span class="token keyword">column</span><span class="token punctuation">`</span> <span class="token punctuation">)</span> 
<span class="token comment">## 3.添加INDEX(普通索引) </span>
mysql<span class="token operator">&gt;</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>table_name<span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> index_name <span class="token punctuation">(</span> <span class="token punctuation">`</span><span class="token keyword">column</span><span class="token punctuation">`</span> <span class="token punctuation">)</span> 
<span class="token comment">## 4.添加FULLTEXT(全文索引) </span>
mysql<span class="token operator">&gt;</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>table_name<span class="token punctuation">`</span> <span class="token keyword">ADD</span> FULLTEXT <span class="token punctuation">(</span> <span class="token punctuation">`</span><span class="token keyword">column</span><span class="token punctuation">`</span> <span class="token punctuation">)</span> 
<span class="token comment">## 5.添加多列索引 </span>
mysql<span class="token operator">&gt;</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>table_name<span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> index_name <span class="token punctuation">(</span> <span class="token punctuation">`</span>column1<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>column2<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>column3<span class="token punctuation">`</span> <span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-1-2-复制表到新表"><a href="#_3-1-2-复制表到新表" class="header-anchor">#</a> 3.1.2 复制表到新表</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>方法一：
拷贝表<span class="token number">1</span>的全部数据到表<span class="token number">2</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> table2 <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table1 

拷贝第n条
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> table2 <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table1  <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">5</span>

拷贝指定字段
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> table2 <span class="token punctuation">(</span> name <span class="token punctuation">,</span> price <span class="token punctuation">)</span> <span class="token keyword">SELECT</span> name <span class="token punctuation">,</span> price  <span class="token keyword">FROM</span> table1  <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">5</span>

方法二：
创建表<span class="token number">3</span>， 同时拷贝表<span class="token number">1</span>的数据和结构到表<span class="token number">3</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table3 <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span>

方法三：
创建表<span class="token number">4</span>，只拷贝表<span class="token number">1</span>的结构到表<span class="token number">4</span>，不拷贝数据
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table4 <span class="token operator">LIKE</span> <span class="token keyword">table</span>

版权声明：本文为CSDN博主「一筐大白菜啊」的原创文章，遵循 CC <span class="token number">4.0</span> <span class="token keyword">BY</span><span class="token operator">-</span>SA 版权协议，转载请附上原文出处链接及本声明。
原文链接：https:<span class="token comment">//blog.csdn.net/sphinx1122/article/details/84402854</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_3-1-3-部分配置文件参考"><a href="#_3-1-3-部分配置文件参考" class="header-anchor">#</a> 3.1.3 部分配置文件参考</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token selector">[client]</span>
<span class="token constant">default-character-set</span><span class="token attr-value"><span class="token punctuation">=</span>utf8</span>

<span class="token selector">[mysql]</span>
<span class="token constant">default-character-set</span><span class="token attr-value"><span class="token punctuation">=</span>utf8</span>

<span class="token selector">[mysqld]</span>
<span class="token constant">init_connect</span><span class="token attr-value"><span class="token punctuation">=</span>'SET collation_connection = utf8_unicode_ci'</span>
<span class="token constant">init_connect</span><span class="token attr-value"><span class="token punctuation">=</span>'SET NAMES utf8'</span>
<span class="token constant">character-set-server</span><span class="token attr-value"><span class="token punctuation">=</span>utf8</span>
<span class="token constant">collation-server</span><span class="token attr-value"><span class="token punctuation">=</span>utf8_unicode_ci</span>
skip-character-set-client-handshake

<span class="token comment">#skip-grant-tables</span>
<span class="token comment">### MySQL5.6</span>
<span class="token comment">#UPDATE mysql.user SET Password = password('123456') WHERE User = 'root' ; </span>
<span class="token comment">### MySQL5.7</span>
<span class="token comment">#update mysql.user set authentication_string=password('123qwe') where user='root' and Host = 'localhost';</span>

————————————————
版权声明：本文为CSDN博主「o尐猫o」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/dy_miao/article/details/91461581
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="_3-2-备份和还原"><a href="#_3-2-备份和还原" class="header-anchor">#</a> 3.2 备份和还原</h2> <h3 id="_3-2-1-mysqldump-备份"><a href="#_3-2-1-mysqldump-备份" class="header-anchor">#</a> 3.2.1 mysqldump 备份</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>https://www.cnblogs.com/chenmh/p/5300370.html

<span class="token comment">## 1.该命令会导出包括系统数据库在内的所有数据库</span>
mysqldump -uroot -proot --all-databases <span class="token operator">&gt;</span>/tmp/all.sql

<span class="token comment">## 2.导出db1、db2两个数据库的所有数据</span>
mysqldump -uroot -proot --databases db1 db2 <span class="token operator">&gt;</span>/tmp/user.sql

<span class="token comment">## 3.导出db1中的a1、a2表</span>
mysqldump -uroot -proot --databases db1 --tables a1 a2  <span class="token operator">&gt;</span>/tmp/db1.sql

<span class="token comment">## 4.条件导出，导出db1表a1中id=1的数据</span>
mysqldump -uroot -proot --databases db1 --tables a1    --where<span class="token operator">=</span><span class="token string">'id=1'</span>  <span class="token operator">&gt;</span>/tmp/a1.sql

<span class="token comment">## 5.字段是字符串,并且导出的sql中不包含drop table,create table</span>
mysqldump -uroot -proot --no-create-info --databases db1 --tables a1 --where<span class="token operator">=</span><span class="token string">&quot;id='a'&quot;</span>  <span class="token operator">&gt;</span>/tmp/a1.sql

<span class="token comment">## 6.只导出表结构不导出数据，--no-data</span>
mysqldump -uroot -proot --no-data --databases db1 <span class="token operator">&gt;</span>/tmp/db1.sql

<span class="token comment">### </span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">&quot;/application/mysql/bin:<span class="token environment constant">$PATH</span>&quot;</span>
<span class="token assign-left variable">DBPATH</span><span class="token operator">=</span>/server/backup
<span class="token assign-left variable">MY_USER</span><span class="token operator">=</span>root
<span class="token assign-left variable">MY_PASS</span><span class="token operator">=</span>old123
<span class="token assign-left variable">SOCKET</span><span class="token operator">=</span>/data/3306/mysql.sock
<span class="token assign-left variable">MY_CMD</span><span class="token operator">=</span><span class="token string">&quot;mysql -u<span class="token variable">$MY_USER</span> -p<span class="token variable">$MY_PASS</span> -S <span class="token variable">$SOCKET</span>&quot;</span>
<span class="token assign-left variable">MY_DUMP</span><span class="token operator">=</span><span class="token string">&quot;mysqldump -u<span class="token variable">$MY_USER</span> -p<span class="token variable">$MY_PASS</span> -S<span class="token variable">$SOCKET</span>&quot;</span>

<span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">&quot;<span class="token variable">$DBPATH</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p <span class="token variable">$DBPATH</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">dbname</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span>$MYCMD -e <span class="token string">&quot;show databases;&quot;</span> <span class="token operator">|</span><span class="token function">sed</span> <span class="token string">'1,2d'</span> <span class="token operator">|</span><span class="token function">egrep</span> -v <span class="token string">&quot;mysql|schema&quot;</span><span class="token variable">`</span></span>
<span class="token keyword">do</span>
	<span class="token variable">$MYDUMP</span> <span class="token variable">$dbname</span> <span class="token operator">|</span><span class="token function">gzip</span> <span class="token operator">&gt;</span> <span class="token variable">$DBPATH</span>/<span class="token variable">${dbname}</span>_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>.sql.gz
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="_3-2-2-mysql-还原"><a href="#_3-2-2-mysql-还原" class="header-anchor">#</a> 3.2.2 mysql 还原</h3> <h3 id="_3-2-3-mysqlbinlog-解析binlog"><a href="#_3-2-3-mysqlbinlog-解析binlog" class="header-anchor">#</a> 3.2.3 mysqlbinlog 解析binlog</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#https://www.cnblogs.com/michael9/p/11923483.html</span>

mysqlbinlog -v -v --base64-output<span class="token operator">=</span>DECODE-ROWS --set-charset<span class="token operator">=</span>UTF-8  --start-position<span class="token operator">=</span><span class="token number">309610</span> --stop-position<span class="token operator">=</span><span class="token number">328251</span> mysql-bin.000002 <span class="token operator">&gt;</span> recover.sql
mysqlbinlog -v -v --base64-output<span class="token operator">=</span>DECODE-ROWS --set-charset<span class="token operator">=</span>UTF-8  mysql-bin.000001  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-2-4-binlog2sql-回滚sql"><a href="#_3-2-4-binlog2sql-回滚sql" class="header-anchor">#</a> 3.2.4 binlog2sql 回滚SQL</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>https://github.com/danfengcao/binlog2sql

[mysqld]
server_id = 1
log_bin = /var/log/mysql/mysql-bin.log
max_binlog_size = 1G
binlog_format = row
binlog_row_image = full

######
## 解析标准SQL
python binlog2sql.py -h127.0.0.1 -P3306 -uadmin -p'admin' -dtest -t test3 test4 --start-file='mysql-bin.000002'

## 解析回滚SQL -B, --flashback
python binlog2sql.py -h127.0.0.1 -P3306 -uadmin -p'admin' -dtest -ttest3 --start-file='mysql-bin.000002' --start-position=763 --stop-position=1147 -B

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-2-5-xtrabackup"><a href="#_3-2-5-xtrabackup" class="header-anchor">#</a> 3.2.5 xtrabackup</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># this is a example about xtrabackup</span>
<span class="token comment">#</span>
<span class="token comment"># coding:utf8</span>
<span class="token comment"># 步骤</span>
<span class="token comment"># 全量备份 -&gt; 增量1 -&gt; 增量2 -&gt; </span>

<span class="token comment"># 全量备份00，假设全量文件是/backup_file/00</span>
innobackupex --user<span class="token operator">=</span>root --password<span class="token operator">=</span><span class="token string">'123123'</span> /backup_file/

<span class="token comment"># 增量1, 文件是/backup_file/11</span>
innobackupex --incremental /backup_file --incremental-basedir<span class="token operator">=</span>/backup_file/00

<span class="token comment"># 增量2, 文件是/backup_file/22</span>
innobackupex --incremental /backup_file --incremental-basedir<span class="token operator">=</span>/backup_file/11

<span class="token comment">##################</span>
<span class="token comment"># 整合# </span>
<span class="token comment"># 准备全量00</span>
innobackupex --apply-log --redo-only /backup_file/00

<span class="token comment"># 准备11</span>
innobackupex --apply-log --redo-only /backup_file/00/ --incremental-dir<span class="token operator">=</span>/backup_file/11

<span class="token comment"># 准备22</span>
innobackupex --apply-log --redo-only /backup_file/00/ --incremental-dir<span class="token operator">=</span>/backup_file/22

<span class="token comment">#################</span>
<span class="token comment">#</span>
<span class="token comment"># 恢复数据</span>
innobackupex --copy-back /backup_file/00

<span class="token comment"># 修改属主、属组</span>
<span class="token function">chown</span> -R mysql.mysql /usr/local/mysql/data

<span class="token comment"># 启动mysql</span>
/etc/init.d/mysqld start

<span class="token comment">#### 5，恢复binlog中的部分文件</span>

mysqlbinlog mysql-bin.000002 <span class="token operator">&gt;</span>/tmp/abc.sql
<span class="token comment">#</span>
<span class="token comment"># 暂时关闭binlog记录</span>
mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">source</span> /tmp/abc.sql<span class="token punctuation">;</span>
<span class="token comment">#</span>
<span class="token comment"># 恢复完成，打开binlog记录</span>
mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="_3-3-主从复制"><a href="#_3-3-主从复制" class="header-anchor">#</a> 3.3 主从复制</h2> <h3 id="_3-3-0-主从复制方式"><a href="#_3-3-0-主从复制方式" class="header-anchor">#</a> 3.3.0 主从复制方式</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">##</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_3-3-1-传统binlog"><a href="#_3-3-1-传统binlog" class="header-anchor">#</a> 3.3.1 传统binlog</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">##</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-3-2-基于gtid（建议使用mysql-5-6-5以上版本）"><a href="#_3-3-2-基于gtid（建议使用mysql-5-6-5以上版本）" class="header-anchor">#</a> 3.3.2 基于GTID（建议使用mysql-5.6.5以上版本）</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>MySQL GTID 主从复制的原理及配置 https://blog.51cto.com/yangshufan/2136862

四、GTID的工作原理
1、当一个事务在主库端执行并提交时，产生GTID，一同记录到binlog日志中。

2、binlog传输到slave,并存储到slave的relaylog后，读取这个GTID的这个值设置gtid_next变量，即告诉Slave，下一个要执行的GTID值。

3、sql线程从relay log中获取GTID，然后对比slave端的binlog是否有该GTID。

4、如果有记录，说明该GTID的事务已经执行，slave会忽略。

5、如果没有记录，slave就会执行该GTID事务，并记录该GTID到自身的binlog，   在读取执行事务前会先检查其他session持有该GTID，确保不被重复执行。

6、在解析过程中会判断是否有主键，如果没有就用二级索引，如果没有就用全部扫描。

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_3-9-mysql参数调优"><a href="#_3-9-mysql参数调优" class="header-anchor">#</a> 3.9 MySQL参数调优</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://www.cnblogs.com/zhichaoma/p/7992525.html

 连接相关参数

 文件相关参数

 缓存相关参数 

 MyISAM参数

 InnoDB参数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h1 id="四、django"><a href="#四、django" class="header-anchor">#</a> 四、Django</h1> <h2 id="_4-0-py虚拟环境（virtualenv的使用）"><a href="#_4-0-py虚拟环境（virtualenv的使用）" class="header-anchor">#</a> 4.0 py虚拟环境（virtualenv的使用）</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## centos7安装</span>
yum  <span class="token function">install</span> –y <span class="token function">make</span> gcc-c++ python36-devel python36-pip libxml2-devel libxslt-devel

pip3 <span class="token function">install</span> virtualenv virtualenvwrapper

<span class="token builtin class-name">export</span> <span class="token assign-left variable">WORKON_HOME</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/.virtualenvs
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PROJECT_HOME</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/workspace
<span class="token builtin class-name">source</span> /usr/local/bin/virtualenvwrapper.sh

<span class="token comment">#使用方法：</span>
mkvirtualenv zqxt <span class="token comment">#创建运行环境zqxt</span>

workon zqxt   <span class="token comment">#工作在 zqxt 环境</span>

mkproject -p /usr/bin/python3 py3-pyspider  <span class="token comment">#创建mic项目和运行环境mic</span>

<span class="token comment">## 拓展：</span>
rmvirtualenv ENV <span class="token comment">#删除运行环境ENV</span>
mkproject mic  <span class="token comment">#创建mic项目和运行环境mic</span>
mkproject -p /usr/bin/python3 py3-pyspider  <span class="token comment">#创建mic项目和运行环境mic</span>

mktmpenv   <span class="token comment">#创建临时运行环境</span>
lsvirtualenv  <span class="token comment">#列出可用的运行环境</span>
lssitepackages  <span class="token comment">#列出当前环境安装了的包</span>

<span class="token comment">## 创建的环境是独立的，互不干扰，无需sudo权限即可使用 pip 来进行包的管理。</span>
pip <span class="token function">install</span> --ignore-installed pycurl

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_4-1-django路由"><a href="#_4-1-django路由" class="header-anchor">#</a> 4.1 Django路由</h2> <p>4.1.1 Django哈哈</p> <div class="language-pyhon line-numbers-mode"><pre class="language-text"><code>python manage.py startapp test
python manage.py makemigrations
python manage.py migrate
python manage createsuperuser

2.0后urls文件内的path好像不支持正则了 

需要用正则匹配的 需要

from django.urls import re_path

urlpatterns = [
    re_path('index-(?P&lt;nid&gt;\d)-(?P&lt;uid&gt;\d)', views.index)
}
————————————————
版权声明：本文为CSDN博主「Reisen稻叶」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/u011410397/java/article/details/81780495

be determined to have a great day, and you will

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h1 id="五、saltstack"><a href="#五、saltstack" class="header-anchor">#</a> 五、saltstack</h1> <h2 id="_5-1-使用入门"><a href="#_5-1-使用入门" class="header-anchor">#</a> 5.1 使用入门</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">cat</span> /etc/salt/master <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token string">'#'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v -e <span class="token string">'^$'</span>

/etc/init.d/salt-master restart

salt -L <span class="token string">'HD-HZ-H5PLAT-WEB05'</span> state.sls sysinit

salt -v <span class="token string">'HD-HZ-H5PLAT-WEB05'</span> state.highstate -l debug -t <span class="token number">300</span>

salt-run jobs.lookup_jid <span class="token number">20190426130418644064</span>

https://docs.saltstack.com/en/latest/ref/runners/all/salt.runners.jobs.html
http://dearweb.xin/2017/10/24/salt-file-backup/
<span class="token comment">#################################</span>
salt -d  <span class="token comment">##查看帮助文档</span>
salt -d<span class="token operator">|</span><span class="token function">grep</span> <span class="token function">service</span>  <span class="token comment">##查看service相关模块命令</span>
salt <span class="token string">'*'</span> sys.doc  <span class="token comment">##查看帮助文档</span>
salt-key  -L            <span class="token comment">#查询所有接收到的证书</span>
salt-key  -a <span class="token operator">&lt;</span>证书名<span class="token operator">&gt;</span>   <span class="token comment">#接收单个证书</span>
salt-key  -A            <span class="token comment">#接受所有证书</span>
salt-key  -d <span class="token operator">&lt;</span>证书名<span class="token operator">&gt;</span>   <span class="token comment">#删除单个证书</span>
salt-key  -D            <span class="token comment">#删除所有证书</span>

<span class="token comment">## service</span>
salt <span class="token string">'*'</span> service.get_all  <span class="token comment">##获取主机所有服务</span>
salt <span class="token string">'*'</span> service.reload sshd  <span class="token comment">##重载sshd服务</span>
salt <span class="token string">'node1.com'</span> service.status mysql  <span class="token comment">##查看mysql服务状态</span>
salt <span class="token string">'node1.com'</span> service.start mysql  <span class="token comment">##启动mysql服务</span>
salt <span class="token string">'node1.com'</span> cmd.run <span class="token string">'service mysql status'</span>  <span class="token comment">##与上面一样查看服务</span>
salt <span class="token string">'*'</span> sys.list_modules  <span class="token comment">##模块列表</span>
salt-cp <span class="token string">'*'</span>  /etc/hosts   /etc/hosts  <span class="token comment">##把master上的hosts文件分发到所有主机</span>
salt <span class="token string">'*'</span> cp.get_file salt://ceshi/b /tmp/test  <span class="token comment">##把salt-master端相应的文件，分发文件到minion端</span>
salt <span class="token string">'*'</span> cp.get_dir salt://zabbix /tmp  <span class="token comment">##把salt-master端相应的目录，分发文件到minion端</span>
salt <span class="token string">'*'</span> file.copy /tmp/zabbix.sls /tmp/sls  <span class="token comment">##把salt-master端对应文件拷贝到minion端相应目录下</span>

<span class="token comment">## pkg</span>
salt <span class="token string">'*'</span> pkg.list_pkgs   <span class="token comment">##显示软件包版本列表</span>
salt <span class="token string">'*'</span> pkg.version python  <span class="token comment">##显示软件包版本信息</span>
salt <span class="token string">'*'</span> pkg.install httpd  <span class="token comment">##安装软件包</span>

<span class="token string">'cmd.script:'</span>
        salt <span class="token string">'*'</span> cmd.script salt://scripts/runme.sh
        salt <span class="token string">'*'</span> cmd.script salt://scripts/runme.sh <span class="token string">'arg1 arg2 &quot;arg 3&quot;'</span>
        salt <span class="token string">'*'</span> cmd.script salt://scripts/windows_task.ps1 <span class="token assign-left variable">args</span><span class="token operator">=</span><span class="token string">' -Input c:<span class="token entity" title="\t">\t</span>mp\infile.txt'</span> <span class="token assign-left variable">shell</span><span class="token operator">=</span><span class="token string">'powershell'</span>
        salt <span class="token string">'*'</span> cmd.script salt://scripts/runme.sh <span class="token assign-left variable">stdin</span><span class="token operator">=</span><span class="token string">'one<span class="token entity" title="\n">\n</span>two<span class="token entity" title="\n">\n</span>three<span class="token entity" title="\n">\n</span>four<span class="token entity" title="\n">\n</span>five<span class="token entity" title="\n">\n</span>'</span>
<span class="token string">'cmd.shell:'</span>
        This passes the cmd argument directly to the shell
        salt <span class="token string">'*'</span> cmd.shell <span class="token string">&quot;ls -l | awk '/foo/{print \<span class="token variable">$2</span>}'&quot;</span>
        salt <span class="token string">'*'</span> cmd.shell <span class="token assign-left variable">template</span><span class="token operator">=</span>jinja <span class="token string">&quot;ls -l /tmp/<span class="token variable"><span class="token variable">`</span>grains<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> | awk '/foo/{print \<span class="token variable">$2</span>}'&quot;</span>
        salt <span class="token string">'*'</span> cmd.shell <span class="token string">&quot;Get-ChildItem C:\ &quot;</span> <span class="token assign-left variable">shell</span><span class="token operator">=</span><span class="token string">'powershell'</span>
        salt <span class="token string">'*'</span> cmd.shell <span class="token string">&quot;grep f&quot;</span> <span class="token assign-left variable">stdin</span><span class="token operator">=</span><span class="token string">'one<span class="token entity" title="\n">\n</span>two<span class="token entity" title="\n">\n</span>three<span class="token entity" title="\n">\n</span>four<span class="token entity" title="\n">\n</span>five<span class="token entity" title="\n">\n</span>'</span>
        salt <span class="token string">'*'</span> cmd.shell <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">'sed -e s/=/:/g'</span>
<span class="token string">'cmd.shells:'</span>
        salt <span class="token string">'*'</span> cmd.shells
<span class="token string">'cmd.tty:'</span>
        salt <span class="token string">'*'</span> cmd.tty tty0 <span class="token string">'This is a test'</span>
        salt <span class="token string">'*'</span> cmd.tty pts3 <span class="token string">'This is a test'</span>
<span class="token string">'cmd.which:'</span>
        salt <span class="token string">'*'</span> cmd.which <span class="token function">cat</span>

<span class="token comment">## grains</span>
salt <span class="token string">'*'</span> grains.ls   <span class="token comment">##查看grains分类</span>
salt <span class="token string">'*'</span> grains.items   <span class="token comment">##查看grains所有信息</span>
salt <span class="token string">'*'</span> grains.item osrelease  <span class="token comment">##查看grains某个信息</span>

<span class="token comment">## manage</span>
salt-run manage.up   <span class="token comment">##查看存活的minion</span>
salt-run manage.down  <span class="token comment">##查看死掉的minion</span>
salt-run manage.down <span class="token assign-left variable">removekeys</span><span class="token operator">=</span>True   <span class="token comment">##查看down掉的minion，并将其删除</span>
salt-run manage.status   <span class="token comment">##查看minion的相关状态</span>
salt-run manage.versions   <span class="token comment">##查看slat的所有master和minion的版本信息</span>

<span class="token comment">## jobs</span>
salt-run jobs.active
salt <span class="token punctuation">\</span>* saltutil.running  <span class="token comment">##查看运行的jobs ID</span>
salt <span class="token punctuation">\</span>* saltutil.kill_job <span class="token number">20151209034239907625</span>  <span class="token comment">##kill掉进程ID</span>

<span class="token comment">### saltutil模块中的job管理方法</span>
saltutil.running <span class="token comment">#查看minion当前正在运行的jobs</span>
saltutil.find_job<span class="token operator">&lt;</span>jid<span class="token operator">&gt;</span> <span class="token comment">#查看指定jid的job(minion正在运行的jobs)</span>
saltutil.signal_job<span class="token operator">&lt;</span>jid<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>single<span class="token operator">&gt;</span> <span class="token comment">#给指定的jid进程发送信号</span>
saltutil.term_job <span class="token operator">&lt;</span>jid<span class="token operator">&gt;</span> <span class="token comment">#终止指定的jid进程(信号为15)</span>
saltutil.kill_job <span class="token operator">&lt;</span>jid<span class="token operator">&gt;</span> <span class="token comment">#终止指定的jid进程(信号为9)</span>

<span class="token comment">### salt runner中的job管理方法</span>
salt-run jobs.active <span class="token comment">#查看所有minion当前正在运行的jobs(在所有minions上运?saltutil.running)</span>
salt-run jobs.lookup_jid<span class="token operator">&lt;</span>jid<span class="token operator">&gt;</span> <span class="token comment">#从master jobs cache中查询指定jid的运行结果</span>
salt-run jobs.list_jobs <span class="token comment">#列出当前master jobs cache中的所有job</span>

salt-run jobs.active
salt-run jobs.list_jobs
salt-run jobs.list_job <span class="token number">20190823152131069508</span>
salt-run jobs.lookup_jid <span class="token number">20190823152136187925</span>

https://docs.saltstack.com/en/latest/ref/states/backup_mode.html<span class="token comment">#file-state-backups</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><h2 id="_5-2-salt-api-安装部署"><a href="#_5-2-salt-api-安装部署" class="header-anchor">#</a> 5.2 salt-api 安装部署</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## 生成证书</span>
salt-call --local tls.create_self_signed_cert

<span class="token function">curl</span> -k https://172.10.15.2:55880/login -H <span class="token string">&quot;Accept: application/x-yaml&quot;</span>  -d <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'saltapi222'</span>  -d <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">'saltapi222@##<span class="token variable">$$</span>##'</span>  -d <span class="token assign-left variable">eauth</span><span class="token operator">=</span><span class="token string">'pam'</span>

<span class="token comment">## 链接：https://www.jianshu.com/p/012ccdff93cc</span>

<span class="token function">useradd</span> -M -s /sbin/nologin saltapi222
<span class="token function">passwd</span> saltapi222
saltapi222@<span class="token comment">##$$##</span>

<span class="token comment">###############</span>
openssl 生成加密文件

<span class="token comment">### 222</span>
<span class="token comment"># 1 install</span>
yum <span class="token function">install</span> -y salt-api

<span class="token comment"># 2 adduser</span>
<span class="token function">useradd</span> -M -s /sbin/nologin salt <span class="token builtin class-name">echo</span> <span class="token string">&quot;salt@@123&quot;</span> <span class="token operator">|</span><span class="token function">passwd</span> --stdiin salt

<span class="token comment"># 3 配置证书文件</span>
<span class="token function">mkdir</span> /etc/ssl/private
<span class="token comment">## 生成key</span>
openssl genrsa -out /etc/ssl/private/key.pem <span class="token number">4096</span>
<span class="token comment">## 生成证书</span>
openssl req -new -x509 -key /etc/ssl/private/key.pem -out /etc/ssl/private/cert.pem -days <span class="token number">1826</span>

<span class="token comment">## 为salt-api单独配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/salt/master.d/salt-api.conf<span class="token operator">&lt;&lt;</span><span class="token string">EOF
external_auth:
    pam:
        salt:
            - .*
            - '@whell'
            - '@runner'
            - '@jobs'

rest_cherrypy:
    port: 58080
    host: 0.0.0.0
    ssl_crt: /etc/ssl/private/cert.pem
    ssl_key: /etc/ssl/private/key.pem
    # disable_ssl: True
EOF</span>

<span class="token comment"># 重启master 和salt-api</span>
<span class="token function">service</span> salt-master restart
<span class="token function">service</span> salt-api restart
<span class="token number">4</span> API 测试验证
获取token
<span class="token function">curl</span> -k https://127.0.0.1:8080/login -H <span class="token string">&quot;Accept: application/json&quot;</span> -d <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'salt'</span> -d <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">'salt@@123'</span> -d <span class="token assign-left variable">eauth</span><span class="token operator">=</span><span class="token string">'pam'</span> <span class="token operator">|</span>jq <span class="token builtin class-name">.</span>

<span class="token function">curl</span> -k https://localhost:8080/ -H <span class="token string">&quot;Accept: application/json&quot;</span> -H <span class="token string">&quot;X-Auth-Token: ff3k3k23k2332&quot;</span> -d <span class="token assign-left variable">client</span><span class="token operator">=</span><span class="token string">'local'</span> -d <span class="token assign-left variable">tgt</span><span class="token operator">=</span><span class="token string">'192.168.204.160'</span> -d <span class="token assign-left variable">fun</span><span class="token operator">=</span><span class="token string">&quot;cmd.run&quot;</span> -d <span class="token assign-left variable">arg</span><span class="token operator">=</span><span class="token string">&quot;uname -a&quot;</span> <span class="token operator">|</span>jq <span class="token builtin class-name">.</span>

jq JSON格式化输出
yum <span class="token function">install</span> -y jq 
<span class="token function">cat</span> json_test.txt <span class="token operator">|</span>jq <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="_5-2-1-salt-api-使用"><a href="#_5-2-1-salt-api-使用" class="header-anchor">#</a> 5.2.1 salt-api 使用</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>## https://www.jianshu.com/p/012ccdff93cc

https://www.cnblogs.com/tutuye/p/11590599.html
## salt-api api接口
https://honglimin.cn/saltstack/08_saltapi_doc.html

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_5-3-salt-ssh-批量部署minion"><a href="#_5-3-salt-ssh-批量部署minion" class="header-anchor">#</a> 5.3 salt-ssh 批量部署minion</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>yum <span class="token function">install</span> salt-ssh


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_5-8-ansible"><a href="#_5-8-ansible" class="header-anchor">#</a> 5.8 ansible</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># ansible 常用模块</span>

根据模块功能分类为：云模块、命令模块、数据库模块、文件模块、资产模块、消息模块、监控模块、网络模块、通知模块、包管理模块、源码控制模块、系统模块、单元模块、web设施模块、Windows模块。

<span class="token comment">## 安装ansible</span>

yum <span class="token function">install</span> ansible -y

<span class="token function">rpm</span> -ql ansible

/etc/ansible
/etc/ansible/ansible.cfg
/etc/ansible/hosts
/etc/ansible/roles
<span class="token punctuation">..</span>.

ansible -h

ansible --version

<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/ansible/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[test]
192.168.0.211

# children
[mfs:children]
mfs_master
mfs_client
mfs_node

[mfs_master]
192.168.204.11

[mfs_client]
192.168.204.21

[mfs_node]
192.168.204.31

EOF</span>

这里仅仅介绍一些最常用的模块；

<span class="token comment">### 收集客户机的信息</span>
ansible all -m setup

<span class="token comment">### ping 模块</span>
ansible all -m <span class="token function">ping</span>

<span class="token comment">### 执行命令</span>
ansible -i /etc/ansible/hosts <span class="token builtin class-name">test</span> -u root -m <span class="token builtin class-name">command</span> -a <span class="token string">'ls -l /root/'</span> -k

<span class="token comment"># 简化如下</span>
ansible <span class="token builtin class-name">test</span> -a <span class="token string">'ls -l /root/'</span> -k


<span class="token comment">### file 模块</span>

ansible <span class="token builtin class-name">test</span> -m <span class="token function">file</span> -a <span class="token string">&quot;src=/etc/fstab dest=/tmp/fstab state=link&quot;</span>

ansible <span class="token builtin class-name">test</span> -m <span class="token function">file</span> -a <span class="token string">&quot;path=/tmp/fstab state=absent&quot;</span>

ansible <span class="token builtin class-name">test</span> -m <span class="token function">file</span> -a <span class="token string">&quot;path=/tmp/test state=touch&quot;</span>

ansible <span class="token builtin class-name">test</span> -m <span class="token function">file</span> -a <span class="token string">&quot;path=/tmp/d2 state=directory owner=root group=root mode=700&quot;</span>

ansible <span class="token builtin class-name">test</span> -m <span class="token builtin class-name">command</span> -a <span class="token string">&quot;ls /tmp -lh&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><h1 id="六、gitlab"><a href="#六、gitlab" class="header-anchor">#</a> 六、gitlab</h1> <h2 id="_6-1-git命令入门"><a href="#_6-1-git命令入门" class="header-anchor">#</a> 6.1 git命令入门</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">cd</span> <span class="token string">&quot;<span class="token variable">$WORKSPACE</span>&quot;</span>
<span class="token function">git</span> checkout <span class="token variable">$GitBranch</span>
<span class="token function">git</span> <span class="token function">diff</span> <span class="token variable">$from_commitid</span> <span class="token variable">$to_commitid</span> --name-only<span class="token operator">&gt;</span>compile_list.txt

<span class="token comment">## 获取commit id</span>
<span class="token function">git</span> log  --pretty<span class="token operator">=</span><span class="token string">&quot;%s&quot;</span>  -2

<span class="token function">git</span> log  --pretty<span class="token operator">=</span><span class="token string">&quot;%H&quot;</span>  -2
<span class="token function">git</span> log  --pretty<span class="token operator">=</span><span class="token string">&quot;%h&quot;</span>  -2

<span class="token comment">## 某文件的修改记录</span>
<span class="token function">git</span> log filename   <span class="token comment"># 查看某个文件的commit记录</span>
<span class="token function">git</span> log -p filename    <span class="token comment"># 查看文件每次提交的diff</span>
<span class="token function">git</span> log --pretty<span class="token operator">=</span>oneline filename <span class="token comment"># 列出文件的所有改动历史</span>
<span class="token function">git</span> show 提交生成的一次哈希值 filename  <span class="token comment"># 只查看某次提交的文件变化</span>

<span class="token comment">## 取消add后的修改</span>
<span class="token function">git</span> reset HEAD + 文件名

<span class="token comment">## 取消commit后的修改</span>
<span class="token function">git</span> checkout commitId 文件名

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_6-2-gitlab的安装使用"><a href="#_6-2-gitlab的安装使用" class="header-anchor">#</a> 6.2 gitlab的安装使用</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">##</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_6-8-jenkins-ci-cd"><a href="#_6-8-jenkins-ci-cd" class="header-anchor">#</a> 6.8 Jenkins CI/CD</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## docker 安装 Jenkins</span>
docker search jenkins
docker pull jenkins/jenkins:lts
<span class="token function">mkdir</span>  /opt/apps/jenkins -p
<span class="token function">chmod</span>  <span class="token number">777</span>   /opt/apps/jenkins
ll /opt/apps/
docker run -it --name wk-jenkinsci -v /opt/apps/jenkins:/var/jenkins_home -p <span class="token number">8080</span>:8080 -p <span class="token number">50000</span>:50000 -p <span class="token number">45000</span>:45000 jenkins/jenkins:lts

<span class="token comment">## 查看启动状态</span>
dockeer <span class="token function">ps</span>

<span class="token comment">## 查看启动端口</span>
<span class="token function">netstat</span> -ntlp <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">8080</span>

<span class="token builtin class-name">cd</span> /opt/apps/jenkins/

<span class="token function">vim</span> copy_reference_file.log
<span class="token comment">## 升级站点项的的地址配置文件</span>
<span class="token function">cat</span> hudson.model.UpdateCenter.xml
<span class="token comment">## 备份配置文件</span>
<span class="token function">cp</span>  hudson.model.UpdateCenter.xml  hudson.model.UpdateCenter.xml.default
<span class="token comment">## 【系统管理】【管理插件】【高级】升级站点项的地址修改成，</span>
<span class="token comment">## 手动修改配置文件或后台修改http://ip:8080/pluginManager/advanced</span>
<span class="token function">grep</span> center.json *
hudson.model.UpdateCenter.xml:    <span class="token operator">&lt;</span>url<span class="token operator">&gt;</span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<span class="token operator">&lt;</span>/url<span class="token operator">&gt;</span>

<span class="token comment">## ldap配置系列二：jenkins集成ldap</span>
https://www.cnblogs.com/zhaojiedi1992/p/zhaojiedi_liunx_52_ldap_for_jenkins.html

<span class="token comment">## jenkins集成OpenLDAP认证</span>
https://www.cnblogs.com/37Y37/p/9430272.html

<span class="token comment">## Jenkins学习七：Jenkins的授权和访问控制  </span>
https://www.cnblogs.com/yangxia-test/p/4368778.html

<span class="token comment">## Jenkins学习四：Jenkins 邮件配置</span>
https://www.cnblogs.com/yangxia-test/p/4366172.html

<span class="token comment">## Jenkins 持续集成综合实战</span>
https://kefeng.wang/2017/01/06/jenkins/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h1 id="七、docker"><a href="#七、docker" class="header-anchor">#</a> 七、docker</h1> <h2 id="_7-1-配置阿里repo安装docker"><a href="#_7-1-配置阿里repo安装docker" class="header-anchor">#</a> 7.1 配置阿里repo安装docker</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## 18.06.1-ce</span>
<span class="token function">wget</span> https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
<span class="token comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span>
<span class="token comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>

yum makecache
yum list docker-ce --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r

yum -y <span class="token function">install</span>  docker-ce
systemctl <span class="token builtin class-name">enable</span> docker <span class="token operator">&amp;&amp;</span> systemctl start docker

docker version

<span class="token comment">## 镜像的导入和导出</span>
docker save rancher/rke-tools:v0.1.59  rancher/coreos-etcd:v3.4.3-rancher1  <span class="token operator">&gt;</span> etcd.tar
docker load <span class="token operator">&lt;</span> etcd.tar

<span class="token comment">## pip3 install docker-compose</span>
yum <span class="token function">install</span> python36-devel python36-pip
pip3 <span class="token function">install</span> docker-compose 

<span class="token comment">### docker-compose命令补全</span>
<span class="token function">curl</span> -L https://raw.githubusercontent.com/docker/compose/1.27.4/contrib/completion/bash/docker-compose <span class="token operator">&gt;</span> /etc/bash_completion.d/docker-compose
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="docker-base"><a href="#docker-base" class="header-anchor">#</a> docker base</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#1.停止所有的container，这样才能够删除其中的images：
docker stop $(docker ps -a -q)

#如果想要删除所有container的话再加一个指令：
docker rm $(docker ps -a -q)

#2.查看当前有些什么images
docker images

#3.删除images，通过image的id来指定删除谁
docker rmi &lt;image id&gt;

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="dockers-volumes"><a href="#dockers-volumes" class="header-anchor">#</a> dockers volumes</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>	  
增加这个
    volumes:
      - /etc/localtime:/etc/localtime
      - /etc/timezone:/etc/timezone  


https://segmentfault.com/a/1190000005612603
docker run -e TZ<span class="token attr-value"><span class="token punctuation">=</span>&quot;Asia/Shanghai&quot; -v /etc/localtime:/etc/localtime:ro --name=tomcat tomcat:8.0.35-jre8</span>

&lt;p&gt;通过这样的启动方式，就是OK了。&lt;br&gt;当然聪明人肯定不会自己每次都在启动的时候加这些配置，当然在基础镜像里面搞好咯。&lt;/p&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="docker-cp"><a href="#docker-cp" class="header-anchor">#</a> docker cp</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">### 将主机/www/runoob目录拷贝到容器96f7f14e99ab的/www目录下。</span>
docker <span class="token function">cp</span> /www/runoob 96f7f14e99ab:/www/

<span class="token comment">### 将主机/www/runoob目录拷贝到容器96f7f14e99ab中，目录重命名为www。</span>
docker <span class="token function">cp</span> /www/runoob 96f7f14e99ab:/www

<span class="token comment">### 将容器96f7f14e99ab的/www目录拷贝到主机的/tmp目录中。</span>
docker <span class="token function">cp</span>  96f7f14e99ab:/www /tmp/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_7-2-docker-compose"><a href="#_7-2-docker-compose" class="header-anchor">#</a> 7.2 docker-compose</h2> <h3 id="_7-2-1-docker-flask"><a href="#_7-2-1-docker-flask" class="header-anchor">#</a> 7.2.1 docker flask</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://www.cnblogs.com/soymilk2019/p/11590117.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_7-2-2-docker-nginx"><a href="#_7-2-2-docker-nginx" class="header-anchor">#</a> 7.2.2 docker nginx</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>docker run --name testnginx  -p <span class="token number">888</span>:80  -v /mnt/nz-docker/init/nginx/nz-docker.conf:/etc/nginx/conf.d/default.conf -v /mnt/nz-docker/client/:/usr/share/nginx/html/  nginx:1.12.2

docker run --name testnginx  -p <span class="token number">888</span>:80  -v init/nginx/nz-docker.conf:/etc/nginx/conf.d/default.conf -v client/:/usr/share/nginx/html/  nginx:1.12.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_7-5-elk-docker"><a href="#_7-5-elk-docker" class="header-anchor">#</a> 7.5 elk - docker</h2> <h3 id="elk"><a href="#elk" class="header-anchor">#</a> elk</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#确立自己原则的“五步原则”</span>
<span class="token comment">#</span>
<span class="token comment">#1、目标：我要什么？</span>
<span class="token comment">#2、计划：我该怎么做？</span>
<span class="token comment">#3、行动：我碰到了什么问题？</span>
<span class="token comment">#4、反思：什么原因？</span>
<span class="token comment">#5、改进：形成原则</span>

├── docker<span class="token punctuation">-</span>compose.yml
├── docker<span class="token punctuation">-</span>stack.yml
├── elasticsearch
│   ├── config
│   │   └── elasticsearch.yml
│   └── Dockerfile
├── extensions
│   ├── apm<span class="token punctuation">-</span>server
│   ├── app<span class="token punctuation">-</span>search
│   ├── curator
│   ├── logspout
├── kibana
│   ├── config
│   │   └── kibana.yml
│   └── Dockerfile
├── LICENSE
├── logstash
│   ├── config
│   │   └── logstash.yml
│   ├── Dockerfile
│   └── pipeline
│       └── logstash.conf
└── README.md

<span class="token punctuation">---</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2.2'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>

  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/elasticsearch/elasticsearch<span class="token punctuation">:</span>7.2.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch7.2.0
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> discovery.type=single<span class="token punctuation">-</span>node
      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span>
      <span class="token punctuation">-</span> TZ=Asia/Shanghai
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> esdata<span class="token punctuation">:</span>/usr/share/elasticsearch
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> elasticsearch
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> 9300<span class="token punctuation">:</span><span class="token number">9300</span>

  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/kibana/kibana<span class="token punctuation">:</span>7.2.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana7.2.0
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch.hosts=http<span class="token punctuation">:</span>//elasticsearch<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> TZ=Asia/Shanghai
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> kibana
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5601:5601&quot;</span>

  <span class="token key atrule">logstash</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/logstash/logstash<span class="token punctuation">:</span>7.2.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> logstash7.2.0
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> TZ=Asia/Shanghai
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> logstash
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9600<span class="token punctuation">:</span><span class="token number">9600</span>
      <span class="token punctuation">-</span> 5044<span class="token punctuation">:</span><span class="token number">5044</span>

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">esdata</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local

<span class="token comment">#链接：https://www.jianshu.com/p/24f6548de113</span>
<span class="token comment">#https://cloud.tencent.com/developer/article/1623379</span>
<span class="token comment">#https://github.com/deviantony/docker-elk</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h3 id="logstash5-配置文件"><a href="#logstash5-配置文件" class="header-anchor">#</a> logstash5 配置文件</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>input {
    file {
<span class="token constant">            path</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;/var/log/httpd/access_log&quot;</span>
<span class="token constant">            type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;http&quot;</span>
<span class="token constant">            start_position</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;beginning&quot;</span>
    }

    file {
<span class="token constant">            path</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;/usr/local/nginx/logs/elk.access.log&quot;</span>
<span class="token constant">            type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;nginx&quot;</span>
<span class="token constant">            start_position</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;beginning&quot;</span>
    }

    file {
<span class="token constant">            path</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;/var/log/secure&quot;</span>
<span class="token constant">            type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;secure&quot;</span>
<span class="token constant">            start_position</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;beginning&quot;</span>
    }

    file {
<span class="token constant">            path</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;/var/log/messages&quot;</span>
<span class="token constant">            type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;system&quot;</span>
<span class="token constant">            start_position</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;beginning&quot;</span>
    }
}


output {
    if [type] <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;http&quot; {</span>
        redis {
<span class="token constant">            host</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;192.168.1.202&quot;</span>
<span class="token constant">            password</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'test'</span>
<span class="token constant">            port</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6379&quot;</span>
<span class="token constant">            db</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6&quot;</span>
<span class="token constant">            data_type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;list&quot;</span>
<span class="token constant">            key</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'nagios_http' </span>
        }
    }

    if [type] <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;nginx&quot; {</span>
        redis {
<span class="token constant">            host</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;192.168.1.202&quot;</span>
<span class="token constant">            password</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'test'</span>
<span class="token constant">            port</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6379&quot;</span>
<span class="token constant">            db</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6&quot;</span>
<span class="token constant">            data_type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;list&quot;</span>
<span class="token constant">            key</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'nagios_nginx' </span>
        }
    }

    if [type] <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;secure&quot; {</span>
        redis {
<span class="token constant">            host</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;192.168.1.202&quot;</span>
<span class="token constant">            password</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'test'</span>
<span class="token constant">            port</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6379&quot;</span>
<span class="token constant">            db</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6&quot;</span>
<span class="token constant">            data_type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;list&quot;</span>
<span class="token constant">            key</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'nagios_secure' </span>
        }
    }

    if [type] <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;system&quot; {</span>
        redis {
<span class="token constant">            host</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;192.168.1.202&quot;</span>
<span class="token constant">            password</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'test'</span>
<span class="token constant">            port</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6379&quot;</span>
<span class="token constant">            db</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;6&quot;</span>
<span class="token constant">            data_type</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;list&quot;</span>
<span class="token constant">            key</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; 'nagios_system' </span>
        }
    }
} 

<span class="token comment"># # /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/full.conf</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h3 id="logstash7-部分配置参考"><a href="#logstash7-部分配置参考" class="header-anchor">#</a> logstash7 部分配置参考</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>{ generator 
    { message <span class="token attr-value"><span class="token punctuation">=</span>&gt; stdin codec =&gt; json }</span>
}

filter {
     mutate {
<span class="token constant">     	 rename</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; { &quot;[foo][bar]&quot; =&gt; &quot;hello&quot; }</span>
		 }
}

input{
<span class="token constant">  stdin{codec</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; json_lines}</span>
}

filter{
  mutate{
<span class="token constant">    rename</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; {</span>
<span class="token constant">	    &quot;[f1][f2]&quot;</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; &quot;f3&quot;</span>
		}
	}
}

output{
  stdout{
<span class="token constant">    codec</span> <span class="token attr-value"><span class="token punctuation">=</span>&gt; rubydebug{}</span>
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="kafka测试"><a href="#kafka测试" class="header-anchor">#</a> kafka测试</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://www.cnblogs.com/xiao987334176/p/10075659.html


/usr/local/kafka/bin/kafka-topics.sh --create --zookeeper 172.16.1.245:2181,172.16.1.243:2181,172.16.1.244:2181/kafka --replication-factor 3 --partitions 1 --topic test-topic

/usr/local/kafka/bin/kafka-topics.sh --describe --zookeeper 172.16.1.245:2181,172.16.1.243:2181,172.16.1.244:2181/kafka --topic test-topic


作者：杨赟快跑
链接：https://www.jianshu.com/p/bdd9608df6b3


/usr/local/kafka/bin/zookeeper-server-start.sh /usr/local/kafka/config/zookeeper.properties 

/usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server.properties &amp;


kill -9 `jps |grep afka |awk '{print $1}'`

grep -v '^$' server.properties |grep -v '^#'

ll /usr/local/kafka/zookeeper/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_7-5-4-filebeat7-yml"><a href="#_7-5-4-filebeat7-yml" class="header-anchor">#</a> 7.5.4 filebeat7.yml</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># Paths that should be crawled and fetched. Glob based paths.</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /opt/log/games/<span class="token important">*/*.log</span>
  <span class="token comment">### Multiline options</span>
  <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^[0-9]{4}'</span>
  <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after

  <span class="token comment">#exclude_files: [&quot;[0-9]{4}-[0-9]{2}-[0-9]{2}.[0-9]{3}.log$&quot;]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;games&quot;</span><span class="token punctuation">]</span>

<span class="token comment">#================================ Logging =====================================</span>
<span class="token comment"># Sets log level. The default log level is info.</span>
<span class="token comment"># Available log levels are: error, warning, info, debug</span>
<span class="token key atrule">logging.level</span><span class="token punctuation">:</span> info
<span class="token key atrule">logging.to_files</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">logging.files</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/log/filebeat7

  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat.log

<span class="token comment">######output for kafka#######</span>
<span class="token key atrule">output.kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;kafka-s1.demain.com:9093&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;kafka-s2.demain.com:9093&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;kafka-s3.demain.com:9093&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">'GAMES-NZ'</span>
  <span class="token key atrule">partition.round_robin</span><span class="token punctuation">:</span>
    <span class="token key atrule">reachable_only</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">required_acks</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">max_message_bytes</span><span class="token punctuation">:</span> <span class="token number">100000000</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;0.10&quot;</span>
  <span class="token key atrule">keep_alive</span><span class="token punctuation">:</span> 60s
  <span class="token key atrule">compression</span><span class="token punctuation">:</span> gzip
  <span class="token key atrule">flush_interval</span><span class="token punctuation">:</span> 10s
  <span class="token comment">#######ssl########</span>
  <span class="token key atrule">ssl.certificate_authorities</span><span class="token punctuation">:</span> <span class="token string">&quot;/usr/local/filebeat/keytool/myca.pem&quot;</span>
  <span class="token key atrule">ssl.certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;/usr/local/filebeat/keytool/client1.pem&quot;</span>
  <span class="token key atrule">ssl.key</span><span class="token punctuation">:</span> <span class="token string">&quot;/usr/local/filebeat/keytool/client1-key.pem&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="_7-5-5-kibana-dev-tools"><a href="#_7-5-5-kibana-dev-tools" class="header-anchor">#</a> 7.5.5 kibana dev tools</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment"># Dev Tools</span>

<span class="token comment">## 入门简介</span>
https://www.cnblogs.com/ginb/p/6637236.html

<span class="token comment">## 官方api</span>
https://www.elastic.co/guide/en/elasticsearch/reference/7.3/cat-health.html

<span class="token comment">## 集群信息</span>
GET /_cluster/stats?pretty

<span class="token comment">## 分片大小</span>
GET /_cat/shards?v
<span class="token comment"># GET _cat/shards?h=index,shard,prirep,state,unassigned.reason</span>

index                        shard prirep state           docs    store ip          node
games-nz_ydwx-2020.11.04     0     r      STARTED        12059    3.5mb 172.16.1.68 es_node-1
games-nz_ydwx-2020.11.04     0     p      STARTED        12059    3.4mb 172.16.1.64 es_node-3


<span class="token comment">## 列出所有索引</span>
GET /_cat/indices?v
<span class="token comment"># GET /_cat/indices?v&amp;s=pri.store.size</span>
<span class="token comment"># GET /_cat/indices?v&amp;s=pri.store.size:desc</span>

health status index                        uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   games-nz_hf-2020.11.03       xWdlWq58RPSjpd7LcA2Ipw   1   1   26337502            0     18.8gb          9.4gb
green  open   games-nz_hf-2020.11.09       Ozy8LS54TKuyEK8mmLMOqA   1   1    1808980            0      1.5gb        769.3mb
green  open   audit-2020.10.25             AggdiOSwQXW0R0EWlNAUig   1   1        186            0    276.8kb        138.4kb

<span class="token comment">## 是否健康</span>
GET /_cat/health?v

<span class="token comment">## 返回 bank 索引中的所有文档</span>
GET /bank/_search?q<span class="token attr-value"><span class="token punctuation">=</span>*&amp;sort=account_number:asc&amp;pretty</span>

<span class="token comment">## ElasticSearch优化整理</span>
https://www.jianshu.com/p/45a15ca1114f
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="_7-5-8-py-es-api"><a href="#_7-5-8-py-es-api" class="header-anchor">#</a> 7.5.8 py es api</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#pip3 install elasticsearch</span>
<span class="token comment">#https://www.cnblogs.com/xiao987334176/p/10130712.html</span>
from elasticsearch <span class="token function">import</span> Elasticsearch
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.10.13.12'</span><span class="token punctuation">]</span>, <span class="token assign-left variable">http_auth</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'xiao'</span>, <span class="token string">'123456'</span><span class="token punctuation">)</span>, <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">)</span>

es.search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'logstash-2015.08.20'</span>, <span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token string">'http_status_code:5* AND server_name:&quot;web1&quot;'</span>, <span class="token assign-left variable">from_</span><span class="token operator">=</span><span class="token string">'124119'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_7-6-cdh-docker"><a href="#_7-6-cdh-docker" class="header-anchor">#</a> 7.6 cdh - docker</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## https://www.cnblogs.com/piperck/p/9917118.html</span>
https://www.cnblogs.com/piperck/p/9917118.html
https://downloads.cloudera.com/demo_vm/docker/cloudera-quickstart-vm-5.13.0-0-beta-docker.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_7-16-prometheus-docker"><a href="#_7-16-prometheus-docker" class="header-anchor">#</a> 7.16 prometheus - docker</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">##</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_7-16-8-py-prom-api"><a href="#_7-16-8-py-prom-api" class="header-anchor">#</a> 7.16.8 py prom api</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">##</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="py-alert-api"><a href="#py-alert-api" class="header-anchor">#</a> py alert api</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">##</span>
GET /-/healthy 
GET /-/ready  
POST /-/reload

<span class="token function">curl</span> -u monitor:fosafer.com <span class="token number">127.0</span>.0.1:9093/-/healthy
<span class="token function">curl</span> -XPOST   <span class="token number">127.0</span>.0.1:9093/-/reload
<span class="token function">curl</span> -XPOST -u monitor:fosafer.com <span class="token number">127.0</span>.0.1:9093/-/reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h1 id="八、prometheus"><a href="#八、prometheus" class="header-anchor">#</a> 八、Prometheus</h1> <h2 id="_8-1-prometheus安装"><a href="#_8-1-prometheus安装" class="header-anchor">#</a> 8.1 prometheus安装</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> xf 
<span class="token function">mkdir</span> /opt/prometheus/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_8-2-promql语法"><a href="#_8-2-promql语法" class="header-anchor">#</a> 8.2 promql语法</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">### 11xxx 的在线redis</span>
redis_up{redis_host<span class="token operator">=</span><span class="token operator">~</span><span class="token string">&quot;.*:11[0-9]{3}&quot;</span>}
<span class="token comment">### prometheus监控 promsql的常用的几个的写法</span>
<span class="token comment">## 监控CPU的使用率</span>
<span class="token number">100</span> <span class="token operator">-</span> <span class="token punctuation">(</span>avg <span class="token keyword">by</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span> <span class="token keyword">mode</span><span class="token operator">=</span><span class="token string">&quot;idle&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">## CPU各个mode的占用率</span>
avg <span class="token keyword">by</span> <span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token keyword">mode</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
<span class="token keyword">user</span>：cpu花了多少比率运行用户态空间，也就是用户进程占比。用户空间程序是不属于内核的任何进程。 
system：CPU花了多少比率运行内核空间。所有进程和系统资源都有liunx内核处理。 
iowait：读写磁盘的操作比CPU的运行时间慢，CPU负载处理数据，而数据一般在磁盘上需要读到内存中才能处理。当CPU发起读写操作后，需要等着磁盘驱动器将数据读入内存，从而导致CPU等待一段时间无事可做。CPU处于这种状态的等待时间就是iowait时间。 
idle：CPU处于空闲状态的时间比例 irq＆softirq：处理器为中断服务的时间。
irq用于硬件中断，
softirq用于软件中断。 
Nice：用户空间进程的CPU的调度优先级，可以通过调整期优先级来调整用户空间的优先级。

<span class="token comment">## 机器一分钟的平均负载</span>
node_load1{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span>}
<span class="token comment">## 内存使用率</span>
<span class="token number">100</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>node_memory_MemFree{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span>}<span class="token operator">+</span>node_memory_Cached{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span>}<span class="token operator">+</span>node_memory_Buffers{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span>}<span class="token punctuation">)</span><span class="token operator">/</span>node_memory_MemTotal<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>

<span class="token comment">### 带宽监控 </span>
<span class="token comment">## 上行带宽</span>
sum <span class="token keyword">by</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_receive_bytes{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span>device<span class="token operator">!</span><span class="token operator">~</span><span class="token string">&quot;bond.*?|lo&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">128</span><span class="token punctuation">)</span>
<span class="token comment">## 下行带宽</span>
sum <span class="token keyword">by</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_transmit_bytes{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span>device<span class="token operator">!</span><span class="token operator">~</span><span class="token string">&quot;bond.*?|lo&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">128</span><span class="token punctuation">)</span>
<span class="token comment">## 入包量</span>
sum <span class="token keyword">by</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_network_receive_bytes{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span>device<span class="token operator">!=</span><span class="token string">&quot;lo&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">## 出包量</span>
sum <span class="token keyword">by</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_network_transmit_bytes{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span>device<span class="token operator">!=</span><span class="token string">&quot;lo&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">## 磁盘使用率</span>
<span class="token number">100</span> <span class="token operator">-</span> node_filesystem_free{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span>fstype<span class="token operator">!</span><span class="token operator">~</span><span class="token string">&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;</span>} <span class="token operator">/</span> node_filesystem_size{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span><span class="token punctuation">,</span>fstype<span class="token operator">!</span><span class="token operator">~</span><span class="token string">&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;</span>} <span class="token operator">*</span> <span class="token number">100</span>
<span class="token comment">## 平均请求数</span>
rate<span class="token punctuation">(</span>http_requests_total{instance<span class="token operator">=</span><span class="token string">&quot;10.3.51.200:9100&quot;</span>}<span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>

原文：https:<span class="token comment">//blog.csdn.net/sunyuhua_keyboard/article/details/81302165 </span>
版权声明：本文为博主原创文章，转载请附上博文链接！

<span class="token comment">### 函数列表一些函数有默认的参数，例如：</span>
<span class="token keyword">year</span><span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>
v是参数值，instant<span class="token operator">-</span>vector是参数类型。
vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>是默认值。

abs<span class="token punctuation">(</span><span class="token punctuation">)</span>
abs<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>返回输入向量的所有样本的绝对值。

absent<span class="token punctuation">(</span><span class="token punctuation">)</span>
absent<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>，如果赋值给它的向量具有样本数据，则返回空向量；如果传递的瞬时向量参数没有样本数据，则返回不带度量指标名称且带有标签的样本值为<span class="token number">1</span>的结果当监控度量指标时，如果获取到的样本数据是空的， 使用absent方法对告警是非常有用的

absent<span class="token punctuation">(</span>nonexistent{job<span class="token operator">=</span><span class="token string">&quot;myjob&quot;</span>}<span class="token punctuation">)</span> <span class="token comment"># =&gt; key: value = {job=&quot;myjob&quot;}: </span>
absent<span class="token punctuation">(</span>nonexistent{job<span class="token operator">=</span><span class="token string">&quot;myjob&quot;</span><span class="token punctuation">,</span> instance<span class="token operator">=</span><span class="token operator">~</span><span class="token string">&quot;.*&quot;</span>}<span class="token punctuation">)</span> <span class="token comment"># =&gt; {job=&quot;myjob&quot;} 1 so smart !</span>
absent<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>nonexistent{job<span class="token operator">=</span><span class="token string">&quot;myjob&quot;</span>}<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># =&gt; key:value {}: 0</span>

ceil<span class="token punctuation">(</span><span class="token punctuation">)</span>
ceil<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span> 是一个向上舍入为最接近的整数。

changes<span class="token punctuation">(</span><span class="token punctuation">)</span>
changes<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span> 输入一个范围向量， 返回这个范围向量内每个样本数据值变化的次数。

clamp_max<span class="token punctuation">(</span><span class="token punctuation">)</span>
clamp_max<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">,</span> max scalar<span class="token punctuation">)</span>函数，输入一个瞬时向量和最大值，样本数据值若大于max，则改为max，否则不变

clamp_min<span class="token punctuation">(</span><span class="token punctuation">)</span>
clamp_min<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入一个瞬时向量和最大值，样本数据值小于min，则改为min。否则不变

count_saclar<span class="token punctuation">(</span><span class="token punctuation">)</span>
count_scalar<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span> 函数<span class="token punctuation">,</span> 输入一个瞬时向量，返回<span class="token keyword">key</span>:<span class="token keyword">value</span><span class="token operator">=</span><span class="token string">&quot;scalar&quot;</span>: 样本个数。而<span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，输入一个瞬时向量，返回<span class="token keyword">key</span>:<span class="token keyword">value</span><span class="token operator">=</span>向量：样本个数，其中结果中的向量允许通过<span class="token keyword">by</span>条件分组。

day_of_month<span class="token punctuation">(</span><span class="token punctuation">)</span>
day_of_month<span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，返回被给定UTC时间所在月的第几天。返回值范围：<span class="token number">1</span><span class="token operator">~</span><span class="token number">31</span>。

day_of_week<span class="token punctuation">(</span><span class="token punctuation">)</span>
day_of_week<span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，返回被给定UTC时间所在周的第几天。返回值范围：<span class="token number">0</span><span class="token operator">~</span><span class="token number">6.</span> <span class="token number">0</span>表示星期天。

days_in_month<span class="token punctuation">(</span><span class="token punctuation">)</span>
days_in_month<span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，返回当月一共有多少天。返回值范围：<span class="token number">28</span><span class="token operator">~</span><span class="token number">31.</span>

delta<span class="token punctuation">(</span><span class="token punctuation">)</span>
delta<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，计算一个范围向量v的第一个元素和最后一个元素之间的差值。返回值：<span class="token keyword">key</span>:<span class="token keyword">value</span><span class="token operator">=</span>度量指标：差值下面这个表达式例子，返回过去两小时的CPU温度差：delta<span class="token punctuation">(</span>cpu_temp_celsius{host<span class="token operator">=</span><span class="token string">&quot;zeus&quot;</span>}<span class="token punctuation">[</span><span class="token number">2</span>h<span class="token punctuation">]</span><span class="token punctuation">)</span>delta函数返回值类型只能是gauges。

deriv<span class="token punctuation">(</span><span class="token punctuation">)</span>
deriv<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，计算一个范围向量v中各个时间序列二阶导数，使用简单线性回归deriv二阶导数返回值类型只能是gauges。

drop_common_labels<span class="token punctuation">(</span><span class="token punctuation">)</span>
drop_common_labels<span class="token punctuation">(</span>instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入一个瞬时向量，返回值是<span class="token keyword">key</span>:<span class="token keyword">value</span><span class="token operator">=</span>度量指标：样本值，其中度量指标是去掉了具有相同标签。 
例如：
http_requests_total{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;127.0.0.1:9090&quot;</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} : <span class="token number">4</span><span class="token punctuation">,</span> 
http_requests_total{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;127.0.0.1:9090&quot;</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span>} : <span class="token number">5</span><span class="token punctuation">,</span> 
返回值: http_requests_total{method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} : <span class="token number">4</span><span class="token punctuation">,</span> http_requests_total{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span>} : <span class="token number">5</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
exp<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入一个瞬时向量<span class="token punctuation">,</span> 返回各个样本值的e指数值，即为e<span class="token operator">^</span>N次方。特殊情况如下所示：Exp<span class="token punctuation">(</span><span class="token operator">+</span>inf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">+</span>Inf Exp<span class="token punctuation">(</span>NaN<span class="token punctuation">)</span> <span class="token operator">=</span> NaNfloor<span class="token punctuation">(</span><span class="token punctuation">)</span>floor<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，与ceil<span class="token punctuation">(</span><span class="token punctuation">)</span>函数相反。 <span class="token number">4.3</span> 为 <span class="token number">4</span> 。

histogram_quantile<span class="token punctuation">(</span><span class="token punctuation">)</span>
histogram_quatile<span class="token punctuation">(</span>φ <span class="token keyword">float</span><span class="token punctuation">,</span> b instant<span class="token operator">-</span>vector<span class="token punctuation">)</span> 函数计算b向量的φ<span class="token operator">-</span>直方图 <span class="token punctuation">(</span><span class="token number">0</span> ≤ φ ≤ <span class="token number">1</span><span class="token punctuation">)</span> 。参考中文文献<span class="token punctuation">[</span>https:<span class="token comment">//www.howtoing.com/how-to-query-prometheus-on-ubuntu-14-04-part-2/]</span>

holt_winters<span class="token punctuation">(</span><span class="token punctuation">)</span>
holt_winters<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">,</span> sf scalar<span class="token punctuation">,</span> tf scalar<span class="token punctuation">)</span>函数基于范围向量v，生成事件序列数据平滑值。平滑因子sf越低<span class="token punctuation">,</span> 对老数据越重要。趋势因子tf越高，越多的数据趋势应该被重视。<span class="token number">0</span><span class="token operator">&lt;</span> sf<span class="token punctuation">,</span> tf <span class="token operator">&lt;=</span><span class="token number">1</span>。 holt_winters仅用于gaugeshour<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">hour</span><span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数返回被给定UTC时间的当前第几个小时，时间范围：<span class="token number">0</span><span class="token operator">~</span><span class="token number">23</span>。

idelta<span class="token punctuation">(</span><span class="token punctuation">)</span>
idelta<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入一个范围向量，返回<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 度量指标： 每最后两个样本值差值。

increase<span class="token punctuation">(</span><span class="token punctuation">)</span>
increase<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数， 输入一个范围向量，返回：<span class="token keyword">key</span>:<span class="token keyword">value</span> <span class="token operator">=</span> 度量指标：<span class="token keyword">last</span>值<span class="token operator">-</span><span class="token keyword">first</span>值，自动调整单调性，
如：服务实例重启，则计数器重置。与delta<span class="token punctuation">(</span><span class="token punctuation">)</span>不同之处在于delta是求差值，而increase返回最后一个减第一个值<span class="token punctuation">,</span>可为正为负。下面的表达式例子，返回过去<span class="token number">5</span>分钟，连续两个时间序列数据样本值的http请求增加值。
increase<span class="token punctuation">(</span>http_requests_total{job<span class="token operator">=</span><span class="token string">&quot;api-server&quot;</span>}<span class="token punctuation">[</span><span class="token number">5</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>increase的返回值类型只能是counters，主要作用是增加图表和数据的可读性，使用rate记录规则的使用率，以便持续跟踪数据样本值的变化。

irateirate<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数<span class="token punctuation">,</span> 输入：范围向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 度量指标： <span class="token punctuation">(</span><span class="token keyword">last</span>值<span class="token operator">-</span><span class="token keyword">last</span>前一个值<span class="token punctuation">)</span><span class="token operator">/</span>时间戳差值。它是基于最后两个数据点，自动调整单调性， 如：服务实例重启，则计数器重置。下面表达式针对范围向量中的每个时间序列数据，返回两个最新数据点过去<span class="token number">5</span>分钟的HTTP请求速率。

irate<span class="token punctuation">(</span>http_requests_total{job<span class="token operator">=</span><span class="token string">&quot;api-server&quot;</span>}<span class="token punctuation">[</span><span class="token number">5</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>irate只能用于绘制快速移动的计数器。因为速率的简单更改可以重置<span class="token keyword">FOR</span>子句，利用警报和缓慢移动的计数器，完全由罕见的尖峰组成的图形很难阅读。

label_replace<span class="token punctuation">(</span><span class="token punctuation">)</span>对于v中的每个时间序列，
label_replace<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">,</span> dst_label string<span class="token punctuation">,</span> replacement string<span class="token punctuation">,</span> src_label string<span class="token punctuation">,</span> regex string<span class="token punctuation">)</span> 将正则表达式与标签值src_label匹配。如果匹配，则返回时间序列，标签值dst_label被替换的扩展替换。$<span class="token number">1</span>替换为第一个匹配子组，$<span class="token number">2</span>替换为第二个等。如果正则表达式不匹配，则时间序列不会更改。另一种更容易的理解是：label_replace函数，输入：瞬时向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 度量指标： 值（要替换的内容：首先，针对src_label标签，对该标签值进行regex正则表达式匹配。如果不能匹配的度量指标，则不发生任何改变；否则，如果匹配，则把dst_label标签的标签纸替换为replacement 下面这个例子返回一个向量值a带有foo标签： 

label_replace<span class="token punctuation">(</span>up{job<span class="token operator">=</span><span class="token string">&quot;api-server&quot;</span><span class="token punctuation">,</span> serice<span class="token operator">=</span><span class="token string">&quot;a:c&quot;</span>}<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;service&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(.):.&quot;</span><span class="token punctuation">)</span>

ln<span class="token punctuation">(</span><span class="token punctuation">)</span>
ln<span class="token punctuation">(</span>v instance<span class="token operator">-</span>vector<span class="token punctuation">)</span>计算瞬时向量v中所有样本数据的自然对数。特殊例子：ln<span class="token punctuation">(</span><span class="token operator">+</span>Inf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">+</span>Inf ln<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>Inf ln<span class="token punctuation">(</span>x<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> NaN ln<span class="token punctuation">(</span>NaN<span class="token punctuation">)</span> <span class="token operator">=</span> NaN

log2<span class="token punctuation">(</span><span class="token punctuation">)</span>
log2<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数计算瞬时向量v中所有样本数据的二进制对数。

log10<span class="token punctuation">(</span><span class="token punctuation">)</span>
log10<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数计算瞬时向量v中所有样本数据的<span class="token number">10</span>进制对数。相当于ln<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">minute</span><span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数返回给定UTC时间当前小时的第多少分钟。结果范围：<span class="token number">0</span><span class="token operator">~</span><span class="token number">59</span>。

<span class="token keyword">month</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">month</span><span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数返回给定UTC时间当前属于第几个月，结果范围：<span class="token number">0</span><span class="token operator">~</span><span class="token number">12</span>。

predict_linear<span class="token punctuation">(</span><span class="token punctuation">)</span>
predict_linear<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">,</span> t scalar<span class="token punctuation">)</span>预测函数，输入：范围向量和从现在起t秒后，输出：不带有度量指标，只有标签列表的结果值。例如：predict_linear<span class="token punctuation">(</span>http_requests_total{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>}<span class="token punctuation">[</span><span class="token number">5</span>m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
结果：
{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query_range&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">1</span>
{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">4283.449995397104</span>
{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;static&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">22.99999999999999</span>
{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">130.90381188596754</span>
{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;graph&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">2</span>
{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;label_values&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">2</span>

rate<span class="token punctuation">(</span><span class="token punctuation">)</span>
rate<span class="token punctuation">(</span>v range<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数<span class="token punctuation">,</span> 输入：范围向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 不带有度量指标，且只有标签列表：<span class="token punctuation">(</span><span class="token keyword">last</span>值<span class="token operator">-</span><span class="token keyword">first</span>值<span class="token punctuation">)</span><span class="token operator">/</span>时间差srate<span class="token punctuation">(</span>http_requests_total<span class="token punctuation">[</span><span class="token number">5</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>结果：{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;label_values&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query_range&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0.2</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0.003389830508474576</span>{code<span class="token operator">=</span><span class="token string">&quot;422&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;static&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;graph&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;400&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>rate<span class="token punctuation">(</span><span class="token punctuation">)</span>函数返回值类型只能用counters， 当用图表显示增长缓慢的样本数据时，这个函数是非常合适的。注意：当rate函数和聚合方式联合使用时，一般先使用rate函数，再使用聚合操作<span class="token punctuation">,</span> 否则，当服务实例重启后，rate无法检测到counter重置。

resets<span class="token punctuation">(</span><span class="token punctuation">)</span>
resets<span class="token punctuation">(</span><span class="token punctuation">)</span>函数<span class="token punctuation">,</span> 输入：一个范围向量，输出：<span class="token keyword">key</span><span class="token operator">-</span><span class="token keyword">value</span><span class="token operator">=</span>没有度量指标，且有标签列表<span class="token punctuation">[</span>在这个范围向量中每个度量指标被重置的次数<span class="token punctuation">]</span>。在两个连续样本数据值下降，也可以理解为counter被重置。 示例：resets<span class="token punctuation">(</span>http_requests_total<span class="token punctuation">[</span><span class="token number">5</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>结果：{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;label_values&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query_range&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;422&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;static&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;graph&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>{code<span class="token operator">=</span><span class="token string">&quot;400&quot;</span><span class="token punctuation">,</span><span class="token keyword">handler</span><span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span>instance<span class="token operator">=</span><span class="token string">&quot;120.77.65.193:9090&quot;</span><span class="token punctuation">,</span>job<span class="token operator">=</span><span class="token string">&quot;prometheus&quot;</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">&quot;get&quot;</span>} <span class="token number">0</span>resets只能和counters一起使用。

<span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">round</span><span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">,</span> to_nearest <span class="token number">1</span><span class="token operator">=</span> scalar<span class="token punctuation">)</span>函数，与ceil和floor函数类似，输入：瞬时向量，输出：指定整数级的四舍五入值<span class="token punctuation">,</span> 如果不指定，则是<span class="token number">1</span>以内的四舍五入。

scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
scalar<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数<span class="token punctuation">,</span> 输入：瞬时向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> “scalar”<span class="token punctuation">,</span> 样本值<span class="token punctuation">[</span>如果度量指标样本数量大于<span class="token number">1</span>或者等于<span class="token number">0</span><span class="token punctuation">,</span> 则样本值为NaN<span class="token punctuation">,</span> 否则，样本值本身<span class="token punctuation">]</span>

sort<span class="token punctuation">(</span><span class="token punctuation">)</span>
sort<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入：瞬时向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 度量指标：样本值<span class="token punctuation">[</span>升序排列<span class="token punctuation">]</span>

sort_desc<span class="token punctuation">(</span><span class="token punctuation">)</span>
sort_desc<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入：瞬时向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 度量指标：样本值<span class="token punctuation">[</span>降序排列<span class="token punctuation">]</span>

sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span>
sqrt<span class="token punctuation">(</span>v instant<span class="token operator">-</span>vector<span class="token punctuation">)</span>函数，输入：瞬时向量，输出：<span class="token keyword">key</span>: <span class="token keyword">value</span> <span class="token operator">=</span> 度量指标： 样本值的平方根

<span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，返回从<span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>到现在的秒数，注意：它不是直接返回当前时间，而是时间戳

vector<span class="token punctuation">(</span><span class="token punctuation">)</span>
vector<span class="token punctuation">(</span>s scalar<span class="token punctuation">)</span>函数，返回：<span class="token keyword">key</span>: <span class="token keyword">value</span><span class="token operator">=</span> {}<span class="token punctuation">,</span> 传入参数值

<span class="token keyword">year</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">year</span><span class="token punctuation">(</span>v<span class="token operator">=</span>vector<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> instant<span class="token operator">-</span>vector<span class="token punctuation">)</span><span class="token punctuation">,</span> 返回年份。_over_time<span class="token punctuation">(</span><span class="token punctuation">)</span>下面的函数列表允许传入一个范围向量，返回一个带有聚合的瞬时向量:
avg_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的平均值。
min_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的最小值。
max_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的最大值。
sum_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的求和值。
count_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的样本数据个数。
quantile_over_time<span class="token punctuation">(</span>scalar<span class="token punctuation">,</span> range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的样本数据值分位数，φ<span class="token operator">-</span>quantile <span class="token punctuation">(</span><span class="token number">0</span> ≤ φ ≤ <span class="token number">1</span><span class="token punctuation">)</span>
stddev_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的总体标准偏差。
stdvar_over_time<span class="token punctuation">(</span>range<span class="token operator">-</span>vector<span class="token punctuation">)</span>: 范围向量内每个度量指标的总体标准方差。
转自：https:<span class="token comment">//github.com/1046102779/prometheus/blob/master/prometheus/querying/functions.md</span>
https:<span class="token comment">//github.com/prometheus/prometheus/blob/master/docs/querying/functions.md</span>


irate<span class="token punctuation">(</span>node_cpu<span class="token punctuation">[</span><span class="token number">2</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>
irate<span class="token punctuation">(</span>node_load1{instance<span class="token operator">=</span><span class="token string">&quot;172.16.1.43:9301&quot;</span>}<span class="token punctuation">[</span><span class="token number">8</span>h<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">max</span><span class="token punctuation">(</span>prometheus_http_request_duration_seconds_count{instance<span class="token operator">=</span><span class="token string">&quot;129.211.99.141:9090&quot;</span>}<span class="token punctuation">)</span>
max_over_time<span class="token punctuation">(</span>prometheus_http_request_duration_seconds_count{instance<span class="token operator">=</span><span class="token string">&quot;129.211.99.141:9090&quot;</span>}<span class="token punctuation">[</span><span class="token number">2</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br></div></div><h2 id="_8-5-grafana"><a href="#_8-5-grafana" class="header-anchor">#</a> 8.5 Grafana</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>常用模板编号：
node-exporter: cn/8919,en/11074
k8s: 13105
docker: 12831
alertmanager: 9578
blackbox_exportre: 9965
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h1 id="九、kubernetes"><a href="#九、kubernetes" class="header-anchor">#</a> 九、kubernetes</h1> <blockquote><p><a href="https://www.kubernetes.org.cn/deployment" target="_blank" rel="noopener noreferrer">Kubernetes（k8s）中文文档 名称解释：Deployment_Kubernetes中文社区<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">####################</span>
https://zhuanlan.zhihu.com/p/53260098

怎么样？是不是很神奇？

所以，Docker的第二句口号就是：&quot;Build once，Run anywhere（搭建一次，到处能用）&quot;。

Docker技术的三大核心概念，分别是：

镜像（Image）
容器（Container）
仓库（Repository）

一个K8S系统，通常称为一个K8S集群（Cluster）,主要包括两个部分：

一个Master节点（主节点）
一群Node节点（计算节点）

Master节点包括: API Server、Scheduler、Controller manager、etcd。

API Server是整个系统的对外接口，供客户端和其它组件调用，相当于&quot;营业厅&quot;。

Scheduler负责对集群内部的资源进行调度，相当于&quot;调度室&quot;。

Controller manager负责管理控制器，相当于&quot;大总管&quot;。


Node节点包括Docker、kubelet、kube-proxy、Fluentd、kube-dns（可选），还有就是Pod。

Pod是Kubernetes最基本的操作单元。一个Pod代表着集群中运行的一个进程，它内部封装了一个或多个紧密相关的容器。除了Pod之外，K8S还有一个Service的概念，一个Service可以看作一组提供相同服务的Pod的对外访问接口。这段不太好理解，跳过吧。

Docker，不用说了，创建容器的。

Kubelet，主要负责监视指派到它所在Node上的Pod，包括创建、修改、监控、删除等。

Kube-proxy，主要负责为Pod对象提供代理。

Fluentd，主要负责日志收集、存储与查询。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="_9-1-kubeadm-安装k8s"><a href="#_9-1-kubeadm-安装k8s" class="header-anchor">#</a> 9.1 kubeadm 安装k8s</h2> <h3 id="_9-1-1-机器初始化（准备环境）"><a href="#_9-1-1-机器初始化（准备环境）" class="header-anchor">#</a> 9.1.1 机器初始化（准备环境）</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">### 关闭防火墙：</span>
systemctl stop firewalld
systemctl disable firewalld

<span class="token comment">### 关闭selinux：</span>
<span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/'</span> /etc/selinux/config 
setenforce <span class="token number">0</span>

<span class="token comment">### 关闭swap：</span>
swapoff -a  <span class="token comment">#临时</span>
<span class="token function">sed</span> -i <span class="token string">'/swap/ s/^\(.*\)$/#<span class="token entity" title="\1">\1</span>/g'</span> /etc/fstab
<span class="token comment">### vim /etc/fstab  永久</span>

<span class="token comment">### 添加主机名与IP对应关系（记得设置主机名）：</span>
<span class="token comment">## hostnamectl --static set-hostname  k8s-node02</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
192.168.204.140 k8s-master
192.168.204.141 k8s-node1
192.168.204.142 k8s-node2

EOF</span>
<span class="token comment">### 将桥接的IPv4流量传递到iptables的链：</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</span>
sysctl --system

yum <span class="token function">install</span> -y conntrack ntpdate ntp ipvsadm ipset jq iptables <span class="token function">curl</span> sysstat libseccomp <span class="token function">wget</span>

<span class="token comment">### repo配置</span>
<span class="token function">mkdir</span> /etc/yum.repo.d/bak
<span class="token function">mv</span> /etc/yum.repo.d/*.repo /etc/yum.repo.d/bak
<span class="token function">wget</span> -O /etc/yum.repos.d/epel.repo  http://mirrors.aliyun.com/repo/epel-7.repo

<span class="token function">wget</span> -O /etc/yum.repos.d/CentOS-Base.repo  http://mirrors.aliyun.com/repo/Centos-7.repo

<span class="token function">wget</span> -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 

<span class="token comment">### 安装指定版本的docker</span>
yum makecache
yum -y <span class="token function">install</span> docker-ce-18.06.1.ce-3.el7
systemctl <span class="token builtin class-name">enable</span> docker <span class="token operator">&amp;&amp;</span> systemctl start docker

docker --version

<span class="token comment">### 配置k8s repo</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>

<span class="token comment">### 4.3 安装kubeadm，kubelet和kubectl</span>
<span class="token comment">### 由于版本更新频繁，这里指定版本号部署：</span>

yum <span class="token function">install</span> -y kubelet-1.15.2 kubeadm-1.15.2 kubectl-1.15.2
systemctl <span class="token builtin class-name">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h3 id="_9-1-2-master部署"><a href="#_9-1-2-master部署" class="header-anchor">#</a> 9.1.2 master部署</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">### 在192.168.204.140 （Master）执行。</span>

kubeadm init <span class="token punctuation">\</span>
  --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.204.140 <span class="token punctuation">\</span>
  --image-repository registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
  --kubernetes-version v1.15.0 <span class="token punctuation">\</span>
  --service-cidr<span class="token operator">=</span><span class="token number">10.1</span>.0.0/16 <span class="token punctuation">\</span>
  --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16


<span class="token comment">### 由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</span>

<span class="token comment">### 使用kubectl工具：</span>

<span class="token comment">## bash</span>
<span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
kubectl get nodes
kubectl get pods -A
<span class="token comment">## 6. 安装Pod网络插件（CNI）</span>

<span class="token comment">## kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c1141408878db11b/Documentation/kube-flannel.yml</span>

kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<span class="token comment">## https://www.cnblogs.com/hongdada/p/11395200.html</span>
docker pull quay-mirror.qiniu.com/coreos/flannel:v0.11.0-amd64
docker tag quay-mirror.qiniu.com/coreos/flannel:v0.11.0-amd64 quay.io/coreos/flannel:v0.11.0-amd64
docker rmi quay-mirror.qiniu.com/coreos/flannel:v0.11.0-amd64 

海外服务器执行：
docker save gcr.io/google_containers/kubernetes-dashboard-amd64:v1.5.1 <span class="token operator">&gt;</span> dashboard.tar
docker save registry.access.redhat.com/rhel7/pod-infrastructure:latest <span class="token operator">&gt;</span> podinfrastructure.tar
<span class="token function">scp</span> *.tar root@你国内的外网IP:/home/tar
各个node上执行：
docker load <span class="token operator">&lt;</span> dashboard.tar
docker load <span class="token operator">&lt;</span> podinfrastructure.tar

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -A -o wide</span>
NAMESPACE     NAME                                   READY   STATUS                  RESTARTS   AGE   IP                NODE           NOMINATED NODE   READINESS GATES
kube-system   coredns-bccdc95cf-rbpfs                <span class="token number">0</span>/1     Pending                 <span class="token number">0</span>          28m   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   coredns-bccdc95cf-tsdf6                <span class="token number">0</span>/1     Pending                 <span class="token number">0</span>          28m   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   etcd-k8s-master01                      <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          28m   <span class="token number">192.168</span>.204.140   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   kube-apiserver-k8s-master01            <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          28m   <span class="token number">192.168</span>.204.140   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   kube-controller-manager-k8s-master01   <span class="token number">1</span>/1     Running                 <span class="token number">1</span>          28m   <span class="token number">192.168</span>.204.140   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   kube-flannel-ds-amd64-4jqnj            <span class="token number">0</span>/1     Init:ImagePullBackOff   <span class="token number">0</span>          19m   <span class="token number">192.168</span>.204.140   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   kube-proxy-rpl4s                       <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          28m   <span class="token number">192.168</span>.204.140   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-system   kube-scheduler-k8s-master01            <span class="token number">1</span>/1     Running                 <span class="token number">1</span>          28m   <span class="token number">192.168</span>.204.140   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment">### 确保能够访问到quay.io这个registery。</span>
<span class="token comment">### 如果下载失败，可以改成这个镜像地址：lizhenliang/flannel:v0.11.0-amd64</span>

kubectl  delete pods kube-flannel-ds-amd64-4jqnj -n kube-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="_9-1-3-node部署"><a href="#_9-1-3-node部署" class="header-anchor">#</a> 9.1.3 node部署</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## 在192.168.204.141/142 （Node）执行。</span>
<span class="token comment">## 向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</span>
kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.204.140:6443 --token vr3h2n.8tq4754f0qugtesu <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:a300b8ebdb144938a3aabbba76bc98968c9546ebb9083445b764ea037b172503

<span class="token comment">## master 执行 get pods -A  发现flannel自动注册</span>
kube-system   kube-flannel-ds-amd64-m8vvw            <span class="token number">1</span>/1     Running   <span class="token number">1</span>          35s

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_9-1-4-测试集群"><a href="#_9-1-4-测试集群" class="header-anchor">#</a> 9.1.4 测试集群</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">### 在Kubernetes集群中创建一个pod，验证是否正常运行：</span>

kubectl create deployment nginx --image<span class="token operator">=</span>nginx
kubectl expose deployment nginx --port<span class="token operator">=</span><span class="token number">80</span> --type<span class="token operator">=</span>NodePort
kubectl get pod,svc

<span class="token comment">### 访问地址：http://NodeIP:Port  </span>
http://192.168.204.135:30586/	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_9-1-5-部署dashboard"><a href="#_9-1-5-部署dashboard" class="header-anchor">#</a> 9.1.5 部署dashboard</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>docker pull sacred02/kubernetes-dashboard-amd64:v1.10.1
docker tag sacred02/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1
docker rmi sacred02/kubernetes-dashboard-amd64:v1.10.1
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml

<span class="token comment">### 默认镜像国内无法访问，修改镜像地址为： lizhenliang/kubernetes-dashboard-amd64:v1.10.1</span>

<span class="token comment">### 默认Dashboard只能集群内部访问，修改 Service 为 NodePort 类型，暴露到外部：</span>

kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kube-system
spec:
  type: NodePort
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">30001</span>
  selector:
    k8s-app: kubernetes-dashboard

kubectl apply -f kubernetes-dashboard.yaml

访问地址：http://NodeIP:30001

<span class="token comment">### 创建service account并绑定默认cluster-admin管理员集群角色：</span>

kubectl create serviceaccount dashboard-admin -n kube-system
kubectl create clusterrolebinding dashboard-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin
kubectl describe secrets -n kube-system <span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system get secret <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/dashboard-admin/{print <span class="token variable">$1</span>}'</span><span class="token variable">)</span></span>

使用输出的token登录Dashboard。

<span class="token comment">### 更新https证书有效期，解决只能由火狐浏览器访问，其他浏览器无法访问问题</span>
<span class="token comment">### https://www.cnblogs.com/xiajq/p/11322568.html</span>

<span class="token function">mkdir</span> key <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> key
openssl genrsa -out dashboard.key <span class="token number">2048</span> 

openssl req -new -out dashboard.csr -key dashboard.key -subj <span class="token string">'/CN=172.19.0.48'</span>

openssl x509 -req -in dashboard.csr -signkey dashboard.key -out dashboard.crt 

kubectl delete secret kubernetes-dashboard-certs -n kube-system

kubectl create secret generic kubernetes-dashboard-certs --from-file<span class="token operator">=</span>dashboard.key --from-file<span class="token operator">=</span>dashboard.crt -n kube-system  <span class="token comment">#新的证书</span>

kubectl delete pod kubernetes-dashboard-746dfd476-b2r5f -n kube-system    <span class="token comment">#重启服务</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h2 id="_9-2-rancher安装k8s"><a href="#_9-2-rancher安装k8s" class="header-anchor">#</a> 9.2 rancher安装k8s</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>yum -y <span class="token function">install</span> docker-ce-18.06.1.ce-3.el7

<span class="token comment">## 18.06.1-ce</span>

<span class="token function">wget</span> https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
yum makecache
yum list docker-ce --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r

yum    <span class="token function">install</span> docker-ce-18.09.1.ce-3.el7
systemctl <span class="token builtin class-name">enable</span> docker <span class="token operator">&amp;&amp;</span> systemctl start docker

docker version

<span class="token function">rm</span> -rf /opt/apps/rancher

docker run -d --restart<span class="token operator">=</span>unless-stopped -v /opt/apps/rancher:/var/lib/rancher/ -p <span class="token number">80</span>:80 -p <span class="token number">443</span>:443 rancher/rancher


<span class="token function">sudo</span> docker run -d --privileged --restart<span class="token operator">=</span>unless-stopped --net<span class="token operator">=</span>host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.4.5 --server https://192.168.204.222 --token 8jnbplvpmfh2whfl8vdjrlqzpnjj8nmvvxstrq9bkh7zc9d2g54xgm --ca-checksum 4cf464173b12436e203b80dc537a1db4543e87c6cf17c4a2e34bfde51b843c37 --node-name master222 --internal-address <span class="token number">192.168</span>.204.222 --etcd --controlplane --worker

<span class="token function">sudo</span> docker run -d --privileged --restart<span class="token operator">=</span>unless-stopped --net<span class="token operator">=</span>host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.4.5 --server https://192.168.204.222 --token xc8v54vtsfc4gv8x6lvzjsdh8l9h8jd6jgkvtngv9rc724fm96wqk2 --ca-checksum ca0c7092f76162c056f79a7bdffe439cdfd7f74b298e2831b3d9792f0fda798f --node-name master222 --internal-address <span class="token number">192.168</span>.204.222 --etcd --controlplane --worker


<span class="token comment">## 镜像的导入和导出</span>
docker save rancher/rke-tools:v0.1.59 <span class="token operator">&gt;</span> tools.tar
docker save rancher/coreos-etcd:v3.4.3-rancher1  <span class="token operator">&gt;</span> etcd.tar
docker load <span class="token operator">&lt;</span> etcd.tar
docker load <span class="token operator">&lt;</span> tools.tar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_9-9-排除-001-cluster-dns问题"><a href="#_9-9-排除-001-cluster-dns问题" class="header-anchor">#</a> 9.9 排除 001 cluster-dns问题</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>修改/usr/lib/systemd/system/kubelet.service  参数：cluster-dns  cluster-domain 
kubectl  describe pod kubernetes-dashboard-746dfd476-mdv5n  -n kube-system

<span class="token comment">## 报错：kubelet does not have ClusterDNS IP configured and cannot create PodJ解决方案</span>

<span class="token selector">[root@VM_0_48_centos dashboard]</span># cat /usr/lib/systemd/system/kubelet.service
<span class="token selector">[Unit]</span>
<span class="token constant">Description</span><span class="token attr-value"><span class="token punctuation">=</span>Kubernetes Kubelet</span>
<span class="token constant">After</span><span class="token attr-value"><span class="token punctuation">=</span>docker.service</span>
<span class="token constant">Requires</span><span class="token attr-value"><span class="token punctuation">=</span>docker.service</span>

<span class="token selector">[Service]</span>
<span class="token constant">EnvironmentFile</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/cfg/kubelet</span>
<span class="token constant">ExecStart</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/bin/kubelet $KUBELET_OPTS</span>
<span class="token constant">Restart</span><span class="token attr-value"><span class="token punctuation">=</span>on-failure</span>
<span class="token constant">KillMode</span><span class="token attr-value"><span class="token punctuation">=</span>process</span>

<span class="token selector">[Install]</span>
<span class="token constant">WantedBy</span><span class="token attr-value"><span class="token punctuation">=</span>multi-user.target</span>


<span class="token selector">[root@VM_0_48_centos dashboard]</span># cat /opt/kubernetes/cfg/kubelet
<span class="token constant">KUBELET_OPTS</span><span class="token attr-value"><span class="token punctuation">=</span>&quot;--logtostderr=true \</span>
<span class="token constant">--v</span><span class="token attr-value"><span class="token punctuation">=</span>4 \</span>
<span class="token constant">--hostname-override</span><span class="token attr-value"><span class="token punctuation">=</span>172.19.0.48 \</span>
<span class="token constant">--cluster-dns</span><span class="token attr-value"><span class="token punctuation">=</span>10.0.0.2 \             ### 配置dns</span>
<span class="token constant">--cluster-domain</span><span class="token attr-value"><span class="token punctuation">=</span>cluster.local \   ###配置域名</span>
<span class="token constant">--kubeconfig</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/cfg/kubelet.kubeconfig \</span>
<span class="token constant">--bootstrap-kubeconfig</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/cfg/bootstrap.kubeconfig \</span>
<span class="token constant">--cert-dir</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/ssl \</span>
<span class="token constant">--pod-infra-container-image</span><span class="token attr-value"><span class="token punctuation">=</span>registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span>

修改完以后，重启服务发现正常


<span class="token comment">## k8s dashboard 安装和证书更新</span>
https://www.cnblogs.com/xiajq/p/11322568.html


<span class="token comment">## Kubernetes的Deployment与ReplicaSet了解与基础操作</span>
https://cloud.tencent.com/developer/article/1347201
Deployment是新一代用于Pod管理的对象，与Replication Controller相比，它提供了更加完善的功能，使用起来更加简单方便。

<span class="token comment">## 比较 Deployment 与 ReplicaSet</span>
　　ReplicaSet 也是用来管理多个 Pod 的副本，那么 Deployment 和 ReplicaSet 的区别在哪里呢？
　　当我们创建了 Deployment 之后，实际上也创建了 ReplicaSet，所以说 Deployment 管理着 ReplicaSet（实际上 Deployment 比 ReplicaSet 有着更多功能）

<span class="token comment">#Deployment 管理着 ReplicaSet，因此当 Deployment 伸缩时，由它管理的 ReplicaSet 也会发生伸缩：</span>

但反过来，如果我们直接伸缩 ReplicaSet，那么 Deployment 也会相应发生伸缩吗？答案是不会的。

kubectl  apply -f nginx-deployment.yaml

kubectl  rollout status deployments nginx-deployment

kubectl  edit deploy nginx-service

kubectl  rollout history deployment nginx-service

kubectl  rollout history deployment nginx-service --revision<span class="token attr-value"><span class="token punctuation">=</span>2</span>
kubectl  rollout history deployment nginx-service --revision<span class="token attr-value"><span class="token punctuation">=</span>1</span>
<span class="token comment">## 假设我们想回滚到上一个版本，上一个版本的版本号是 1，那么可以执行：</span>

kubectl  rollout undo deployments nginx-service --to-revision<span class="token attr-value"><span class="token punctuation">=</span>1</span>

<span class="token comment">## k8s证书</span>
https://www.cnblogs.com/centos-python/articles/11043570.html

<span class="token comment">## k8s 使用篇 - deployment</span>
<span class="token comment">## https://my.oschina.net/u/914655/blog/1635492</span>
<span class="token comment">## https://blog.csdn.net/weixin_34268753/article/details/89586977</span>
Deployment管理Pods和ReplicaSets，提供声明式更新。和老的ReplicationController（命令式管理）对应，发展趋势是取代老的，所以后面也不会起文章单独讨论ReplicationController了。

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h1 id="项目实战"><a href="#项目实战" class="header-anchor">#</a> <strong>项目实战</strong></h1> <h2 id="_000-lvs-keepalive双机热备"><a href="#_000-lvs-keepalive双机热备" class="header-anchor">#</a> 000 LVS+Keepalive双机热备</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## keepalived工作原理  https://www.cnblogs.com/xiangsikai/p/8436431.html</span>
　　keepalived是集群管理中保证集群高可用的一个服务软件，其功能类似于heartbeat，用来防止单点故障。

　　keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即虚拟路由冗余协议。

　　虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。

　　keepalived主要有三个模块，分别是core、check和vrrp。core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。check负责健康检查，包括常见的各种检查方式。vrrp模块是来实现VRRP协议的。


<span class="token comment">## 安装keepalived</span>
yum -y <span class="token function">install</span> keepalived* ipvsadm
<span class="token comment">## 加载内核模块</span>
modprobe ip_vs
<span class="token comment">## 备份配置文件</span>
<span class="token function">mv</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf_bak

<span class="token function">cat</span> /etc/keepalived/keepalived.conf
global_defs <span class="token punctuation">{</span>
    router_id LVS_TEST    <span class="token comment">#服务器名字</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state MASTER    <span class="token comment">#配置主备，备用机此配置项为BACKUP</span>
    interface enp0s3    <span class="token comment">#指定接口</span>
    virtual_router_id <span class="token number">51</span>    <span class="token comment">#指定路由ID，主备必须一样</span>
    priority <span class="token number">101</span>    <span class="token comment">#设置优先级，主略高于备份</span>
    advert_int <span class="token number">1</span>    <span class="token comment">#设置检查时间</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS    <span class="token comment">#设置验证加密方式</span>
        auth_type <span class="token number">1234</span>    <span class="token comment">#设置验证密码</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.31.200
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

virtual_server <span class="token number">192.168</span>.31.200 <span class="token number">80</span> <span class="token punctuation">{</span>
    delay_loop <span class="token number">3</span>    <span class="token comment">#健康检查时间</span>
    lb_algo rr    <span class="token comment">#LVS调度算法</span>
    lb_kind DR   <span class="token comment">#LVS工作模式</span>
    <span class="token operator">!</span>persistence <span class="token number">60</span>    <span class="token comment">#是否保持连接，！不保持</span>
    protocol TCP    <span class="token comment">#服务采用TCP协议</span>
    real_server <span class="token number">192.168</span>.31.113 <span class="token number">80</span> <span class="token punctuation">{</span>
        weight <span class="token number">1</span>    <span class="token comment">#权重</span>
        TCP_CHECK <span class="token punctuation">{</span>    <span class="token comment">#TCP检查</span>
            connect_port <span class="token number">80</span>   <span class="token comment">#检查端口80</span>
            connect_timeout <span class="token number">3</span>    <span class="token comment">#超时时间3秒</span>
            nb_get_retry <span class="token number">3</span>    <span class="token comment">#重试次数3次</span>
            delay_before_retry <span class="token number">4</span>    <span class="token comment">#重试间隔4秒</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    real_server <span class="token number">192.168</span>.31.150 <span class="token number">80</span> <span class="token punctuation">{</span>
        weight <span class="token number">1</span>
        TCP_CHECK <span class="token punctuation">{</span>
            connect_port <span class="token number">80</span>
            connect_timeout <span class="token number">3</span>
            nb_get_retry <span class="token number">3</span>
            delay_before_retry <span class="token number">4</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">## 启动keepalived</span>
systemctl restart keepalived <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><h2 id="_001-haproxy-keepalived-基于四层"><a href="#_001-haproxy-keepalived-基于四层" class="header-anchor">#</a> 001 haproxy+keepalived 基于四层</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## https://www.cnblogs.com/MacoLee/p/5853356.html</span>

 HAProxy的balance8种负载均衡算法：
   <span class="token number">1</span>.roundrobin <span class="token builtin class-name">:</span> 基于权重轮循。
   <span class="token number">2</span>.static-rr <span class="token builtin class-name">:</span> 基于权重轮循。静态算法，运行时改变无法生效
   <span class="token number">3</span>.source <span class="token builtin class-name">:</span> 基于请求源IP的算法。对请求的源IP进行hash运算，然后将结果与后端服务器的权重总数想除后转发至某台匹配服务器。使同一IP客户端请求始终被转发到某特定的后端服务器。
   <span class="token number">4</span>.leastconn <span class="token builtin class-name">:</span> 最小连接。（适合数据库负载均衡，不适合会话短的环境） 
   <span class="token number">5</span>.uri <span class="token builtin class-name">:</span> 对部分或整体URI进行hash运算，再与服务器的总权重想除，最后转发到匹配后端。
   <span class="token number">6</span>.uri_param <span class="token builtin class-name">:</span> 根据URL路径中参数进行转发，保证在后端服务器数量不变的情况下，同一用户请求分发到同一机器。
   <span class="token number">7</span>.hdr<span class="token punctuation">(</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token builtin class-name">:</span> 根据http头转发，如果不存在http头。则使用简单轮循。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_002-nginx-keepalived-基于七层"><a href="#_002-nginx-keepalived-基于七层" class="header-anchor">#</a> 002 nginx+keepalived 基于七层</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_003-vue-git-docker-jenkins-cicd"><a href="#_003-vue-git-docker-jenkins-cicd" class="header-anchor">#</a> 003 vue+git+docker+jenkins cicd</h2> <p>https://www.cnblogs.com/xiao987334176/p/12345304.html</p> <h2 id="_004-jenkins-gitlab-harbor-rancher-k8s"><a href="#_004-jenkins-gitlab-harbor-rancher-k8s" class="header-anchor">#</a> 004 Jenkins+Gitlab+Harbor+Rancher+k8s</h2> <p>https://www.cnblogs.com/xiao987334176/p/13074198.html</p> <h2 id="_005-docker通过efk（elasticsearch-fluentd-kibana）"><a href="#_005-docker通过efk（elasticsearch-fluentd-kibana）" class="header-anchor">#</a> 005 Docker通过EFK（Elasticsearch + Fluentd + Kibana）</h2> <p>https://www.cnblogs.com/xiao987334176/p/12376980.html</p> <h2 id="_006-基于docker-搭建prometheus-grafana"><a href="#_006-基于docker-搭建prometheus-grafana" class="header-anchor">#</a> 006 基于docker 搭建Prometheus+Grafana</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://www.cnblogs.com/xiao987334176/p/9930517.html
<span class="token comment">## 几点思考</span>
1、node 主机的自动发现，端口自动发现
2、redis 自动发现
3、mysql 自动发现
4、alertmanager 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h1 id="附：-tips"><a href="#附：-tips" class="header-anchor">#</a> 附： tips</h1> <h2 id="_001-时间格式化"><a href="#_001-时间格式化" class="header-anchor">#</a> 001 时间格式化</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> datetime
<span class="token comment">#获得当前时间</span>
now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">-</span><span class="token operator">&gt;</span>这是时间数组格式
<span class="token comment">#转换为指定的格式:</span>
otherStyleTime <span class="token operator">=</span> now<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y%m%d_%H%M%S&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> time
now_time <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span><span class="token punctuation">)</span>

<span class="token comment">## bash</span>
Now_Time<span class="token operator">=</span>`<span class="token punctuation">(</span>date <span class="token operator">+</span><span class="token operator">%</span>Y<span class="token operator">%</span>m<span class="token operator">%</span>d<span class="token operator">%</span>H<span class="token operator">%</span>M<span class="token operator">%</span>S<span class="token punctuation">)</span>`
NowStamp<span class="token operator">=</span>`<span class="token punctuation">(</span>date <span class="token operator">+</span><span class="token operator">%</span>s<span class="token punctuation">)</span>`
echo <span class="token string">&quot;当前时间和当前时间戳&quot;</span> $Now_Time $NowStamp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_002-check-url-sh"><a href="#_002-check-url-sh" class="header-anchor">#</a> 002 check_url.sh</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">####################################################</span>
<span class="token comment"># Author: channel</span>
<span class="token comment"># Github: https://github.com/yes5144</span>
<span class="token comment"># Time: 2018-03-10 16:05:56# Version: V1.0</span>
<span class="token comment"># Description: This is just a test scripts</span>
<span class="token comment">####################################################</span>
<span class="token builtin class-name">.</span> /etc/init.d/functions
<span class="token assign-left variable">check_count</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">url_list</span><span class="token operator">=</span><span class="token punctuation">(</span>http://www.baidu.com http://192.168.204.123 http://www.google.cn<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function-name function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> -n <span class="token string">'after 3 seconds, check url.'</span>
    <span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">))</span></span>
    <span class="token keyword">do</span>
        <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;.&quot;</span><span class="token punctuation">;</span> <span class="token function">sleep</span> <span class="token number">1</span>
    <span class="token keyword">done</span>
    <span class="token builtin class-name">echo</span> <span class="token string">''</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-name function">check_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">wait</span>
    <span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>`echo ${#url_list[<span class="token operator">*</span>]}`<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span>
    <span class="token keyword">do</span>
        <span class="token function">wget</span> -o /dev/null -T <span class="token number">3</span> --tries<span class="token operator">=</span><span class="token number">1</span> --spider <span class="token variable">${url_list<span class="token punctuation">[</span>$i<span class="token punctuation">]</span>}</span> <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span>
        <span class="token keyword">then</span>
            action <span class="token string">&quot;<span class="token variable">${url_list<span class="token punctuation">[</span>$i<span class="token punctuation">]</span>}</span>&quot;</span> /bin/true
        <span class="token keyword">else</span>
            action <span class="token string">&quot;<span class="token variable">${url_list<span class="token punctuation">[</span>$i<span class="token punctuation">]</span>}</span>&quot;</span> /bin/false
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    <span class="token builtin class-name">echo</span> <span class="token string">''</span>
    <span class="token variable"><span class="token punctuation">((</span>check_count<span class="token operator">++</span><span class="token punctuation">))</span></span>
<span class="token punctuation">}</span>

<span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token boolean">true</span>
    <span class="token keyword">do</span>
        check_url
        <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[32m------- check count: <span class="token variable">${check_count}</span>-------<span class="token entity" title="\033">\033</span>[0m&quot;</span>
        <span class="token function">sleep</span> <span class="token number">10</span>
    <span class="token keyword">done</span>
<span class="token punctuation">}</span>

main

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="_003-正则表达式（样例）"><a href="#_003-正则表达式（样例）" class="header-anchor">#</a> 003 正则表达式（样例）</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## sed正则表达式</span>
<span class="token function">sed</span> -e <span class="token string">'s/:\+\s\+/:/'</span> -e <span class="token string">'s/ /_/g'</span> -e <span class="token string">'/^$/d'</span> -e <span class="token string">'s/[(%)]//g'</span> -e <span class="token string">'/^1/d'</span> -e <span class="token string">'s/[(*)]//g'</span> /tmp/<span class="token variable">${RAND}</span>.sql_out.temp <span class="token operator">&gt;</span> /tmp/<span class="token variable">${RAND}</span>.sql_out.temp.1
<span class="token comment">## 后面还有一行：</span>
<span class="token function">sed</span> -ni <span class="token string">'H;<span class="token variable">${x;s<span class="token operator">/</span>\n<span class="token operator">/</span> <span class="token operator">/</span>g;p}</span>'</span> /tmp/<span class="token variable">${RAND}</span>.sql_out.temp.1 

-e <span class="token string">'s/:\+\s\+/:/'</span> -e <span class="token string">'s/ /_/g'</span> 把每一行 第一次出现的 <span class="token string">&quot;连续 n 个 : 及 后面的m个空格&quot;</span> 替换成 <span class="token builtin class-name">:</span> , 再把这一行中剩余的类似匹配内容替换成 _ , 其中 n <span class="token operator">&gt;</span><span class="token operator">=</span> <span class="token number">1</span>, m<span class="token operator">&gt;</span><span class="token operator">=</span><span class="token number">1</span>
比如如果某行的内容是sss:: ppp: MMM则替换后变成sss:ppp_MMM

<span class="token comment">## 然后</span>
-e <span class="token string">'/^$/d'</span>删除空行
<span class="token comment">## 然后</span>
-e <span class="token string">'s/[(%)]//g'</span> 把每行出现的 <span class="token punctuation">(</span> 或者 % 或者 <span class="token punctuation">)</span> 字符全部删除,
比如abc<span class="token punctuation">(</span><span class="token punctuation">)</span>% 被替换成 abc
<span class="token comment">## 然后</span>
-e <span class="token string">'/^1/d'</span> 将 以字符 <span class="token number">1</span> 开头的行删除
<span class="token comment">## 最后</span>
-e <span class="token string">'s/[(*)]//'</span>把每行第一次出现的 <span class="token punctuation">(</span> 或者 * 或者 <span class="token punctuation">)</span> 字符删除.

注意,上面的每一个 -e 命令处理的对象都是前一条 -e 命令处理完后的结果.
所以假定有一个文件内容为
abc <span class="token comment">#unchanged line</span>
sss:: ppp: <span class="token punctuation">(</span>M%MM<span class="token punctuation">)</span>zzz :::: end <span class="token comment"># change to sss:ppp_MMMzzz_end</span>
1me <span class="token comment">#this line will be deleted</span>
<span class="token number">2123</span><span class="token punctuation">(</span>* <span class="token comment">#change to 2123</span>
end of <span class="token function">file</span> <span class="token comment">#unchanged</span>

<span class="token comment">## 经过上面的命令后,变成</span>
abc <span class="token comment">#unchanged line</span>
sss:ppp_M%MMzzz _end <span class="token comment"># change to sss:ppp_MMMzzz _end</span>
<span class="token number">2123</span> <span class="token comment">#change to 2123</span>
end of <span class="token function">file</span> <span class="token comment">#unchanged</span>



<span class="token assign-left variable">Now_Time</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>date +%Y%m%d%H%M%S<span class="token punctuation">)</span><span class="token variable">`</span></span>
<span class="token assign-left variable">NowStamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>date +%s<span class="token punctuation">)</span><span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;当前时间和当前时间戳&quot;</span> <span class="token variable">$Now_Time</span> <span class="token variable">$NowStamp</span>

<span class="token comment">#grep</span>
<span class="token function">grep</span> -E <span class="token string">'([0-9]{1,}\.){3,}([0-9]{1,})'</span> version*.txt  --color
<span class="token comment">#sed</span>
<span class="token function">sed</span> -i <span class="token string">&quot;s/\(\([0-9]\{1,\}\.\)\{3,\}\)\([0-9]\{1,\}\)/<span class="token entity" title="\1">\1</span><span class="token variable">${Now_Time}</span>/g&quot;</span> version*.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="_004-sh-echo-colorful-sh"><a href="#_004-sh-echo-colorful-sh" class="header-anchor">#</a> 004 sh_echo_colorful.sh</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function-name function">echo_r</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span> <span class="token variable">$#</span> -ne <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">return</span> <span class="token number">0</span>
    <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[31m<span class="token variable">$1</span><span class="token entity" title="\033">\033</span>[0m&quot;</span>
<span class="token punctuation">}</span>
<span class="token function-name function">echo_g</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span> <span class="token variable">$#</span> -ne <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">return</span> <span class="token number">0</span>
    <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[32m<span class="token variable">$1</span><span class="token entity" title="\033">\033</span>[0m&quot;</span>
<span class="token punctuation">}</span>
<span class="token function-name function">echo_y</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span> <span class="token variable">$#</span> -ne <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">return</span> <span class="token number">0</span>
    <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[33m<span class="token variable">$1</span><span class="token entity" title="\033">\033</span>[0m&quot;</span>
<span class="token punctuation">}</span>
<span class="token function-name function">echo_b</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span> <span class="token variable">$#</span> -ne <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">return</span> <span class="token number">0</span>
    <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[34m<span class="token variable">$1</span><span class="token entity" title="\033">\033</span>[0m&quot;</span>
<span class="token punctuation">}</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PS1</span></span><span class="token operator">=</span><span class="token string">&quot;\[<span class="token variable"><span class="token variable">$(</span>tput bold<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>tput setab <span class="token number">0</span><span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>tput setaf <span class="token number">1</span><span class="token variable">)</span></span>\][\u@\h \W]# \[<span class="token variable"><span class="token variable">$(</span>tput sgr0<span class="token variable">)</span></span>\]&quot;</span>

<span class="token assign-left variable"><span class="token environment constant">PS1</span></span><span class="token operator">=</span><span class="token string">'\[<span class="token entity" title="\e">\e</span>[37;1m\][\[<span class="token entity" title="\e">\e</span>[31;1m\]\u\[<span class="token entity" title="\e">\e</span>[34;1m\]@\[<span class="token entity" title="\e">\e</span>[32;1m\]\h \[<span class="token entity" title="\e">\e</span>[31;1m\]\w \[<span class="token entity" title="\e">\e</span>[33;1m\]<span class="token entity" title="\t">\t</span>\[<span class="token entity" title="\e">\e</span>[37;1m\]]\[<span class="token entity" title="\e">\e</span>[32;1m\]\$ \[<span class="token entity" title="\e">\e</span>[m\]'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_004-shell-log"><a href="#_004-shell-log" class="header-anchor">#</a> 004 shell log</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#/bin/bash</span>
<span class="token assign-left variable">sys_log</span><span class="token operator">=</span><span class="token string">&quot;./test_log.log&quot;</span>

<span class="token comment"># func of log</span>
<span class="token comment">#定义了三个级别的日志</span>

<span class="token keyword">function</span> <span class="token function-name function">log_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">format_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">`</span></span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">para</span><span class="token operator">=</span><span class="token variable">$1</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${format_date}</span> [info] <span class="token variable">$1</span>&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$sys_log</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-name function">log_warn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">format_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">`</span></span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">para</span><span class="token operator">=</span><span class="token variable">$1</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${format_date}</span> [warn] <span class="token variable">$1</span>&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$sys_log</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-name function">log_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">format_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">`</span></span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">para</span><span class="token operator">=</span><span class="token variable">$1</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${format_date}</span> [err] <span class="token variable">$1</span>&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$sys_log</span>
<span class="token punctuation">}</span>

<span class="token comment">#log_err &quot;wo shi err&quot;</span>
<span class="token comment">#log_info &quot;wo shi info info&quot;</span>
<span class="token comment">#log_warn &quot;wo shi warn&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="_005-wireshark和fiddler抓包"><a href="#_005-wireshark和fiddler抓包" class="header-anchor">#</a> 005 wireshark和Fiddler抓包</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>Fiddler是在windows上运行的程序，专门用来捕获HTTP，HTTPS的。

wireshark能获取HTTP，也能获取HTTPS，但是不能解密HTTPS，所以wireshark看不懂HTTPS中的内容

总结，如果是处理HTTP,HTTPS 还是用Fiddler,  其他协议比如TCP,UDP 就用wireshark
https://www.cnblogs.com/TankXiao/archive/2012/10/10/2711777.html
https://www.cnblogs.com/TankXiao/archive/2012/02/06/2337728.html

https://my.oschina.net/u/658658/blog/417739

<span class="token comment">## Wireshark抓包分析——TCP/IP协议https://zhuanlan.zhihu.com/p/53338327</span>
<span class="token comment">## Fiddler抓取Android真机上的HTTPS包https://www.cnblogs.com/taojietx/p/7286703.html</span>
<span class="token comment">## Fiddler抓包工具总结https://www.cnblogs.com/yyhh/p/5140852.htmlhttps://www.dell.com/community/%E7%BB%BC%E5%90%88%E8%AE%A8%E8%AE%BA%E5%8C%BA/%E7%BD%91%E7%BB%9C%E5%9F%BA%E6%9C%AC%E5%8A%9F%E7%B3%BB%E5%88%97-%E7%BB%86%E8%AF%B4%E7%BD%91%E7%BB%9C%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF-3%E6%9C%8826%E6%97%A5%E6%9B%B4%E6%96%B0/td-p/7045185</span>

<span class="token comment">## wireshark包过滤</span>
<span class="token constant">ip.src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>192.168.1.102 or ip.dst==192.168.1.102</span>

1 过滤IP，如来源IP或者目标IP等于某个IP
如前面说的例子： ip.src<span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>192.168.1.102 or ip.dst==192.168.1.102</span>
比如TCP，只显示TCP协议。
2 过滤端口
<span class="token constant">tcp.dstport</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> 80 // 只显tcp协议的目标端口80</span>
<span class="token constant">tcp.srcport</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> 80 // 只显tcp协议的来源端口80</span>
也可以写成tcp.port eq 80 or udp.port eq 80 这样的模式
3 过滤协议
单独写上tcp、udp、xml、http就可以过滤出具体协议的报文。你也可以用tcp or xml这样格式来过滤。
<span class="token constant">我们还可以更加具体过滤协议的内容，如tcp.flags.syn</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> 0x02 表示显示包含TCP SYN标志的封包。</span>
4 过滤mac地址
eth.src eq A0:00:00:04:C5:84 // 过滤来源mac地址
<span class="token constant">eth.dst</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>A0:00:00:04:C5:84 // 过滤目的mac地址</span>
5 http模式过滤
<span class="token constant">http.request.method</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;GET&quot;</span>
<span class="token constant">http.request.method</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;POST&quot;</span>
<span class="token constant">http.request.uri</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;/img/logo-edu.gif&quot;</span>
http contains &quot;GET&quot;
http contains &quot;HTTP/1.&quot;
// GET包
<span class="token constant">http.request.method</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;GET&quot; &amp;&amp; http contains &quot;Host: &quot;</span>
<span class="token constant">http.request.method</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;GET&quot; &amp;&amp; http contains &quot;User-Agent: &quot;</span>
// POST包
<span class="token constant">http.request.method</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;POST&quot; &amp;&amp; http contains &quot;Host: &quot;</span>
<span class="token constant">http.request.method</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> &quot;POST&quot; &amp;&amp; http contains &quot;User-Agent: &quot;</span>
// 响应包
http contains &quot;HTTP/1.1 200 OK&quot; &amp;&amp; http contains &quot;Content-Type: &quot;
http contains &quot;HTTP/1.0 200 OK&quot; &amp;&amp; http contains &quot;Content-Type: &quot;
6 过滤内容
contains：包含某字符串
<span class="token constant">ip.src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>192.168.1.107 and udp contains 02:12:21:00:22</span>
<span class="token constant">ip.src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>192.168.1.107 and tcp contains &quot;GET&quot;</span>
前面也有例子，http contains &quot;HTTP/1.0 200 OK&quot; &amp;&amp; http contains &quot;Content-Type: &quot;

https://blog.csdn.net/u014530704/article/details/78842000

<span class="token comment">## 抓包</span>
tcpdump -i ens33  host gc.hgame.com

https://blog.csdn.net/weixin_40576010/article/details/99335491
https://www.cnblogs.com/centos2017/p/7896658.html

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="_005-抓包mimtproxy"><a href="#_005-抓包mimtproxy" class="header-anchor">#</a> 005 抓包mimtproxy</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://www.cnblogs.com/ITXiaoAng/p/11777060.html#%E4%B8%89%EF%BC%9A%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7mitmproxy%E5%85%8D%E8%B4%B9%E7%9A%84

https://www.cnblogs.com/grandlulu/p/9525417.html

https://blog.csdn.net/freeking101/article/details/83901842

https://www.jianshu.com/p/0eb46f21fee9
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_005-tcpdump命令"><a href="#_005-tcpdump命令" class="header-anchor">#</a> 005 tcpdump命令</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>tcpdump -i eth0 -s <span class="token number">0</span> -l
tcpdump -i eth0 -s <span class="token number">0</span> -l -w - <span class="token operator">|</span>strings

tcpdump -i ens33  <span class="token function">host</span> gc.hgame.com
tcpdump -i eth0 -s <span class="token number">0</span> -l -w a.pcap src <span class="token function">host</span> <span class="token number">192.168</span>.2.191 or dst <span class="token function">host</span> <span class="token number">192.168</span>.2.191 

<span class="token comment">####</span>
<span class="token comment">## 1.3 常用场景</span>

<span class="token comment">### 1、获取10.1.85.21和10.1.85.19之间的通信，使用命令注意转义符号。</span>
tcpdump <span class="token function">host</span> <span class="token number">10.1</span>.85.21 and <span class="token punctuation">\</span><span class="token punctuation">(</span> <span class="token number">10.1</span>.85.19<span class="token punctuation">\</span><span class="token punctuation">)</span> -i ens5f0 -nn -c <span class="token number">10</span>

<span class="token comment">### 2、获取从10.1.85.21发来的包。</span>
tcpdump src <span class="token function">host</span> <span class="token number">10.1</span>.85.21 -c <span class="token number">10</span> -i ens5f1

<span class="token comment">### 3、监听tcp（udp）端口。</span>
tcpdump tcp port <span class="token number">22</span> -c <span class="token number">10</span>

<span class="token comment">### 4、获取主机10.1.85.21和除10.1.85.19之外所有主机的通信。</span>
tcpdump <span class="token function">ip</span> <span class="token function">host</span> <span class="token number">10.1</span>.85.21 and <span class="token operator">!</span> <span class="token number">10.1</span>.85.19 -c <span class="token number">10</span> -i any

<span class="token comment">### 5、获取从10.1.85.19且端口主机到10.1.85.21主机的通信。</span>

tcpdump src <span class="token function">host</span> <span class="token number">10.1</span>.85.19 and src port <span class="token number">48565</span> and dst <span class="token function">host</span> <span class="token number">10.1</span>.85.21 and dst port <span class="token number">5090</span> -i any -c <span class="token number">10</span> -nn


<span class="token comment">#################3</span>
<span class="token comment">### 6、抓取所有经过 en0，目的或源地址是 10.37.63.255 的网络数据：</span>
tcpdump -i en0 <span class="token function">host</span> <span class="token number">10.37</span>.63.255

<span class="token comment">### 7、抓取主机10.37.63.255和主机10.37.63.61或10.37.63.95的通信：</span>
tcpdump <span class="token function">host</span> <span class="token number">10.37</span>.63.255 and <span class="token punctuation">\</span><span class="token punctuation">(</span><span class="token number">10.37</span>.63.61 or <span class="token number">10.37</span>.63.95 <span class="token punctuation">\</span><span class="token punctuation">)</span>

<span class="token comment">### 8、抓取主机192.168.13.210除了和主机10.37.63.61之外所有主机通信的数据包：</span>
tcpdump -n <span class="token function">host</span> <span class="token number">10.37</span>.63.255 and <span class="token operator">!</span> <span class="token number">10.37</span>.63.61

<span class="token comment">### 9、抓取主机10.37.63.255除了和主机10.37.63.61之外所有主机通信的ip包</span>
tcpdump <span class="token function">ip</span> -n <span class="token function">host</span> <span class="token number">10.37</span>.63.255 and <span class="token operator">!</span> <span class="token number">10.37</span>.63.61

<span class="token comment">### 10、抓取主机10.37.63.3发送的所有数据：</span>
tcpdump -i en0 src <span class="token function">host</span> <span class="token number">10.37</span>.63.3 （注意数据流向）

<span class="token comment">### 11、抓取主机10.37.63.3接收的所有数据：</span>
tcpdump -i en0 dst <span class="token function">host</span> <span class="token number">10.37</span>.63.3 （注意数据流向） 

<span class="token comment">### 12、抓取主机10.37.63.3所有在TCP 80端口的数据包：</span>
tcpdump -i en0 <span class="token function">host</span> <span class="token number">10.37</span>.63.3 and tcp port <span class="token number">80</span>

<span class="token comment">### 13、抓取HTTP主机10.37.63.3在80端口接收到的数据包：</span>
tcpdump -i en0 <span class="token function">host</span> <span class="token number">10.37</span>.63.3 and dst port <span class="token number">80</span>

<span class="token comment">### 14、抓取所有经过 en0，目的或源端口是 25 的网络数据</span>
tcpdump -i en0 port <span class="token number">25</span>
tcpdump -i en0 src port <span class="token number">25</span> <span class="token comment"># 源端口</span>
tcpdump -i en0 dst port <span class="token number">25</span>网络过滤 <span class="token comment"># 目的端口</span>

<span class="token comment">### 15、抓取所有经过 en0，网络是 192.168上的数据包</span>
tcpdump -i en0 net <span class="token number">192.168</span>
tcpdump -i en0 src net <span class="token number">192.168</span>
tcpdump -i en0 dst net <span class="token number">192.168</span>
tcpdump -i en0 net <span class="token number">192.168</span>.1
tcpdump -i en0 net <span class="token number">192.168</span>.1.0/24

<span class="token comment">### 16、协议过滤</span>
tcpdump -i en0 arp
tcpdump -i en0 <span class="token function">ip</span>
tcpdump -i en0 tcp
tcpdump -i en0 udp
tcpdump -i en0 icmp

<span class="token comment">### 17、抓取所有经过 en0，目的地址是 192.168.1.254 或 192.168.1.200 端口是 80 的 TCP 数据</span>
tcpdump -i en0 <span class="token string">'<span class="token variable"><span class="token punctuation">((</span>tcp<span class="token punctuation">)</span> and <span class="token punctuation">(</span>port <span class="token number">80</span><span class="token punctuation">)</span> and <span class="token punctuation">((</span>dst host <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.254</span><span class="token punctuation">)</span> or <span class="token punctuation">(</span>dst host <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.200</span><span class="token punctuation">))</span></span>)'</span>

<span class="token comment">### 18、抓取所有经过 en0，目标 MAC 地址是 00:01:02:03:04:05 的 ICMP 数据</span>
tcpdump -i eth1 <span class="token string">'<span class="token variable"><span class="token punctuation">((</span>icmp<span class="token punctuation">)</span> and <span class="token punctuation">((</span>ether dst host <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">))</span></span>)'</span>

<span class="token comment">### 19、抓取所有经过 en0，目的网络是 192.168，但目的主机不是 192.168.1.200 的 TCP 数据</span>
tcpdump -i en0 <span class="token string">'<span class="token variable"><span class="token punctuation">((</span>tcp<span class="token punctuation">)</span> and <span class="token punctuation">((</span>dst net <span class="token number">192.168</span><span class="token punctuation">)</span> and <span class="token punctuation">(</span>not dst host <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.200</span><span class="token punctuation">))</span></span>)'</span>

<span class="token comment">### 20、只抓 SYN 包</span>
tcpdump -i en0 <span class="token string">'tcp[tcpflags] = tcp-syn'</span>

<span class="token comment">### 21、抓 SYN, ACK</span>
tcpdump -i en0 <span class="token string">'tcp[tcpflags] &amp; tcp-syn != 0 and tcp[tcpflags] &amp; tcp-ack != 0'</span>

<span class="token comment">### 22、抓 SMTP 数据，抓取数据区开始为&quot;MAIL&quot;的包，&quot;MAIL&quot;的十六进制为 0x4d41494c</span>
tcpdump -i en0 <span class="token string">'<span class="token variable"><span class="token punctuation">((</span>port <span class="token number">25</span><span class="token punctuation">)</span> and <span class="token punctuation">(</span>tcp[<span class="token punctuation">(</span>tcp[<span class="token number">12</span>]<span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">4</span>] <span class="token operator">=</span> <span class="token number">0x4d41494c</span><span class="token punctuation">))</span></span>'</span>

<span class="token comment">### 23、抓 HTTP GET 数据，&quot;GET &quot;的十六进制是 0x47455420</span>
tcpdump -i en0 <span class="token string">'tcp[(tcp[12]&gt;&gt;2):4] = 0x47455420'</span>

<span class="token comment"># 0x4745 为&quot;GET&quot;前两个字母&quot;GE&quot;,0x4854 为&quot;HTTP&quot;前两个字母&quot;HT&quot;</span>
tcpdump  -XvvennSs <span class="token number">0</span> -i en0 tcp<span class="token punctuation">[</span><span class="token number">20</span>:2<span class="token punctuation">]</span><span class="token operator">=</span>0x4745 or tcp<span class="token punctuation">[</span><span class="token number">20</span>:2<span class="token punctuation">]</span><span class="token operator">=</span>0x4854

<span class="token comment">### 24、抓 SSH 返回，&quot;SSH-&quot;的十六进制是 0x5353482D</span>
tcpdump -i en0 <span class="token string">'tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D'</span>

<span class="token comment"># 抓老版本的 SSH 返回信息，如&quot;SSH-1.99..&quot;</span>
tcpdump -i en0 <span class="token string">'(tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D) and (tcp[((tcp[12]&gt;&gt;2)+4):2] = 0x312E)'</span>

<span class="token comment">### 25、抓 DNS 请求数据</span>
tcpdump -i en0 udp dst port <span class="token number">53</span>

<span class="token comment">### 26、用-c 参数指定抓多少个包</span>
<span class="token function">time</span> tcpdump -nn -i en0 <span class="token string">'tcp[tcpflags] = tcp-syn'</span> -c <span class="token number">10000</span> <span class="token operator">&gt;</span> /dev/null

上面的命令计算抓 <span class="token number">10000</span> 个 SYN 包花费多少时间，可以判断访问量大概是多少。

<span class="token comment">### 27、实时抓取端口号8000的GET包，然后写入GET.log</span>
tcpdump -i en0 <span class="token string">'<span class="token variable"><span class="token punctuation">((</span>port <span class="token number">8000</span><span class="token punctuation">)</span> and <span class="token punctuation">(</span>tcp[<span class="token punctuation">(</span>tcp[<span class="token number">12</span>]<span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">4</span>]<span class="token operator">=</span><span class="token number">0x47455420</span><span class="token punctuation">))</span></span>'</span> -nnAl -w /tmp/GET.log

作者：道无虚
链接：https://www.jianshu.com/p/23427a80fc9d

作者：猿码架构
链接：https://www.jianshu.com/p/a62ed1bb5b20

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><h2 id="_006"><a href="#_006" class="header-anchor">#</a> 006</h2> <h2 id="_007-压测"><a href="#_007-压测" class="header-anchor">#</a> 007 压测</h2> <h3 id="_007-redis压测"><a href="#_007-redis压测" class="header-anchor">#</a> 007 redis压测</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## redis压测</span>
redis-cli --latency -h <span class="token variable"><span class="token variable">`</span><span class="token function">host</span><span class="token variable">`</span></span> -p <span class="token variable"><span class="token variable">`</span>port<span class="token variable">`</span></span>
redis-cli --latency -h <span class="token number">10.10</span>.10.210 -p <span class="token number">7379</span>

INFO commandstats 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_007-nginx压测"><a href="#_007-nginx压测" class="header-anchor">#</a> 007 nginx压测</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>bin/wrk -c30 -t1 -s conf/nginx_log.lua http://localhost:8095

ab -n <span class="token number">1000</span> -c <span class="token number">100</span> http://www.load_balance.com/buy/ticket

<span class="token comment">## 配置负载均衡</span>
upstream load_rule <span class="token punctuation">{</span>
       server <span class="token number">127.0</span>.0.1:3001 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
       server <span class="token number">127.0</span>.0.1:3002 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
       server <span class="token number">127.0</span>.0.1:3003 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
       server <span class="token number">127.0</span>.0.1:3004 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">..</span>.
server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  load_balance.com www.load_balance.com<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
       proxy_pass http://load_rule<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

统计日志中的结果，3001-3004 端口分别得到了 <span class="token number">100</span>、200、300、400 的请求量。这和我在 Nginx 中配置的权重占比很好的吻合在了一起，并且负载后的流量非常的均匀、随机。


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_008-虚拟内存使用排行"><a href="#_008-虚拟内存使用排行" class="header-anchor">#</a> 008 虚拟内存使用排行</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">cd</span> /proc<span class="token punctuation">;</span><span class="token function">ls</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token string">&quot;^[0-9]&quot;</span><span class="token operator">|</span><span class="token function">awk</span> <span class="token string">' <span class="token variable">$0</span> &gt;100'</span><span class="token variable">`</span></span> <span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">awk</span> <span class="token string">'/Swap:/{a=a+<span class="token variable">$2</span>}END{print '</span>&quot;<span class="token variable">$i</span><span class="token string">&quot;',a/1024&quot;</span>M<span class="token string">&quot;}' /proc/<span class="token variable">$i</span>/smaps ;done |sort -k2nr|head

for file in /proc/*/status ; do awk '/VmSwap|Name|^Pid/{printf <span class="token variable">$2</span> &quot;</span> <span class="token string">&quot; <span class="token variable">$3</span>}END{ print &quot;</span>&quot;<span class="token punctuation">}</span>' <span class="token variable">$file</span><span class="token punctuation">;</span> <span class="token keyword">done</span> <span class="token operator">|</span> <span class="token function">sort</span> -k <span class="token number">3</span> -n -r <span class="token operator">|</span> <span class="token function">head</span>


<span class="token function">free</span> -m

<span class="token function">sync</span>

<span class="token builtin class-name">echo</span> <span class="token number">3</span> <span class="token operator">&gt;</span> /proc/sys/vm/drop_caches

<span class="token function">free</span> -m

swapoff -a

<span class="token function">free</span> -m

<span class="token function">swapon</span> -a

<span class="token function">free</span> -m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="_009-linux端口预留"><a href="#_009-linux端口预留" class="header-anchor">#</a> 009 Linux端口预留</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 预留端口避免占用ip_local_reserved_ports</span>
<span class="token assign-left variable">bl_ports</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">egrep</span> -o <span class="token string">'=[0-9]{4,5}$'</span>  /opt/www/*/*gs*/*server.conf <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'='</span> <span class="token string">'{print <span class="token variable">$NF</span>}'</span> <span class="token operator">|</span><span class="token function">sort</span> -n <span class="token operator">|</span><span class="token function">uniq</span> <span class="token operator">|</span><span class="token function">xargs</span> <span class="token builtin class-name">echo</span> <span class="token operator">|</span><span class="token function">sed</span> <span class="token string">'s/ /,/g'</span><span class="token variable">`</span></span>
sysctl -w net.ipv4.ip_local_reserved_ports<span class="token operator">=</span><span class="token variable">$bl_ports</span>


sysctl -w net.ipv4.ip_local_reserved_ports<span class="token operator">=</span><span class="token number">11181,11281</span>,12182
<span class="token builtin class-name">echo</span> <span class="token string">&quot;39003&quot;</span>  <span class="token operator">&gt;</span> /proc/sys/net/ipv4/ip_local_reserved_ports
<span class="token builtin class-name">echo</span> <span class="token string">&quot;39003,39004&quot;</span> <span class="token operator">&gt;</span>  /proc/sys/net/ipv4/ip_local_reserved_ports
<span class="token builtin class-name">echo</span> <span class="token string">&quot;39003-39004&quot;</span>  <span class="token operator">&gt;</span> /proc/sys/net/ipv4/ip_local_reserved_ports
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_010-清空memcache"><a href="#_010-清空memcache" class="header-anchor">#</a> 010 清空memcache</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## 清空memcache</span>
<span class="token comment">### https://blog.csdn.net/hadeys/article/details/6217472</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;flush_all&quot;</span> <span class="token operator">|</span> <span class="token function">nc</span> localhost <span class="token number">11211</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_011-redis-数据持久化"><a href="#_011-redis-数据持久化" class="header-anchor">#</a> 011 redis 数据持久化</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## Redis 五大数据类型有：</span>
String 类型，Hash 类型，List 类型，Set 类型，Zset（Sortedset）类型。其中常用的是前三个


<span class="token comment">## 数据安全 aof, rdb</span>
https://www.cnblogs.com/itdragon/p/7906481.html
Redis 默认开启RDB持久化方式，在指定的时间间隔内，执行指定次数的写操作，则将内存中的数据写入到磁盘中。
RDB 持久化适合大规模的数据恢复但它的数据一致性和完整性较差。
Redis 需要手动开启AOF持久化方式，默认是每秒将写操作日志追加到AOF文件中。
AOF 的数据完整性比RDB高，但记录内容多了，会影响数据恢复的效率。
Redis 针对 AOF文件大的问题，提供重写的瘦身机制。
若只打算用Redis 做缓存，可以关闭持久化。
若打算使用Redis 的持久化。建议RDB和AOF都开启。其实RDB更适合做数据的备份，留一后手。AOF出问题了，还有RDB


<span class="token comment">## 内存淘汰策略</span>
实际上Redis定义了几种策略用来处理这种情况：
noeviction<span class="token punctuation">(</span>默认策略<span class="token punctuation">)</span>：对于写请求不再提供服务，直接返回错误（DEL请求和部分特殊请求除外）
allkeys-lru：从所有key中使用LRU算法进行淘汰
volatile-lru：从设置了过期时间的key中使用LRU算法进行淘汰
allkeys-random：从所有key中随机淘汰数据
volatile-random：从设置了过期时间的key中随机淘汰
volatile-ttl：在设置了过期时间的key中，根据key的过期时间进行淘汰，越早过期的越优先被淘汰

作者：千山qianshan
链接：https://juejin.im/post/6844903927037558792
来源：掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。


<span class="token comment">## 缓存雪崩， 缓存穿透， 缓存</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="_012-python常用pip模块"><a href="#_012-python常用pip模块" class="header-anchor">#</a> 012 python常用pip模块</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>cat  /root/.pip/pip.conf
<span class="token selector">[global]</span>
<span class="token constant">index-url</span> <span class="token attr-value"><span class="token punctuation">=</span> http://mirrors.aliyun.com/pypi/simple/</span>
<span class="token selector">[install]</span>
<span class="token constant">trusted-host</span><span class="token attr-value"><span class="token punctuation">=</span>mirrors.aliyun.com</span>

<span class="token comment">## 运维</span>
os, commands, subprocess, logging, Jinja2, PyMySQL, redis, 

<span class="token comment">## 爬虫</span>
requests, bs4, selenium, pyquery

<span class="token comment">## 框架</span>
django, flask, fastapi, 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_012-pip使用指定源"><a href="#_012-pip使用指定源" class="header-anchor">#</a> 012 pip使用指定源</h3> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>pip install flask

pip install -i http://pypi.douban.com/simple/ --trusted-host<span class="token attr-value"><span class="token punctuation">=</span>pypi.douban.com/simple ipython</span>

<span class="token comment">## linux 添加pip源</span>
cat  ~/.pip/pip.conf
<span class="token selector">[global]</span>
<span class="token constant">index-url</span> <span class="token attr-value"><span class="token punctuation">=</span> http://mirrors.aliyun.com/pypi/simple/</span>
<span class="token selector">[install]</span>
<span class="token constant">trusted-host</span><span class="token attr-value"><span class="token punctuation">=</span>mirrors.aliyun.com</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_013-npm-or-yarn"><a href="#_013-npm-or-yarn" class="header-anchor">#</a> 013 npm or yarn</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>https://www.cnblogs.com/xifengxiaoma/tag/vue/

https://www.cnblogs.com/xifengxiaoma/p/9533018.html
<span class="token function">npm</span> <span class="token function">install</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">yarn</span> <span class="token function">install</span>
<span class="token function">npm</span> <span class="token function">install</span> --save <span class="token punctuation">[</span>package<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">yarn</span> <span class="token function">add</span> <span class="token punctuation">[</span>package<span class="token punctuation">]</span>
<span class="token function">npm</span> <span class="token function">install</span> --save-dev <span class="token punctuation">[</span>package<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">yarn</span> <span class="token function">add</span> <span class="token punctuation">[</span>package<span class="token punctuation">]</span> --dev
<span class="token function">npm</span> <span class="token function">install</span> --global <span class="token punctuation">[</span>package<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">yarn</span> global <span class="token function">add</span> <span class="token punctuation">[</span>package<span class="token punctuation">]</span>
<span class="token function">npm</span> uninstall --save <span class="token punctuation">[</span>package<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">yarn</span> remove <span class="token punctuation">[</span>package<span class="token punctuation">]</span>
<span class="token function">npm</span> uninstall --save-dev <span class="token punctuation">[</span>package<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">yarn</span> remove <span class="token punctuation">[</span>package<span class="token punctuation">]</span>


<span class="token function">yarn</span> <span class="token function">add</span> sass-loader node-sass --dev

<span class="token operator">&lt;</span>style <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;scss&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>

<span class="token function">yarn</span> <span class="token function">add</span> mockjs --dev

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="_014-查看zip包里面的文件和大小"><a href="#_014-查看zip包里面的文件和大小" class="header-anchor">#</a> 014 查看zip包里面的文件和大小</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">import</span> zipfile
z <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span><span class="token string">&quot;test.zip&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> filename <span class="token keyword">in</span> z<span class="token punctuation">.</span>namelist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span> <span class="token string">'File:'</span><span class="token punctuation">,</span>filename<span class="token punctuation">,</span>
  <span class="token builtin">bytes</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>read<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
  <span class="token keyword">print</span> <span class="token string">'has'</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'bytes'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_015-日志切割logrotate"><a href="#_015-日志切割logrotate" class="header-anchor">#</a> 015 日志切割logrotate</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>rpm -qf  /etc/logrotate.conf
logrotate-3.7.8-26.el6_7.x86_64

/opt/log/nginx/*.log
{
    daily
    missingok
    rotate 1
    compress
    notifempty
    copytruncate
    dateext
    dateformat %Y-%m-%d
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_016-xxx"><a href="#_016-xxx" class="header-anchor">#</a> 016 xxx</h2> <h2 id="_017-xxx"><a href="#_017-xxx" class="header-anchor">#</a> 017 xxx</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_018-xxx"><a href="#_018-xxx" class="header-anchor">#</a> 018 xxx</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_019-获取git-commit-id"><a href="#_019-获取git-commit-id" class="header-anchor">#</a> 019 获取git commit id</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>https://blog.csdn.net/liurizhou/article/details/89234032

<span class="token function">git</span> log  --pretty<span class="token operator">=</span><span class="token string">&quot;%s&quot;</span>  -2

<span class="token function">git</span> log  --pretty<span class="token operator">=</span><span class="token string">&quot;%H&quot;</span>  -2
<span class="token function">git</span> log  --pretty<span class="token operator">=</span><span class="token string">&quot;%h&quot;</span>  -2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_020-访问url-分阶段展示耗时"><a href="#_020-访问url-分阶段展示耗时" class="header-anchor">#</a> 020 访问url 分阶段展示耗时</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># https://github.com/reorx/httpstat </span>
<span class="token comment"># 以前遇到了一台服务器请求某个api很慢，怀疑是dns但是没有证据，这下让他无处遁形</span>
<span class="token comment"># wget https://raw.githubusercontent.com/reorx/httpstat/master/httpstat.py</span>
pip <span class="token function">install</span> httpstat
python httpstat.py httpbin.org/get


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_021-mysql-binlog2sql-解析binlog"><a href="#_021-mysql-binlog2sql-解析binlog" class="header-anchor">#</a> 021 MySQL binlog2sql 解析binlog</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://github.com/danfengcao/binlog2sql

<span class="token comment">## </span>
https://github.com/danfengcao/binlog2sql/blob/master/example/mysql-flashback-priciple-and-practice.md

<span class="token comment">## records</span>
https://github.com/kennethreitz-archive/records
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_022-innodb-和myisam-不同点"><a href="#_022-innodb-和myisam-不同点" class="header-anchor">#</a> 022 InnoDB 和MyISAM 不同点</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>MyISAM与InnoDB 的区别（9个不同点）

1. InnoDB支持事务，MyISAM不支持，对于InnoDB每一条SQL语言都默认封装成事务，自动提交，这样会影响速度，所以最好把多条SQL语言放在begin和commit之间，组成一个事务； 

2. InnoDB支持外键，而MyISAM不支持。对一个包含外键的InnoDB表转为MYISAM会失败
5. Innodb不支持全文索引，而MyISAM支持全文索引，在涉及全文索引领域的查询效率上MyISAM速度更快高；PS：5.7以后的InnoDB支持全文索引了

6. MyISAM表格可以被压缩后进行查询操作
7. InnoDB支持表、行(默认)级锁，而MyISAM支持表级锁
8、InnoDB表必须有主键（用户没有指定的话会自己找或生产一个主键），而Myisam可以没有
9、Innodb存储文件有frm、ibd，而Myisam是frm、MYD、MYI
        Innodb：frm是表定义文件，ibd是数据文件
        Myisam：frm是表定义文件，myd是数据文件，myi是索引文件

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_023-mysql忘记密码"><a href="#_023-mysql忘记密码" class="header-anchor">#</a> 023 MySQL忘记密码</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>vim /etc/my.cnf
<span class="token selector">[mysqld]</span>
skip-grant-tables

<span class="token comment">### MySQL5.6</span>
UPDATE mysql.user SET Password <span class="token attr-value"><span class="token punctuation">=</span> password('123456') WHERE User = 'root' ; </span>
<span class="token comment">### MySQL5.7</span>
update mysql.user set authentication_string<span class="token attr-value"><span class="token punctuation">=</span>password('123qwe') where user='root' and Host = 'localhost';</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_024-mysql审计-yearning"><a href="#_024-mysql审计-yearning" class="header-anchor">#</a> 024  MySQL审计 yearning</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## https://www.jianshu.com/p/c9c3aaaf6e0b</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_025-waiting-for-table-flush-阻塞查询的问题"><a href="#_025-waiting-for-table-flush-阻塞查询的问题" class="header-anchor">#</a> 025 Waiting for table flush 阻塞查询的问题</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## https://blog.csdn.net/donghaixiaolongwang/article/details/76099697</span>
2、易引发这种情况的操作
慢查询+FLUSH TABLES tbl_name, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, orOPTIMIZE TABLE  这些操作。

例如：比如在mysqldump、innobackupex进行备份时就很有可能引发这种情况。

3、解决方案
找出慢查询kill掉，并进行SQL优化防止再次引发。

4、预防措施
在业务高峰期不要对数据库进行FLUSH TABLES tbl_name, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, orOPTIMIZE TABLE 这些操作。

备份、DDL语句等操作尽量避开业务高峰。
<span class="token comment">### </span>
SELECT CONCAT('kill  ',id,';') from PROCESSLIST WHERE state <span class="token attr-value"><span class="token punctuation">=</span>'updating' and (info like &quot;%xxxx_server_info%&quot; and info like &quot;update%&quot;) limit 50</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_026-mysql时间"><a href="#_026-mysql时间" class="header-anchor">#</a> 026 mysql时间</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## 1、当前日期</span>
select DATE_SUB(curdate(),INTERVAL 0 DAY) ;
<span class="token comment">## 2、明天日期</span>
select DATE_SUB(curdate(),INTERVAL -1 DAY) ;
<span class="token comment">## 3、昨天日期</span>
select DATE_SUB(curdate(),INTERVAL 1 DAY) ;
<span class="token comment">## 4、前一个小时时间</span>
select date_sub(now(), interval 1 hour);
<span class="token comment">## 5、后一个小时时间</span>
select date_sub(now(), interval -1 hour);
<span class="token comment">## 6、前30分钟时间</span>
select date_add(now(),interval -30 minute)
<span class="token comment">## 7、后30分钟时间</span>
select date_add(now(),interval 30 minute)
<span class="token comment">## 8、取得当天：</span>
SELECT curdate();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_027"><a href="#_027" class="header-anchor">#</a> 027</h2> <h2 id="_028"><a href="#_028" class="header-anchor">#</a> 028</h2> <h2 id="_029"><a href="#_029" class="header-anchor">#</a> 029</h2> <h2 id="_030"><a href="#_030" class="header-anchor">#</a> 030</h2> <h2 id="_031"><a href="#_031" class="header-anchor">#</a> 031</h2> <h2 id="_032"><a href="#_032" class="header-anchor">#</a> 032</h2> <h2 id="_033"><a href="#_033" class="header-anchor">#</a> 033</h2> <h2 id="_034"><a href="#_034" class="header-anchor">#</a> 034</h2> <h2 id="_035"><a href="#_035" class="header-anchor">#</a> 035</h2> <h2 id="_036"><a href="#_036" class="header-anchor">#</a> 036</h2> <h2 id="_037"><a href="#_037" class="header-anchor">#</a> 037</h2> <h2 id="_038"><a href="#_038" class="header-anchor">#</a> 038</h2> <h2 id="_039"><a href="#_039" class="header-anchor">#</a> 039</h2> <h2 id="_040"><a href="#_040" class="header-anchor">#</a> 040</h2> <h2 id="_041"><a href="#_041" class="header-anchor">#</a> 041</h2> <h2 id="_042"><a href="#_042" class="header-anchor">#</a> 042</h2> <h2 id="_043"><a href="#_043" class="header-anchor">#</a> 043</h2> <h2 id="_044"><a href="#_044" class="header-anchor">#</a> 044</h2> <h2 id="_045"><a href="#_045" class="header-anchor">#</a> 045</h2> <h2 id="_046"><a href="#_046" class="header-anchor">#</a> 046</h2> <h2 id="_047"><a href="#_047" class="header-anchor">#</a> 047</h2> <h2 id="_048"><a href="#_048" class="header-anchor">#</a> 048</h2> <h2 id="_049"><a href="#_049" class="header-anchor">#</a> 049</h2> <h2 id="_050-前端"><a href="#_050-前端" class="header-anchor">#</a> 050 前端</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## bootstrap</span>
https://www.runoob.com/bootstrap/bootstrap-affix-plugin.html
https://www.w3cschool.cn/bootstrap/html-css-bootstrap-radiobutton.html

<span class="token comment">## jQuery 加载 json 数据</span>
https://www.cnblogs.com/aademeng/articles/9788385.html

<span class="token comment">## jQuery 添加元素</span>
https://www.runoob.com/jquery/jquery-dom-set.html

<span class="token comment">## ant-design</span>
https://www.yuque.com/ant-design/course/wybhm9

<span class="token comment">## gin</span>
https://book.eddycjy.com/golang/gin/log.html

<span class="token comment">## vue</span>
https://github.com/opendigg/awesome-github-vue
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="_051-vue动态菜单"><a href="#_051-vue动态菜单" class="header-anchor">#</a> 051 vue动态菜单</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>## https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>woai3c<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11052975.</span>html

    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 动态菜单 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(item, index) in menuItems&quot;</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">&quot;index&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Submenu v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;item.children&quot;</span> <span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;index&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>template slot<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Icon <span class="token operator">:</span>size<span class="token operator">=</span><span class="token string">&quot;item.size&quot;</span> <span class="token operator">:</span>type<span class="token operator">=</span><span class="token string">&quot;item.type&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>span v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;isShowAsideTitle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(subItem, i) in item.children&quot;</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">&quot;index + i&quot;</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Submenu v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;subItem.children&quot;</span> <span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;index + '-' + i&quot;</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>template slot<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>Icon <span class="token operator">:</span>size<span class="token operator">=</span><span class="token string">&quot;subItem.size&quot;</span> <span class="token operator">:</span>type<span class="token operator">=</span><span class="token string">&quot;subItem.type&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>span v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;isShowAsideTitle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>subItem<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>MenuItem <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;menu-level-3&quot;</span> v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(threeItem, k) in subItem.children&quot;</span> <span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;threeItem.name&quot;</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">&quot;index + i + k&quot;</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>Icon <span class="token operator">:</span>size<span class="token operator">=</span><span class="token string">&quot;threeItem.size&quot;</span> <span class="token operator">:</span>type<span class="token operator">=</span><span class="token string">&quot;threeItem.type&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>span v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;isShowAsideTitle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>threeItem<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>MenuItem<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Submenu<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>MenuItem v<span class="token operator">-</span><span class="token keyword">else</span> v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;isShowAsideTitle&quot;</span> <span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;subItem.name&quot;</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>Icon <span class="token operator">:</span>size<span class="token operator">=</span><span class="token string">&quot;subItem.size&quot;</span> <span class="token operator">:</span>type<span class="token operator">=</span><span class="token string">&quot;subItem.type&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>span v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;isShowAsideTitle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>subItem<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>MenuItem<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Submenu<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>MenuItem v<span class="token operator">-</span><span class="token keyword">else</span> <span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;item.name&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Icon <span class="token operator">:</span>size<span class="token operator">=</span><span class="token string">&quot;item.size&quot;</span> <span class="token operator">:</span>type<span class="token operator">=</span><span class="token string">&quot;item.type&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>span v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;isShowAsideTitle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>MenuItem<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="_052"><a href="#_052" class="header-anchor">#</a> 052</h2> <h2 id="_053"><a href="#_053" class="header-anchor">#</a> 053</h2> <h2 id="_054"><a href="#_054" class="header-anchor">#</a> 054</h2> <h2 id="_055"><a href="#_055" class="header-anchor">#</a> 055</h2> <h2 id="_056"><a href="#_056" class="header-anchor">#</a> 056</h2> <h2 id="_057"><a href="#_057" class="header-anchor">#</a> 057</h2> <h2 id="_058"><a href="#_058" class="header-anchor">#</a> 058</h2> <h2 id="_059"><a href="#_059" class="header-anchor">#</a> 059</h2> <h2 id="_060-python-第三方包制作"><a href="#_060-python-第三方包制作" class="header-anchor">#</a> 060 python 第三方包制作</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## Python 第三方包制作教程</span>
https://www.cnblogs.com/streakingBird/p/4056765.html

https://www.jianshu.com/p/19f1e564a29d
https://www.cnblogs.com/panwenbin-logs/p/13219332.html
https://www.jianshu.com/p/c6055e8873ee

Django 中使用 ajax 请求的正确姿势

<span class="token comment">## git 0基础入门—git入门与实践（1）—详细图解git安装详情及超详细的入门介绍！（2020.06.30更新）</span>
https://blog.csdn.net/u013946061/article/details/107023191
git config --globe user.email “xxx@example.com”
--globe 代表全局设置，即设置一次就够了。
git config --globe user.name &quot;张三&quot;

git config --global -l

git commit -a -m &quot;描述&quot; 从工作目录提交到暂存区后，直接提交

<span class="token comment">## golang prometheus</span>
<span class="token comment">### Go开发属于自己的exporter</span>
https://blog.csdn.net/weixin_45413603/article/details/107024467
<span class="token comment">### 使用golang编写Prometheus Exporter</span>
https://blog.csdn.net/u014029783/article/details/80001251
<span class="token comment">### prometheus数据采集exporter全家桶</span>
https://blog.csdn.net/weixin_34212189/article/details/91673377

名称.(type)用于类型查询,
名称.(具体类型)用于类型转换

<span class="token comment">## Google Protobuf简明教程</span>
https://www.jianshu.com/p/b723053a86a6

<span class="token comment">## python 操作protobuf</span>
https://www.jianshu.com/p/091b99beb6bc

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="_061-python-is-和-区别"><a href="#_061-python-is-和-区别" class="header-anchor">#</a> 061 python 'is' 和 '==' 区别</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>https://www.cnblogs.com/CheeseZH/p/5260560.html

<span class="token constant">在讲is和</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>这两种运算符区别之前，首先要知道Python中对象包含的三个基本要素，分别是：id(身份标识)、type(数据类型)和value(值)。</span>
1, is 是进行id的比较，<span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> 是进行value的比较。</span>
2, 只有数值型情况下is和<span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span>可通用，当字符串中包含非数字或字母字符时，值比较就不能用is只能用==了。</span>

我们在检查 a is b 的时候，其实相当于检查 id(a) <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> id(b)。而检查 a == b 的时候，实际是调用了对象 a 的 __eq()__ 方法，a == b 相当于 a.__eq__(b)。</span>

Python里和None比较时，为什么是 is None 而不是 <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> None 呢？</span>

<span class="token constant">这是因为None在Python里是个单例对象，一个变量如果是None，它一定和None指向同一个内存地址。而</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">=</span> None背后调用的是__eq__，而__eq__可以被重载，下面是一个 is not None但 == None的例子</span>

连接字符串的时候可以用join也可以用+，但这两者有没有区别呢？
join的性能明显好于+。这是为什么呢？
而join在连接字符串的时候，会先计算需要多大的内存存放结果，然后一次性申请所需内存并将字符串复制过去，这是为什么join的性能优于+的原因。所以在连接字符串数组的时候，我们应考虑优先使用join。

https://zhuanlan.zhihu.com/p/93775624
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_061-python-深浅拷贝"><a href="#_061-python-深浅拷贝" class="header-anchor">#</a> 061 python 深浅拷贝</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>浅拷贝和深拷贝的区别是：浅拷贝只是将原对象在内存中引用地址拷贝

而深拷贝是将这个对象的所有内容拷贝过来了，包括值与内存地址
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_061-python闭包"><a href="#_061-python闭包" class="header-anchor">#</a> 061 python闭包</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># http://c.biancheng.net/view/5335.html</span>
不过使用闭包，可以让程序变得更简洁易读。
<span class="token comment"># https://zhuanlan.zhihu.com/p/22229197</span>
闭包：就是在一个外函数中定义了一个内函数，内函数里运用了外函数的临时变量，并且 外函数的返回值是内函数的引用。
闭包概念：在一个内部函数中，对外部作用域的变量进行引用，<span class="token punctuation">(</span>并且一般外部函数的返回值为内部函数<span class="token punctuation">)</span>，那么内部函数就被认为是闭包。
flist <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">xrange</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x<span class="token operator">*</span>i
    first<span class="token punctuation">.</span>append<span class="token punctuation">(</span>func<span class="token punctuation">)</span>

<span class="token keyword">for</span> f <span class="token keyword">in</span> flist<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 2</span>
flist<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">xrange</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">makefunc</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> x<span class="token operator">*</span>i
        <span class="token keyword">return</span> func
    flist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>makefunc<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> f <span class="token keyword">in</span> flist<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    
装饰器<span class="token punctuation">(</span>本质就是闭包<span class="token punctuation">)</span>：主要作用为已经存在的对象添加额外的功能，例如日志记录、数据校验等。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="_061-python-生成器和迭代器"><a href="#_061-python-生成器和迭代器" class="header-anchor">#</a> 061 python 生成器和迭代器</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
<span class="token comment">## 列表推导式</span>

<span class="token comment">## django 字典推导式</span>
<span class="token constant">kwargs</span> <span class="token attr-value"><span class="token punctuation">=</span>{key: request.POST.get(key) for key in (&quot;motto&quot;,&quot;region&quot;,&quot;pic&quot;) if request.POST.get(key)}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_061-python-魔法"><a href="#_061-python-魔法" class="header-anchor">#</a> 061 python 魔法</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>__init__我们很熟悉了,它在对象初始化的时候调用,我们一般将它理解为&quot;构造函数&quot;.

__new__

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_061-python-封装、继承和多态"><a href="#_061-python-封装、继承和多态" class="header-anchor">#</a> 061 python 封装、继承和多态</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>dd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_062-python-模块"><a href="#_062-python-模块" class="header-anchor">#</a> 062 python 模块</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">## </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_062-python多线-进程"><a href="#_062-python多线-进程" class="header-anchor">#</a> 062 python多线/进程</h4> <blockquote><p>在 Python 3.2 以后，concurrent.futures是内置的模块，我们可以直接使用。 如果你需要在 Python 2.7 中使用 concurrent.futures , 那么请用 pip 进行安装，</p> <p>pip install futures</p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">## https://www.cnblogs.com/huchong/p/7459324.html</span>

<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ProcessPoolExecutor
<span class="token keyword">import</span> os<span class="token punctuation">,</span>time<span class="token punctuation">,</span>random
<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s is running'</span> <span class="token operator">%</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> n<span class="token operator">**</span><span class="token number">2</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p<span class="token operator">=</span>ProcessPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#不填则默认为cpu的个数</span>
    l<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    start<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obj<span class="token operator">=</span>p<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>task<span class="token punctuation">,</span>i<span class="token punctuation">)</span>   <span class="token comment">#submit()方法返回的是一个future实例，要得到结果需要用obj.result()</span>
        l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">#类似用from multiprocessing import Pool实现进程池中的close及join一起的作用</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>    <span class="token comment"># print([obj for obj in l])</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>obj<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> obj <span class="token keyword">in</span> l<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span>
    
    <span class="token comment">#上面方法也可写成下面的方法</span>
    <span class="token comment"># start = time.time()</span>
    <span class="token comment"># with ProcessPoolExecutor() as p:   #类似打开文件,可省去.shutdown()</span>
    <span class="token comment">#     future_tasks = [p.submit(task, i) for i in range(10)]</span>
    <span class="token comment"># print('=' * 30)</span>
    <span class="token comment"># print([obj.result() for obj in future_tasks])</span>
    <span class="token comment"># print(time.time() - start)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_062-re模块"><a href="#_062-re模块" class="header-anchor">#</a> 062 re模块</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">## re</span>
<span class="token keyword">import</span> re
b <span class="token operator">=</span> <span class="token string">&quot;&lt;p&gt;我是测试文本&lt;br/&gt;&lt;/p&gt;&lt;p&gt;我是测试文本\n  \n&lt;br/&gt;&lt;/p&gt;&quot;</span>
c <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'&lt;[^&lt;]+?&gt;'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

d <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r'p&gt;(.*?)&lt;/p'</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_063-api的调用"><a href="#_063-api的调用" class="header-anchor">#</a> 063 API的调用</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">##</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_063-salt-api"><a href="#_063-salt-api" class="header-anchor">#</a> 063 salt-api</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_063-es-api"><a href="#_063-es-api" class="header-anchor">#</a> 063 es-api</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_063-zabbix-api"><a href="#_063-zabbix-api" class="header-anchor">#</a> 063 zabbix-api</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_064-shutil压缩处理"><a href="#_064-shutil压缩处理" class="header-anchor">#</a> 064 shutil压缩处理</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#shutil 对压缩包的处理是调用 ZipFile 和 TarFile 两个模块来进行的，详细：</span>

<span class="token comment">#zipfile 压缩解压</span>
<span class="token comment"># https://www.cnblogs.com/xiangsikai/p/7787101.html</span>

<span class="token function">import</span> zipfile

<span class="token comment"># 压缩</span>
z <span class="token operator">=</span> zipfile.ZipFile<span class="token punctuation">(</span><span class="token string">'laxi.zip'</span>, <span class="token string">'w'</span><span class="token punctuation">)</span>
z.write<span class="token punctuation">(</span><span class="token string">'a.log'</span><span class="token punctuation">)</span>
z.write<span class="token punctuation">(</span><span class="token string">'data.data'</span><span class="token punctuation">)</span>
z.close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 解压</span>
z <span class="token operator">=</span> zipfile.ZipFile<span class="token punctuation">(</span><span class="token string">'laxi.zip'</span>, <span class="token string">'r'</span><span class="token punctuation">)</span>
z.extractall<span class="token punctuation">(</span><span class="token punctuation">)</span>
z.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="_065"><a href="#_065" class="header-anchor">#</a> 065</h2> <h2 id="_066"><a href="#_066" class="header-anchor">#</a> 066</h2> <h2 id="_067"><a href="#_067" class="header-anchor">#</a> 067</h2> <h2 id="_068"><a href="#_068" class="header-anchor">#</a> 068</h2> <h2 id="_069"><a href="#_069" class="header-anchor">#</a> 069</h2> <h2 id="_070-golang"><a href="#_070-golang" class="header-anchor">#</a> 070 golang</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## aliyun tools</span>
https://help.aliyun.com/learn/tool.html

<span class="token comment">## Go类型专题总结</span>
https://blog.csdn.net/YongYu_IT/article/details/90711434

<span class="token comment">## Go的&amp;*</span>
https://blog.csdn.net/fujian9544/article/details/100110011

<span class="token comment">## Golang 中的指针 - Pointer</span>
https://blog.csdn.net/weixin_30323961/article/details/96412686

<span class="token comment">## [日常] Go语言圣经-Slice切片习题</span>
https://www.cnblogs.com/taoshihan/p/8797499.html

https://www.cnblogs.com/majianguo/p/8186429.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_071"><a href="#_071" class="header-anchor">#</a> 071</h2> <h2 id="_072"><a href="#_072" class="header-anchor">#</a> 072</h2> <h2 id="_073"><a href="#_073" class="header-anchor">#</a> 073</h2> <h2 id="_074"><a href="#_074" class="header-anchor">#</a> 074</h2> <h2 id="_075"><a href="#_075" class="header-anchor">#</a> 075</h2> <h2 id="_076"><a href="#_076" class="header-anchor">#</a> 076</h2> <h2 id="_077"><a href="#_077" class="header-anchor">#</a> 077</h2> <h2 id="_078"><a href="#_078" class="header-anchor">#</a> 078</h2> <h2 id="_079"><a href="#_079" class="header-anchor">#</a> 079</h2> <h2 id="_080-jvm内存优化"><a href="#_080-jvm内存优化" class="header-anchor">#</a> 080  jvm内存优化</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>
堆(Heap)和非堆(Non-heap)内存
    按照官方的说法：“Java 虚拟机具有一个堆，堆是运行时数据区域，所有类实例和数组的内存均从此处分配。堆是在 Java 虚拟机启动时创建的。”“在JVM中堆之外的内存称为非堆内存(Non-heap memory)”。可以看出JVM主要管理两种类型的内存：堆和非堆。简单来说堆就是Java代码可及的内存，是留给开发人员使用的；非堆就是JVM留给 自己用的，所以方法区、JVM内部处理或优化所需的内存(如JIT编译后的代码缓存)、每个类结构(如运行时常数池、字段和方法数据)以及方法和构造方法 的代码都在非堆内存中。
堆内存分配
    JVM初始分配的内存由-Xms指定，默认是物理内存的1/64；JVM最大分配的内存由-Xmx指 定，默认是物理内存的1/4。默认空余堆内存小于40%时，JVM就会增大堆直到-Xmx的最大限制；空余堆内存大于70%时，JVM会减少堆直到 -Xms的最小限制。因此服务器一般设置-Xms、-Xmx相等以避免在每次GC 后调整堆的大小。
非堆内存分配
    JVM使用-XX:PermSize设置非堆内存初始值，默认是物理内存的1/64；由XX:MaxPermSize设置最大非堆内存的大小，默认是物理内存的1/4。
JVM内存限制(最大值)
    首先JVM内存限制于实际的最大物理内存(废话！呵呵)，假设物理内存无限大的话，JVM内存的最大值跟操作系统有很大的关系。简单的说就32位处理器虽然 可控内存空间有4GB,但是具体的操作系统会给一个限制，这个限制一般是2GB-3GB（一般来说Windows系统下为1.5G-2G，Linux系统 下为2G-3G），而64bit以上的处理器就不会有限制了。
    
https://blog.csdn.net/cutesource/article/details/5907418
<span class="token comment">## tomcat优化</span>
https://www.cnblogs.com/jojoword/p/10835112.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_081-jar-illegal-key-size"><a href="#_081-jar-illegal-key-size" class="header-anchor">#</a> 081  jar Illegal key size</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>报错描述：java.security.InvalidKeyException: Illegal key size
原因分析：JRE中自带的“local_policy.jar ”和“US_export_policy.jar”是支持128位密钥的加密算法，而当我们要使用256位密钥算法的时候，已经超出它的范围，无法支持

解决方案：1、## https://blog.csdn.net/dling8/article/details/84061948
          2、升级jdk，比如 java version &quot;1.8.0_74&quot; 升级到 java version &quot;1.8.0_261&quot;

参考链接：https://stackoverflow.com/questions/6481627/java-security-illegal-key-size-or-default-parameters

摘要说明：Make sure you use the latest version of JDK/JRE.
In my case, I had put JCE into JRE folder, but it didn't help. It happened because I was running my project from the IDE directly (using JDK).
Then I updated my JDK and JRE to the latest version (1.8.0_211) and the problem had gone.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_082"><a href="#_082" class="header-anchor">#</a> 082</h2> <h2 id="_083"><a href="#_083" class="header-anchor">#</a> 083</h2> <h2 id="_084"><a href="#_084" class="header-anchor">#</a> 084</h2> <h2 id="_085"><a href="#_085" class="header-anchor">#</a> 085</h2> <h2 id="_086"><a href="#_086" class="header-anchor">#</a> 086</h2> <h2 id="_087"><a href="#_087" class="header-anchor">#</a> 087</h2> <h2 id="_088"><a href="#_088" class="header-anchor">#</a> 088</h2> <h2 id="_089"><a href="#_089" class="header-anchor">#</a> 089</h2> <h2 id="_090-阿里云-k8s"><a href="#_090-阿里云-k8s" class="header-anchor">#</a> 090 阿里云 k8s</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>阿里云 k8s

ACK 容器服务Kubernetes版
ASK 

ACR 容器镜像服务（Alibaba Cloud Container Registry）

ECI 弹性容器实例ECI


高可用

自动扩容 缩容
https://help.aliyun.com/learn/tool.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_091"><a href="#_091" class="header-anchor">#</a> 091</h2> <h2 id="_092"><a href="#_092" class="header-anchor">#</a> 092</h2> <h2 id="_093"><a href="#_093" class="header-anchor">#</a> 093</h2> <h2 id="_094"><a href="#_094" class="header-anchor">#</a> 094</h2> <h2 id="_095"><a href="#_095" class="header-anchor">#</a> 095</h2> <h2 id="_096"><a href="#_096" class="header-anchor">#</a> 096</h2> <h2 id="_097-鸡汤几句"><a href="#_097-鸡汤几句" class="header-anchor">#</a> 097 鸡汤几句</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>写计划或者一些鼓励自己的话贴在显示器上时时看到，做一条划掉一条，特别有成就感！

所以作为老板，他最希望的事就是自己能帮助到团队里每个员工，能为员工协调资源，能把控风险，掌控大局，最终把事情做好，这样老板自己也能出成绩得到晋升。

如果你能从个人的能力出发，变成了个人的竞争力，再进一步变成了企业的竞争力，这是一件喜闻乐见的事，也是领导想看到的。

你主动展现出愿意承担更多、学习更多的东西的意愿，老板才会把更多的责任交到你的手里面。

所以主动思考，抓住表达红利，你的想法才会得到组织支持和资源支持，相应的你自己也能够实现升职加薪。

凡事有交代，件件有着落，事事有回音

怎么做一个踏实靠谱的人呢？你应该做到凡事有交代, 件件有着落, 事事有回音

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_097-鸡汤2"><a href="#_097-鸡汤2" class="header-anchor">#</a> 097 鸡汤2</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>“我当时没什么自信”，回忆起来那段经历，他这样说。
既然改变已经发生了，那就尽力做好。没有自信，可以建立自信，没有武功，可以从零学起。

他在“绝情谷底”总结了三条生存法则：
1，不要多想，直接去做，反正也没有时间想别的；
2，不敢演讲，那就多练 ，反正客户等着，不讲也不行；
3，不断提高，那就多学，反正总有建（tiao）议（ti）和反（tu）馈（cao）。
他为自己设立了一个目标，一周演讲两次，这样一年下来就讲了三四十次。时间长了，突然有一天，他发现自己在人前讲话不紧张了。

那时感觉自己是被逼的，不过现在挺感谢逼我的人，当时在不确定的情况下我只想一件事情，那就是把手头的事情做好。做着做着就发现，原来我真的可以做的很好。

自信就这么来了。这个人叫格茸扎西。

作者：ThoughtWorks中国
链接：https://www.zhihu.com/question/48406009/answer/155374291
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_098-几个链接"><a href="#_098-几个链接" class="header-anchor">#</a> 098 几个链接</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## MySQL 三万字精华总结 + 面试100 问</span>
https://www.jianshu.com/p/24e1179ef563

<span class="token comment">## 阿里巴巴为什么能抗住90秒100亿？</span>
https://www.jianshu.com/p/f4a907fe1485

<span class="token comment">## 终于有人把 Docker 讲清楚了，万字详解！</span>
https://www.jianshu.com/p/b650b5521d7d

<span class="token comment">## 当初我要是这么学习Nginx就好了！</span>
https://www.jianshu.com/p/e90050dc89b6

<span class="token comment">## 高并发与高可用知识总结</span>
https://www.cnblogs.com/xuwc/p/9138585.html

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_098-高并发"><a href="#_098-高并发" class="header-anchor">#</a> 098 高并发</h4> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>高并发架构相关概念
https://www.cnblogs.com/-mrl/p/13234927.html

高并发解决方案
https://www.cnblogs.com/cn-sbo/p/10853469.html

java高并发解决方案
https://www.cnblogs.com/alex96/p/12152388.html

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_099-github上有趣的100个python项目"><a href="#_099-github上有趣的100个python项目" class="header-anchor">#</a> 099 Github上有趣的100个python项目</h2> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment">## Github上有趣的100个python项目</span>
https://www.jianshu.com/p/d74659727d26

<span class="token comment">## https://github.com/kennethreitz-archive/records</span>

<span class="token comment">## https://github.com/hangsz/pandas-tutorial</span>

<span class="token comment">## https://github.com/xianhu/LearnPython</span>

<span class="token comment">## https://github.com/danfengcao/binlog2sql</span>

<span class="token comment">## https://github.com/tldr-pages/tldr-python-client</span>

<span class="token comment">## https://github.com/Delgan/loguru</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_100-运维技能0-1-设计落地方案"><a href="#_100-运维技能0-1-设计落地方案" class="header-anchor">#</a> 100 运维技能0-1 设计落地方案</h2> <h4 id="_100-1-linux安全"><a href="#_100-1-linux安全" class="header-anchor">#</a> 100.1 linux安全</h4> <h4 id="_100-2-linux-压测"><a href="#_100-2-linux-压测" class="header-anchor">#</a> 100.2 linux 压测</h4> <h4 id="_100-3-nginx-动态负载均衡"><a href="#_100-3-nginx-动态负载均衡" class="header-anchor">#</a> 100.3 nginx 动态负载均衡</h4> <h4 id="_100-4-k8s"><a href="#_100-4-k8s" class="header-anchor">#</a> 100.4 k8s</h4> <h4 id="_100-5-salt-ssh-实现批量安装salt-minion"><a href="#_100-5-salt-ssh-实现批量安装salt-minion" class="header-anchor">#</a> 100.5 salt-ssh 实现批量安装salt-minion</h4> <h4 id="_100-6-巡检模板"><a href="#_100-6-巡检模板" class="header-anchor">#</a> 100.6 巡检模板</h4> <h4 id="yd-mongo迁移到阿里云"><a href="#yd-mongo迁移到阿里云" class="header-anchor">#</a> yd-mongo迁移到阿里云</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## 几个概念</span>
<span class="token comment"># databases, collection, ducument, index</span>
<span class="token comment"># databases, table,  record, index</span>
https://www.cnblogs.com/clsn/p/8244206.html
https://www.cnblogs.com/shaosks/p/9318209.html

<span class="token comment">## 备份</span>
mongodump -h dbhost -d dbname -o dbdirectory
mongodump -h <span class="token number">192.168</span>.1.18:27017 -d smp_maint_2 -o /opt/backup_data/mongo/momgodump
<span class="token comment">## 恢复</span>
mongorestore -h dbhost -d dbname --dir dbdirectory  <span class="token comment"># xxx.bson的目录名</span>
mongorestore -h <span class="token number">192.168</span>.1.18:27017 -d smp_maint_2_restore --dir /opt/backup_data/mongo/momgodump/test


<span class="token comment">## 其他导入导出</span>
<span class="token comment">#https://www.cnblogs.com/clsn/p/8244206.html</span>
<span class="token comment">### 默认导出了JSON格式的数据</span>
mongoexport -h <span class="token number">10.0</span>.0.152:27017 -uroot -proot --authenticationDatabase admin -d app -c vast -o /home/mongod/backup/vasts.dat

mongoexport -h <span class="token number">10.0</span>.0.152:27017 -uroot -proot --authenticationDatabase admin  -d app -c vast --type<span class="token operator">=</span>csv -f id,name -o /home/mongod/backup/vast_csv.dat

mongoimport -h <span class="token number">10.0</span>.0.152:27017 -uroot -proot --authenticationDatabase admin  -d app -c vast  --drop /home/mongod/backup/vasts.dat

mongoimport -h <span class="token number">10.0</span>.0.152:27017 -uroot -proot --authenticationDatabase admin -d app -c vast --type<span class="token operator">=</span>csv --headerline --file vast_csv.dat

<span class="token comment">## mongoexport/mongoimport与mongodump/mongorestore的对比</span>
mongoexport/mongoimport导入/导出的是JSON格式，而mongodump/mongorestore导入/导出的是BSON格式。
JSON可读性强但体积较大，BSON则是二进制文件，体积小但对人类几乎没有可读性。
在一些mongodb版本之间，BSON格式可能会随版本不同而有所不同，所以不同版本之间用mongodump/mongorestore可能不会成功，具体要看版本之间的兼容性。当无法使用BSON进行跨版本的数据迁移的时候，使用JSON格式即mongoexport/mongoimport是一个可选项。跨版本的mongodump/mongorestore并不推荐，实在要做请先检查文档看两个版本是否兼容（大部分时候是的）。
JSON虽然具有较好的跨版本通用性，但其只保留了数据部分，不保留索引，账户等其他基础信息。使用时应该注意。
<span class="token comment">## 授权</span>

<span class="token comment">## 分片</span>
https://blog.csdn.net/tanga842428/article/details/52584770?locationNum<span class="token operator">=</span><span class="token number">9</span><span class="token operator">&amp;</span><span class="token assign-left variable">fps</span><span class="token operator">=</span><span class="token number">1</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="yd-mysql迁移到阿里云"><a href="#yd-mysql迁移到阿里云" class="header-anchor">#</a> yd-MySQL迁移到阿里云</h4> <h4 id="yd-传统java应用上阿里k8s"><a href="#yd-传统java应用上阿里k8s" class="header-anchor">#</a> yd-传统java应用上阿里k8s</h4> <h4 id="yd-阿里云监控"><a href="#yd-阿里云监控" class="header-anchor">#</a> yd-阿里云监控</h4></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">12/5/2020, 5:16:46 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.44e953ca.js" defer></script><script src="/assets/js/2.ca34a8c3.js" defer></script><script src="/assets/js/73.970101e7.js" defer></script>
  </body>
</html>
